{"ast":null,"code":"/*\n *  Copyright (c) 2017 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n\n/* eslint-env node */\n'use strict';\n\nvar SDPUtils = require('sdp');\n\nfunction writeMediaSection(transceiver, caps, type, stream, dtlsRole) {\n  var sdp = SDPUtils.writeRtpDescription(transceiver.kind, caps); // Map ICE parameters (ufrag, pwd) to SDP.\n\n  sdp += SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters()); // Map DTLS parameters to SDP.\n\n  sdp += SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(), type === 'offer' ? 'actpass' : dtlsRole || 'active');\n  sdp += 'a=mid:' + transceiver.mid + '\\r\\n';\n\n  if (transceiver.rtpSender && transceiver.rtpReceiver) {\n    sdp += 'a=sendrecv\\r\\n';\n  } else if (transceiver.rtpSender) {\n    sdp += 'a=sendonly\\r\\n';\n  } else if (transceiver.rtpReceiver) {\n    sdp += 'a=recvonly\\r\\n';\n  } else {\n    sdp += 'a=inactive\\r\\n';\n  }\n\n  if (transceiver.rtpSender) {\n    var trackId = transceiver.rtpSender._initialTrackId || transceiver.rtpSender.track.id;\n    transceiver.rtpSender._initialTrackId = trackId; // spec.\n\n    var msid = 'msid:' + (stream ? stream.id : '-') + ' ' + trackId + '\\r\\n';\n    sdp += 'a=' + msid; // for Chrome. Legacy should no longer be required.\n\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc + ' ' + msid; // RTX\n\n    if (transceiver.sendEncodingParameters[0].rtx) {\n      sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc + ' ' + msid;\n      sdp += 'a=ssrc-group:FID ' + transceiver.sendEncodingParameters[0].ssrc + ' ' + transceiver.sendEncodingParameters[0].rtx.ssrc + '\\r\\n';\n    }\n  } // FIXME: this should be written by writeRtpDescription.\n\n\n  sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc + ' cname:' + SDPUtils.localCName + '\\r\\n';\n\n  if (transceiver.rtpSender && transceiver.sendEncodingParameters[0].rtx) {\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc + ' cname:' + SDPUtils.localCName + '\\r\\n';\n  }\n\n  return sdp;\n} // Edge does not like\n// 1) stun: filtered after 14393 unless ?transport=udp is present\n// 2) turn: that does not have all of turn:host:port?transport=udp\n// 3) turn: with ipv6 addresses\n// 4) turn: occurring muliple times\n\n\nfunction filterIceServers(iceServers, edgeVersion) {\n  var hasTurn = false;\n  iceServers = JSON.parse(JSON.stringify(iceServers));\n  return iceServers.filter(function (server) {\n    if (server && (server.urls || server.url)) {\n      var urls = server.urls || server.url;\n\n      if (server.url && !server.urls) {\n        console.warn('RTCIceServer.url is deprecated! Use urls instead.');\n      }\n\n      var isString = typeof urls === 'string';\n\n      if (isString) {\n        urls = [urls];\n      }\n\n      urls = urls.filter(function (url) {\n        var validTurn = url.indexOf('turn:') === 0 && url.indexOf('transport=udp') !== -1 && url.indexOf('turn:[') === -1 && !hasTurn;\n\n        if (validTurn) {\n          hasTurn = true;\n          return true;\n        }\n\n        return url.indexOf('stun:') === 0 && edgeVersion >= 14393 && url.indexOf('?transport=udp') === -1;\n      });\n      delete server.url;\n      server.urls = isString ? urls[0] : urls;\n      return !!urls.length;\n    }\n  });\n} // Determines the intersection of local and remote capabilities.\n\n\nfunction getCommonCapabilities(localCapabilities, remoteCapabilities) {\n  var commonCapabilities = {\n    codecs: [],\n    headerExtensions: [],\n    fecMechanisms: []\n  };\n\n  var findCodecByPayloadType = function (pt, codecs) {\n    pt = parseInt(pt, 10);\n\n    for (var i = 0; i < codecs.length; i++) {\n      if (codecs[i].payloadType === pt || codecs[i].preferredPayloadType === pt) {\n        return codecs[i];\n      }\n    }\n  };\n\n  var rtxCapabilityMatches = function (lRtx, rRtx, lCodecs, rCodecs) {\n    var lCodec = findCodecByPayloadType(lRtx.parameters.apt, lCodecs);\n    var rCodec = findCodecByPayloadType(rRtx.parameters.apt, rCodecs);\n    return lCodec && rCodec && lCodec.name.toLowerCase() === rCodec.name.toLowerCase();\n  };\n\n  localCapabilities.codecs.forEach(function (lCodec) {\n    for (var i = 0; i < remoteCapabilities.codecs.length; i++) {\n      var rCodec = remoteCapabilities.codecs[i];\n\n      if (lCodec.name.toLowerCase() === rCodec.name.toLowerCase() && lCodec.clockRate === rCodec.clockRate) {\n        if (lCodec.name.toLowerCase() === 'rtx' && lCodec.parameters && rCodec.parameters.apt) {\n          // for RTX we need to find the local rtx that has a apt\n          // which points to the same local codec as the remote one.\n          if (!rtxCapabilityMatches(lCodec, rCodec, localCapabilities.codecs, remoteCapabilities.codecs)) {\n            continue;\n          }\n        }\n\n        rCodec = JSON.parse(JSON.stringify(rCodec)); // deepcopy\n        // number of channels is the highest common number of channels\n\n        rCodec.numChannels = Math.min(lCodec.numChannels, rCodec.numChannels); // push rCodec so we reply with offerer payload type\n\n        commonCapabilities.codecs.push(rCodec); // determine common feedback mechanisms\n\n        rCodec.rtcpFeedback = rCodec.rtcpFeedback.filter(function (fb) {\n          for (var j = 0; j < lCodec.rtcpFeedback.length; j++) {\n            if (lCodec.rtcpFeedback[j].type === fb.type && lCodec.rtcpFeedback[j].parameter === fb.parameter) {\n              return true;\n            }\n          }\n\n          return false;\n        }); // FIXME: also need to determine .parameters\n        //  see https://github.com/openpeer/ortc/issues/569\n\n        break;\n      }\n    }\n  });\n  localCapabilities.headerExtensions.forEach(function (lHeaderExtension) {\n    for (var i = 0; i < remoteCapabilities.headerExtensions.length; i++) {\n      var rHeaderExtension = remoteCapabilities.headerExtensions[i];\n\n      if (lHeaderExtension.uri === rHeaderExtension.uri) {\n        commonCapabilities.headerExtensions.push(rHeaderExtension);\n        break;\n      }\n    }\n  }); // FIXME: fecMechanisms\n\n  return commonCapabilities;\n} // is action=setLocalDescription with type allowed in signalingState\n\n\nfunction isActionAllowedInSignalingState(action, type, signalingState) {\n  return {\n    offer: {\n      setLocalDescription: ['stable', 'have-local-offer'],\n      setRemoteDescription: ['stable', 'have-remote-offer']\n    },\n    answer: {\n      setLocalDescription: ['have-remote-offer', 'have-local-pranswer'],\n      setRemoteDescription: ['have-local-offer', 'have-remote-pranswer']\n    }\n  }[type][action].indexOf(signalingState) !== -1;\n}\n\nfunction maybeAddCandidate(iceTransport, candidate) {\n  // Edge's internal representation adds some fields therefore\n  // not all fieldѕ are taken into account.\n  var alreadyAdded = iceTransport.getRemoteCandidates().find(function (remoteCandidate) {\n    return candidate.foundation === remoteCandidate.foundation && candidate.ip === remoteCandidate.ip && candidate.port === remoteCandidate.port && candidate.priority === remoteCandidate.priority && candidate.protocol === remoteCandidate.protocol && candidate.type === remoteCandidate.type;\n  });\n\n  if (!alreadyAdded) {\n    iceTransport.addRemoteCandidate(candidate);\n  }\n\n  return !alreadyAdded;\n}\n\nfunction makeError(name, description) {\n  var e = new Error(description);\n  e.name = name;\n  return e;\n}\n\nmodule.exports = function (window, edgeVersion) {\n  // https://w3c.github.io/mediacapture-main/#mediastream\n  // Helper function to add the track to the stream and\n  // dispatch the event ourselves.\n  function addTrackToStreamAndFireEvent(track, stream) {\n    stream.addTrack(track);\n    stream.dispatchEvent(new window.MediaStreamTrackEvent('addtrack', {\n      track: track\n    }));\n  }\n\n  function removeTrackFromStreamAndFireEvent(track, stream) {\n    stream.removeTrack(track);\n    stream.dispatchEvent(new window.MediaStreamTrackEvent('removetrack', {\n      track: track\n    }));\n  }\n\n  function fireAddTrack(pc, track, receiver, streams) {\n    var trackEvent = new Event('track');\n    trackEvent.track = track;\n    trackEvent.receiver = receiver;\n    trackEvent.transceiver = {\n      receiver: receiver\n    };\n    trackEvent.streams = streams;\n    window.setTimeout(function () {\n      pc._dispatchEvent('track', trackEvent);\n    });\n  }\n\n  var RTCPeerConnection = function (config) {\n    var pc = this;\n\n    var _eventTarget = document.createDocumentFragment();\n\n    ['addEventListener', 'removeEventListener', 'dispatchEvent'].forEach(function (method) {\n      pc[method] = _eventTarget[method].bind(_eventTarget);\n    });\n    this.canTrickleIceCandidates = null;\n    this.needNegotiation = false;\n    this.localStreams = [];\n    this.remoteStreams = [];\n    this.localDescription = null;\n    this.remoteDescription = null;\n    this.signalingState = 'stable';\n    this.iceConnectionState = 'new';\n    this.iceGatheringState = 'new';\n    config = JSON.parse(JSON.stringify(config || {}));\n    this.usingBundle = config.bundlePolicy === 'max-bundle';\n\n    if (config.rtcpMuxPolicy === 'negotiate') {\n      throw makeError('NotSupportedError', 'rtcpMuxPolicy \\'negotiate\\' is not supported');\n    } else if (!config.rtcpMuxPolicy) {\n      config.rtcpMuxPolicy = 'require';\n    }\n\n    switch (config.iceTransportPolicy) {\n      case 'all':\n      case 'relay':\n        break;\n\n      default:\n        config.iceTransportPolicy = 'all';\n        break;\n    }\n\n    switch (config.bundlePolicy) {\n      case 'balanced':\n      case 'max-compat':\n      case 'max-bundle':\n        break;\n\n      default:\n        config.bundlePolicy = 'balanced';\n        break;\n    }\n\n    config.iceServers = filterIceServers(config.iceServers || [], edgeVersion);\n    this._iceGatherers = [];\n\n    if (config.iceCandidatePoolSize) {\n      for (var i = config.iceCandidatePoolSize; i > 0; i--) {\n        this._iceGatherers.push(new window.RTCIceGatherer({\n          iceServers: config.iceServers,\n          gatherPolicy: config.iceTransportPolicy\n        }));\n      }\n    } else {\n      config.iceCandidatePoolSize = 0;\n    }\n\n    this._config = config; // per-track iceGathers, iceTransports, dtlsTransports, rtpSenders, ...\n    // everything that is needed to describe a SDP m-line.\n\n    this.transceivers = [];\n    this._sdpSessionId = SDPUtils.generateSessionId();\n    this._sdpSessionVersion = 0;\n    this._dtlsRole = undefined; // role for a=setup to use in answers.\n\n    this._isClosed = false;\n  }; // set up event handlers on prototype\n\n\n  RTCPeerConnection.prototype.onicecandidate = null;\n  RTCPeerConnection.prototype.onaddstream = null;\n  RTCPeerConnection.prototype.ontrack = null;\n  RTCPeerConnection.prototype.onremovestream = null;\n  RTCPeerConnection.prototype.onsignalingstatechange = null;\n  RTCPeerConnection.prototype.oniceconnectionstatechange = null;\n  RTCPeerConnection.prototype.onicegatheringstatechange = null;\n  RTCPeerConnection.prototype.onnegotiationneeded = null;\n  RTCPeerConnection.prototype.ondatachannel = null;\n\n  RTCPeerConnection.prototype._dispatchEvent = function (name, event) {\n    if (this._isClosed) {\n      return;\n    }\n\n    this.dispatchEvent(event);\n\n    if (typeof this['on' + name] === 'function') {\n      this['on' + name](event);\n    }\n  };\n\n  RTCPeerConnection.prototype._emitGatheringStateChange = function () {\n    var event = new Event('icegatheringstatechange');\n\n    this._dispatchEvent('icegatheringstatechange', event);\n  };\n\n  RTCPeerConnection.prototype.getConfiguration = function () {\n    return this._config;\n  };\n\n  RTCPeerConnection.prototype.getLocalStreams = function () {\n    return this.localStreams;\n  };\n\n  RTCPeerConnection.prototype.getRemoteStreams = function () {\n    return this.remoteStreams;\n  }; // internal helper to create a transceiver object.\n  // (whih is not yet the same as the WebRTC 1.0 transceiver)\n\n\n  RTCPeerConnection.prototype._createTransceiver = function (kind) {\n    var hasBundleTransport = this.transceivers.length > 0;\n    var transceiver = {\n      track: null,\n      iceGatherer: null,\n      iceTransport: null,\n      dtlsTransport: null,\n      localCapabilities: null,\n      remoteCapabilities: null,\n      rtpSender: null,\n      rtpReceiver: null,\n      kind: kind,\n      mid: null,\n      sendEncodingParameters: null,\n      recvEncodingParameters: null,\n      stream: null,\n      associatedRemoteMediaStreams: [],\n      wantReceive: true\n    };\n\n    if (this.usingBundle && hasBundleTransport) {\n      transceiver.iceTransport = this.transceivers[0].iceTransport;\n      transceiver.dtlsTransport = this.transceivers[0].dtlsTransport;\n    } else {\n      var transports = this._createIceAndDtlsTransports();\n\n      transceiver.iceTransport = transports.iceTransport;\n      transceiver.dtlsTransport = transports.dtlsTransport;\n    }\n\n    this.transceivers.push(transceiver);\n    return transceiver;\n  };\n\n  RTCPeerConnection.prototype.addTrack = function (track, stream) {\n    if (this._isClosed) {\n      throw makeError('InvalidStateError', 'Attempted to call addTrack on a closed peerconnection.');\n    }\n\n    var alreadyExists = this.transceivers.find(function (s) {\n      return s.track === track;\n    });\n\n    if (alreadyExists) {\n      throw makeError('InvalidAccessError', 'Track already exists.');\n    }\n\n    var transceiver;\n\n    for (var i = 0; i < this.transceivers.length; i++) {\n      if (!this.transceivers[i].track && this.transceivers[i].kind === track.kind) {\n        transceiver = this.transceivers[i];\n      }\n    }\n\n    if (!transceiver) {\n      transceiver = this._createTransceiver(track.kind);\n    }\n\n    this._maybeFireNegotiationNeeded();\n\n    if (this.localStreams.indexOf(stream) === -1) {\n      this.localStreams.push(stream);\n    }\n\n    transceiver.track = track;\n    transceiver.stream = stream;\n    transceiver.rtpSender = new window.RTCRtpSender(track, transceiver.dtlsTransport);\n    return transceiver.rtpSender;\n  };\n\n  RTCPeerConnection.prototype.addStream = function (stream) {\n    var pc = this;\n\n    if (edgeVersion >= 15025) {\n      stream.getTracks().forEach(function (track) {\n        pc.addTrack(track, stream);\n      });\n    } else {\n      // Clone is necessary for local demos mostly, attaching directly\n      // to two different senders does not work (build 10547).\n      // Fixed in 15025 (or earlier)\n      var clonedStream = stream.clone();\n      stream.getTracks().forEach(function (track, idx) {\n        var clonedTrack = clonedStream.getTracks()[idx];\n        track.addEventListener('enabled', function (event) {\n          clonedTrack.enabled = event.enabled;\n        });\n      });\n      clonedStream.getTracks().forEach(function (track) {\n        pc.addTrack(track, clonedStream);\n      });\n    }\n  };\n\n  RTCPeerConnection.prototype.removeTrack = function (sender) {\n    if (this._isClosed) {\n      throw makeError('InvalidStateError', 'Attempted to call removeTrack on a closed peerconnection.');\n    }\n\n    if (!(sender instanceof window.RTCRtpSender)) {\n      throw new TypeError('Argument 1 of RTCPeerConnection.removeTrack ' + 'does not implement interface RTCRtpSender.');\n    }\n\n    var transceiver = this.transceivers.find(function (t) {\n      return t.rtpSender === sender;\n    });\n\n    if (!transceiver) {\n      throw makeError('InvalidAccessError', 'Sender was not created by this connection.');\n    }\n\n    var stream = transceiver.stream;\n    transceiver.rtpSender.stop();\n    transceiver.rtpSender = null;\n    transceiver.track = null;\n    transceiver.stream = null; // remove the stream from the set of local streams\n\n    var localStreams = this.transceivers.map(function (t) {\n      return t.stream;\n    });\n\n    if (localStreams.indexOf(stream) === -1 && this.localStreams.indexOf(stream) > -1) {\n      this.localStreams.splice(this.localStreams.indexOf(stream), 1);\n    }\n\n    this._maybeFireNegotiationNeeded();\n  };\n\n  RTCPeerConnection.prototype.removeStream = function (stream) {\n    var pc = this;\n    stream.getTracks().forEach(function (track) {\n      var sender = pc.getSenders().find(function (s) {\n        return s.track === track;\n      });\n\n      if (sender) {\n        pc.removeTrack(sender);\n      }\n    });\n  };\n\n  RTCPeerConnection.prototype.getSenders = function () {\n    return this.transceivers.filter(function (transceiver) {\n      return !!transceiver.rtpSender;\n    }).map(function (transceiver) {\n      return transceiver.rtpSender;\n    });\n  };\n\n  RTCPeerConnection.prototype.getReceivers = function () {\n    return this.transceivers.filter(function (transceiver) {\n      return !!transceiver.rtpReceiver;\n    }).map(function (transceiver) {\n      return transceiver.rtpReceiver;\n    });\n  };\n\n  RTCPeerConnection.prototype._createIceGatherer = function (sdpMLineIndex, usingBundle) {\n    var pc = this;\n\n    if (usingBundle && sdpMLineIndex > 0) {\n      return this.transceivers[0].iceGatherer;\n    } else if (this._iceGatherers.length) {\n      return this._iceGatherers.shift();\n    }\n\n    var iceGatherer = new window.RTCIceGatherer({\n      iceServers: this._config.iceServers,\n      gatherPolicy: this._config.iceTransportPolicy\n    });\n    Object.defineProperty(iceGatherer, 'state', {\n      value: 'new',\n      writable: true\n    });\n    this.transceivers[sdpMLineIndex].bufferedCandidateEvents = [];\n\n    this.transceivers[sdpMLineIndex].bufferCandidates = function (event) {\n      var end = !event.candidate || Object.keys(event.candidate).length === 0; // polyfill since RTCIceGatherer.state is not implemented in\n      // Edge 10547 yet.\n\n      iceGatherer.state = end ? 'completed' : 'gathering';\n\n      if (pc.transceivers[sdpMLineIndex].bufferedCandidateEvents !== null) {\n        pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event);\n      }\n    };\n\n    iceGatherer.addEventListener('localcandidate', this.transceivers[sdpMLineIndex].bufferCandidates);\n    return iceGatherer;\n  }; // start gathering from an RTCIceGatherer.\n\n\n  RTCPeerConnection.prototype._gather = function (mid, sdpMLineIndex) {\n    var pc = this;\n    var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;\n\n    if (iceGatherer.onlocalcandidate) {\n      return;\n    }\n\n    var bufferedCandidateEvents = this.transceivers[sdpMLineIndex].bufferedCandidateEvents;\n    this.transceivers[sdpMLineIndex].bufferedCandidateEvents = null;\n    iceGatherer.removeEventListener('localcandidate', this.transceivers[sdpMLineIndex].bufferCandidates);\n\n    iceGatherer.onlocalcandidate = function (evt) {\n      if (pc.usingBundle && sdpMLineIndex > 0) {\n        // if we know that we use bundle we can drop candidates with\n        // ѕdpMLineIndex > 0. If we don't do this then our state gets\n        // confused since we dispose the extra ice gatherer.\n        return;\n      }\n\n      var event = new Event('icecandidate');\n      event.candidate = {\n        sdpMid: mid,\n        sdpMLineIndex: sdpMLineIndex\n      };\n      var cand = evt.candidate; // Edge emits an empty object for RTCIceCandidateComplete‥\n\n      var end = !cand || Object.keys(cand).length === 0;\n\n      if (end) {\n        // polyfill since RTCIceGatherer.state is not implemented in\n        // Edge 10547 yet.\n        if (iceGatherer.state === 'new' || iceGatherer.state === 'gathering') {\n          iceGatherer.state = 'completed';\n        }\n      } else {\n        if (iceGatherer.state === 'new') {\n          iceGatherer.state = 'gathering';\n        } // RTCIceCandidate doesn't have a component, needs to be added\n\n\n        cand.component = 1;\n        var serializedCandidate = SDPUtils.writeCandidate(cand);\n        event.candidate = Object.assign(event.candidate, SDPUtils.parseCandidate(serializedCandidate));\n        event.candidate.candidate = serializedCandidate;\n      } // update local description.\n\n\n      var sections = SDPUtils.getMediaSections(pc.localDescription.sdp);\n\n      if (!end) {\n        sections[event.candidate.sdpMLineIndex] += 'a=' + event.candidate.candidate + '\\r\\n';\n      } else {\n        sections[event.candidate.sdpMLineIndex] += 'a=end-of-candidates\\r\\n';\n      }\n\n      pc.localDescription.sdp = SDPUtils.getDescription(pc.localDescription.sdp) + sections.join('');\n      var complete = pc.transceivers.every(function (transceiver) {\n        return transceiver.iceGatherer && transceiver.iceGatherer.state === 'completed';\n      });\n\n      if (pc.iceGatheringState !== 'gathering') {\n        pc.iceGatheringState = 'gathering';\n\n        pc._emitGatheringStateChange();\n      } // Emit candidate. Also emit null candidate when all gatherers are\n      // complete.\n\n\n      if (!end) {\n        pc._dispatchEvent('icecandidate', event);\n      }\n\n      if (complete) {\n        pc._dispatchEvent('icecandidate', new Event('icecandidate'));\n\n        pc.iceGatheringState = 'complete';\n\n        pc._emitGatheringStateChange();\n      }\n    }; // emit already gathered candidates.\n\n\n    window.setTimeout(function () {\n      bufferedCandidateEvents.forEach(function (e) {\n        iceGatherer.onlocalcandidate(e);\n      });\n    }, 0);\n  }; // Create ICE transport and DTLS transport.\n\n\n  RTCPeerConnection.prototype._createIceAndDtlsTransports = function () {\n    var pc = this;\n    var iceTransport = new window.RTCIceTransport(null);\n\n    iceTransport.onicestatechange = function () {\n      pc._updateConnectionState();\n    };\n\n    var dtlsTransport = new window.RTCDtlsTransport(iceTransport);\n\n    dtlsTransport.ondtlsstatechange = function () {\n      pc._updateConnectionState();\n    };\n\n    dtlsTransport.onerror = function () {\n      // onerror does not set state to failed by itself.\n      Object.defineProperty(dtlsTransport, 'state', {\n        value: 'failed',\n        writable: true\n      });\n\n      pc._updateConnectionState();\n    };\n\n    return {\n      iceTransport: iceTransport,\n      dtlsTransport: dtlsTransport\n    };\n  }; // Destroy ICE gatherer, ICE transport and DTLS transport.\n  // Without triggering the callbacks.\n\n\n  RTCPeerConnection.prototype._disposeIceAndDtlsTransports = function (sdpMLineIndex) {\n    var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;\n\n    if (iceGatherer) {\n      delete iceGatherer.onlocalcandidate;\n      delete this.transceivers[sdpMLineIndex].iceGatherer;\n    }\n\n    var iceTransport = this.transceivers[sdpMLineIndex].iceTransport;\n\n    if (iceTransport) {\n      delete iceTransport.onicestatechange;\n      delete this.transceivers[sdpMLineIndex].iceTransport;\n    }\n\n    var dtlsTransport = this.transceivers[sdpMLineIndex].dtlsTransport;\n\n    if (dtlsTransport) {\n      delete dtlsTransport.ondtlsstatechange;\n      delete dtlsTransport.onerror;\n      delete this.transceivers[sdpMLineIndex].dtlsTransport;\n    }\n  }; // Start the RTP Sender and Receiver for a transceiver.\n\n\n  RTCPeerConnection.prototype._transceive = function (transceiver, send, recv) {\n    var params = getCommonCapabilities(transceiver.localCapabilities, transceiver.remoteCapabilities);\n\n    if (send && transceiver.rtpSender) {\n      params.encodings = transceiver.sendEncodingParameters;\n      params.rtcp = {\n        cname: SDPUtils.localCName,\n        compound: transceiver.rtcpParameters.compound\n      };\n\n      if (transceiver.recvEncodingParameters.length) {\n        params.rtcp.ssrc = transceiver.recvEncodingParameters[0].ssrc;\n      }\n\n      transceiver.rtpSender.send(params);\n    }\n\n    if (recv && transceiver.rtpReceiver && params.codecs.length > 0) {\n      // remove RTX field in Edge 14942\n      if (transceiver.kind === 'video' && transceiver.recvEncodingParameters && edgeVersion < 15019) {\n        transceiver.recvEncodingParameters.forEach(function (p) {\n          delete p.rtx;\n        });\n      }\n\n      if (transceiver.recvEncodingParameters.length) {\n        params.encodings = transceiver.recvEncodingParameters;\n      } else {\n        params.encodings = [{}];\n      }\n\n      params.rtcp = {\n        compound: transceiver.rtcpParameters.compound\n      };\n\n      if (transceiver.rtcpParameters.cname) {\n        params.rtcp.cname = transceiver.rtcpParameters.cname;\n      }\n\n      if (transceiver.sendEncodingParameters.length) {\n        params.rtcp.ssrc = transceiver.sendEncodingParameters[0].ssrc;\n      }\n\n      transceiver.rtpReceiver.receive(params);\n    }\n  };\n\n  RTCPeerConnection.prototype.setLocalDescription = function (description) {\n    var pc = this; // Note: pranswer is not supported.\n\n    if (['offer', 'answer'].indexOf(description.type) === -1) {\n      return Promise.reject(makeError('TypeError', 'Unsupported type \"' + description.type + '\"'));\n    }\n\n    if (!isActionAllowedInSignalingState('setLocalDescription', description.type, pc.signalingState) || pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError', 'Can not set local ' + description.type + ' in state ' + pc.signalingState));\n    }\n\n    var sections;\n    var sessionpart;\n\n    if (description.type === 'offer') {\n      // VERY limited support for SDP munging. Limited to:\n      // * changing the order of codecs\n      sections = SDPUtils.splitSections(description.sdp);\n      sessionpart = sections.shift();\n      sections.forEach(function (mediaSection, sdpMLineIndex) {\n        var caps = SDPUtils.parseRtpParameters(mediaSection);\n        pc.transceivers[sdpMLineIndex].localCapabilities = caps;\n      });\n      pc.transceivers.forEach(function (transceiver, sdpMLineIndex) {\n        pc._gather(transceiver.mid, sdpMLineIndex);\n      });\n    } else if (description.type === 'answer') {\n      sections = SDPUtils.splitSections(pc.remoteDescription.sdp);\n      sessionpart = sections.shift();\n      var isIceLite = SDPUtils.matchPrefix(sessionpart, 'a=ice-lite').length > 0;\n      sections.forEach(function (mediaSection, sdpMLineIndex) {\n        var transceiver = pc.transceivers[sdpMLineIndex];\n        var iceGatherer = transceiver.iceGatherer;\n        var iceTransport = transceiver.iceTransport;\n        var dtlsTransport = transceiver.dtlsTransport;\n        var localCapabilities = transceiver.localCapabilities;\n        var remoteCapabilities = transceiver.remoteCapabilities; // treat bundle-only as not-rejected.\n\n        var rejected = SDPUtils.isRejected(mediaSection) && SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;\n\n        if (!rejected && !transceiver.isDatachannel) {\n          var remoteIceParameters = SDPUtils.getIceParameters(mediaSection, sessionpart);\n          var remoteDtlsParameters = SDPUtils.getDtlsParameters(mediaSection, sessionpart);\n\n          if (isIceLite) {\n            remoteDtlsParameters.role = 'server';\n          }\n\n          if (!pc.usingBundle || sdpMLineIndex === 0) {\n            pc._gather(transceiver.mid, sdpMLineIndex);\n\n            if (iceTransport.state === 'new') {\n              iceTransport.start(iceGatherer, remoteIceParameters, isIceLite ? 'controlling' : 'controlled');\n            }\n\n            if (dtlsTransport.state === 'new') {\n              dtlsTransport.start(remoteDtlsParameters);\n            }\n          } // Calculate intersection of capabilities.\n\n\n          var params = getCommonCapabilities(localCapabilities, remoteCapabilities); // Start the RTCRtpSender. The RTCRtpReceiver for this\n          // transceiver has already been started in setRemoteDescription.\n\n          pc._transceive(transceiver, params.codecs.length > 0, false);\n        }\n      });\n    }\n\n    pc.localDescription = {\n      type: description.type,\n      sdp: description.sdp\n    };\n\n    if (description.type === 'offer') {\n      pc._updateSignalingState('have-local-offer');\n    } else {\n      pc._updateSignalingState('stable');\n    }\n\n    return Promise.resolve();\n  };\n\n  RTCPeerConnection.prototype.setRemoteDescription = function (description) {\n    var pc = this; // Note: pranswer is not supported.\n\n    if (['offer', 'answer'].indexOf(description.type) === -1) {\n      return Promise.reject(makeError('TypeError', 'Unsupported type \"' + description.type + '\"'));\n    }\n\n    if (!isActionAllowedInSignalingState('setRemoteDescription', description.type, pc.signalingState) || pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError', 'Can not set remote ' + description.type + ' in state ' + pc.signalingState));\n    }\n\n    var streams = {};\n    pc.remoteStreams.forEach(function (stream) {\n      streams[stream.id] = stream;\n    });\n    var receiverList = [];\n    var sections = SDPUtils.splitSections(description.sdp);\n    var sessionpart = sections.shift();\n    var isIceLite = SDPUtils.matchPrefix(sessionpart, 'a=ice-lite').length > 0;\n    var usingBundle = SDPUtils.matchPrefix(sessionpart, 'a=group:BUNDLE ').length > 0;\n    pc.usingBundle = usingBundle;\n    var iceOptions = SDPUtils.matchPrefix(sessionpart, 'a=ice-options:')[0];\n\n    if (iceOptions) {\n      pc.canTrickleIceCandidates = iceOptions.substr(14).split(' ').indexOf('trickle') >= 0;\n    } else {\n      pc.canTrickleIceCandidates = false;\n    }\n\n    sections.forEach(function (mediaSection, sdpMLineIndex) {\n      var lines = SDPUtils.splitLines(mediaSection);\n      var kind = SDPUtils.getKind(mediaSection); // treat bundle-only as not-rejected.\n\n      var rejected = SDPUtils.isRejected(mediaSection) && SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;\n      var protocol = lines[0].substr(2).split(' ')[2];\n      var direction = SDPUtils.getDirection(mediaSection, sessionpart);\n      var remoteMsid = SDPUtils.parseMsid(mediaSection);\n      var mid = SDPUtils.getMid(mediaSection) || SDPUtils.generateIdentifier(); // Reject datachannels which are not implemented yet.\n\n      if (kind === 'application' && protocol === 'DTLS/SCTP') {\n        pc.transceivers[sdpMLineIndex] = {\n          mid: mid,\n          isDatachannel: true\n        };\n        return;\n      }\n\n      var transceiver;\n      var iceGatherer;\n      var iceTransport;\n      var dtlsTransport;\n      var rtpReceiver;\n      var sendEncodingParameters;\n      var recvEncodingParameters;\n      var localCapabilities;\n      var track; // FIXME: ensure the mediaSection has rtcp-mux set.\n\n      var remoteCapabilities = SDPUtils.parseRtpParameters(mediaSection);\n      var remoteIceParameters;\n      var remoteDtlsParameters;\n\n      if (!rejected) {\n        remoteIceParameters = SDPUtils.getIceParameters(mediaSection, sessionpart);\n        remoteDtlsParameters = SDPUtils.getDtlsParameters(mediaSection, sessionpart);\n        remoteDtlsParameters.role = 'client';\n      }\n\n      recvEncodingParameters = SDPUtils.parseRtpEncodingParameters(mediaSection);\n      var rtcpParameters = SDPUtils.parseRtcpParameters(mediaSection);\n      var isComplete = SDPUtils.matchPrefix(mediaSection, 'a=end-of-candidates', sessionpart).length > 0;\n      var cands = SDPUtils.matchPrefix(mediaSection, 'a=candidate:').map(function (cand) {\n        return SDPUtils.parseCandidate(cand);\n      }).filter(function (cand) {\n        return cand.component === 1;\n      }); // Check if we can use BUNDLE and dispose transports.\n\n      if ((description.type === 'offer' || description.type === 'answer') && !rejected && usingBundle && sdpMLineIndex > 0 && pc.transceivers[sdpMLineIndex]) {\n        pc._disposeIceAndDtlsTransports(sdpMLineIndex);\n\n        pc.transceivers[sdpMLineIndex].iceGatherer = pc.transceivers[0].iceGatherer;\n        pc.transceivers[sdpMLineIndex].iceTransport = pc.transceivers[0].iceTransport;\n        pc.transceivers[sdpMLineIndex].dtlsTransport = pc.transceivers[0].dtlsTransport;\n\n        if (pc.transceivers[sdpMLineIndex].rtpSender) {\n          pc.transceivers[sdpMLineIndex].rtpSender.setTransport(pc.transceivers[0].dtlsTransport);\n        }\n\n        if (pc.transceivers[sdpMLineIndex].rtpReceiver) {\n          pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(pc.transceivers[0].dtlsTransport);\n        }\n      }\n\n      if (description.type === 'offer' && !rejected) {\n        transceiver = pc.transceivers[sdpMLineIndex] || pc._createTransceiver(kind);\n        transceiver.mid = mid;\n\n        if (!transceiver.iceGatherer) {\n          transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex, usingBundle);\n        }\n\n        if (cands.length && transceiver.iceTransport.state === 'new') {\n          if (isComplete && (!usingBundle || sdpMLineIndex === 0)) {\n            transceiver.iceTransport.setRemoteCandidates(cands);\n          } else {\n            cands.forEach(function (candidate) {\n              maybeAddCandidate(transceiver.iceTransport, candidate);\n            });\n          }\n        }\n\n        localCapabilities = window.RTCRtpReceiver.getCapabilities(kind); // filter RTX until additional stuff needed for RTX is implemented\n        // in adapter.js\n\n        if (edgeVersion < 15019) {\n          localCapabilities.codecs = localCapabilities.codecs.filter(function (codec) {\n            return codec.name !== 'rtx';\n          });\n        }\n\n        sendEncodingParameters = transceiver.sendEncodingParameters || [{\n          ssrc: (2 * sdpMLineIndex + 2) * 1001\n        }]; // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams\n\n        var isNewTrack = false;\n\n        if (direction === 'sendrecv' || direction === 'sendonly') {\n          isNewTrack = !transceiver.rtpReceiver;\n          rtpReceiver = transceiver.rtpReceiver || new window.RTCRtpReceiver(transceiver.dtlsTransport, kind);\n\n          if (isNewTrack) {\n            var stream;\n            track = rtpReceiver.track; // FIXME: does not work with Plan B.\n\n            if (remoteMsid && remoteMsid.stream === '-') {// no-op. a stream id of '-' means: no associated stream.\n            } else if (remoteMsid) {\n              if (!streams[remoteMsid.stream]) {\n                streams[remoteMsid.stream] = new window.MediaStream();\n                Object.defineProperty(streams[remoteMsid.stream], 'id', {\n                  get: function () {\n                    return remoteMsid.stream;\n                  }\n                });\n              }\n\n              Object.defineProperty(track, 'id', {\n                get: function () {\n                  return remoteMsid.track;\n                }\n              });\n              stream = streams[remoteMsid.stream];\n            } else {\n              if (!streams.default) {\n                streams.default = new window.MediaStream();\n              }\n\n              stream = streams.default;\n            }\n\n            if (stream) {\n              addTrackToStreamAndFireEvent(track, stream);\n              transceiver.associatedRemoteMediaStreams.push(stream);\n            }\n\n            receiverList.push([track, rtpReceiver, stream]);\n          }\n        } else if (transceiver.rtpReceiver && transceiver.rtpReceiver.track) {\n          transceiver.associatedRemoteMediaStreams.forEach(function (s) {\n            var nativeTrack = s.getTracks().find(function (t) {\n              return t.id === transceiver.rtpReceiver.track.id;\n            });\n\n            if (nativeTrack) {\n              removeTrackFromStreamAndFireEvent(nativeTrack, s);\n            }\n          });\n          transceiver.associatedRemoteMediaStreams = [];\n        }\n\n        transceiver.localCapabilities = localCapabilities;\n        transceiver.remoteCapabilities = remoteCapabilities;\n        transceiver.rtpReceiver = rtpReceiver;\n        transceiver.rtcpParameters = rtcpParameters;\n        transceiver.sendEncodingParameters = sendEncodingParameters;\n        transceiver.recvEncodingParameters = recvEncodingParameters; // Start the RTCRtpReceiver now. The RTPSender is started in\n        // setLocalDescription.\n\n        pc._transceive(pc.transceivers[sdpMLineIndex], false, isNewTrack);\n      } else if (description.type === 'answer' && !rejected) {\n        transceiver = pc.transceivers[sdpMLineIndex];\n        iceGatherer = transceiver.iceGatherer;\n        iceTransport = transceiver.iceTransport;\n        dtlsTransport = transceiver.dtlsTransport;\n        rtpReceiver = transceiver.rtpReceiver;\n        sendEncodingParameters = transceiver.sendEncodingParameters;\n        localCapabilities = transceiver.localCapabilities;\n        pc.transceivers[sdpMLineIndex].recvEncodingParameters = recvEncodingParameters;\n        pc.transceivers[sdpMLineIndex].remoteCapabilities = remoteCapabilities;\n        pc.transceivers[sdpMLineIndex].rtcpParameters = rtcpParameters;\n\n        if (cands.length && iceTransport.state === 'new') {\n          if ((isIceLite || isComplete) && (!usingBundle || sdpMLineIndex === 0)) {\n            iceTransport.setRemoteCandidates(cands);\n          } else {\n            cands.forEach(function (candidate) {\n              maybeAddCandidate(transceiver.iceTransport, candidate);\n            });\n          }\n        }\n\n        if (!usingBundle || sdpMLineIndex === 0) {\n          if (iceTransport.state === 'new') {\n            iceTransport.start(iceGatherer, remoteIceParameters, 'controlling');\n          }\n\n          if (dtlsTransport.state === 'new') {\n            dtlsTransport.start(remoteDtlsParameters);\n          }\n        }\n\n        pc._transceive(transceiver, direction === 'sendrecv' || direction === 'recvonly', direction === 'sendrecv' || direction === 'sendonly'); // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams\n\n\n        if (rtpReceiver && (direction === 'sendrecv' || direction === 'sendonly')) {\n          track = rtpReceiver.track;\n\n          if (remoteMsid) {\n            if (!streams[remoteMsid.stream]) {\n              streams[remoteMsid.stream] = new window.MediaStream();\n            }\n\n            addTrackToStreamAndFireEvent(track, streams[remoteMsid.stream]);\n            receiverList.push([track, rtpReceiver, streams[remoteMsid.stream]]);\n          } else {\n            if (!streams.default) {\n              streams.default = new window.MediaStream();\n            }\n\n            addTrackToStreamAndFireEvent(track, streams.default);\n            receiverList.push([track, rtpReceiver, streams.default]);\n          }\n        } else {\n          // FIXME: actually the receiver should be created later.\n          delete transceiver.rtpReceiver;\n        }\n      }\n    });\n\n    if (pc._dtlsRole === undefined) {\n      pc._dtlsRole = description.type === 'offer' ? 'active' : 'passive';\n    }\n\n    pc.remoteDescription = {\n      type: description.type,\n      sdp: description.sdp\n    };\n\n    if (description.type === 'offer') {\n      pc._updateSignalingState('have-remote-offer');\n    } else {\n      pc._updateSignalingState('stable');\n    }\n\n    Object.keys(streams).forEach(function (sid) {\n      var stream = streams[sid];\n\n      if (stream.getTracks().length) {\n        if (pc.remoteStreams.indexOf(stream) === -1) {\n          pc.remoteStreams.push(stream);\n          var event = new Event('addstream');\n          event.stream = stream;\n          window.setTimeout(function () {\n            pc._dispatchEvent('addstream', event);\n          });\n        }\n\n        receiverList.forEach(function (item) {\n          var track = item[0];\n          var receiver = item[1];\n\n          if (stream.id !== item[2].id) {\n            return;\n          }\n\n          fireAddTrack(pc, track, receiver, [stream]);\n        });\n      }\n    });\n    receiverList.forEach(function (item) {\n      if (item[2]) {\n        return;\n      }\n\n      fireAddTrack(pc, item[0], item[1], []);\n    }); // check whether addIceCandidate({}) was called within four seconds after\n    // setRemoteDescription.\n\n    window.setTimeout(function () {\n      if (!(pc && pc.transceivers)) {\n        return;\n      }\n\n      pc.transceivers.forEach(function (transceiver) {\n        if (transceiver.iceTransport && transceiver.iceTransport.state === 'new' && transceiver.iceTransport.getRemoteCandidates().length > 0) {\n          console.warn('Timeout for addRemoteCandidate. Consider sending ' + 'an end-of-candidates notification');\n          transceiver.iceTransport.addRemoteCandidate({});\n        }\n      });\n    }, 4000);\n    return Promise.resolve();\n  };\n\n  RTCPeerConnection.prototype.close = function () {\n    this.transceivers.forEach(function (transceiver) {\n      /* not yet\n      if (transceiver.iceGatherer) {\n        transceiver.iceGatherer.close();\n      }\n      */\n      if (transceiver.iceTransport) {\n        transceiver.iceTransport.stop();\n      }\n\n      if (transceiver.dtlsTransport) {\n        transceiver.dtlsTransport.stop();\n      }\n\n      if (transceiver.rtpSender) {\n        transceiver.rtpSender.stop();\n      }\n\n      if (transceiver.rtpReceiver) {\n        transceiver.rtpReceiver.stop();\n      }\n    }); // FIXME: clean up tracks, local streams, remote streams, etc\n\n    this._isClosed = true;\n\n    this._updateSignalingState('closed');\n  }; // Update the signaling state.\n\n\n  RTCPeerConnection.prototype._updateSignalingState = function (newState) {\n    this.signalingState = newState;\n    var event = new Event('signalingstatechange');\n\n    this._dispatchEvent('signalingstatechange', event);\n  }; // Determine whether to fire the negotiationneeded event.\n\n\n  RTCPeerConnection.prototype._maybeFireNegotiationNeeded = function () {\n    var pc = this;\n\n    if (this.signalingState !== 'stable' || this.needNegotiation === true) {\n      return;\n    }\n\n    this.needNegotiation = true;\n    window.setTimeout(function () {\n      if (pc.needNegotiation) {\n        pc.needNegotiation = false;\n        var event = new Event('negotiationneeded');\n\n        pc._dispatchEvent('negotiationneeded', event);\n      }\n    }, 0);\n  }; // Update the connection state.\n\n\n  RTCPeerConnection.prototype._updateConnectionState = function () {\n    var newState;\n    var states = {\n      'new': 0,\n      closed: 0,\n      connecting: 0,\n      checking: 0,\n      connected: 0,\n      completed: 0,\n      disconnected: 0,\n      failed: 0\n    };\n    this.transceivers.forEach(function (transceiver) {\n      states[transceiver.iceTransport.state]++;\n      states[transceiver.dtlsTransport.state]++;\n    }); // ICETransport.completed and connected are the same for this purpose.\n\n    states.connected += states.completed;\n    newState = 'new';\n\n    if (states.failed > 0) {\n      newState = 'failed';\n    } else if (states.connecting > 0 || states.checking > 0) {\n      newState = 'connecting';\n    } else if (states.disconnected > 0) {\n      newState = 'disconnected';\n    } else if (states.new > 0) {\n      newState = 'new';\n    } else if (states.connected > 0 || states.completed > 0) {\n      newState = 'connected';\n    }\n\n    if (newState !== this.iceConnectionState) {\n      this.iceConnectionState = newState;\n      var event = new Event('iceconnectionstatechange');\n\n      this._dispatchEvent('iceconnectionstatechange', event);\n    }\n  };\n\n  RTCPeerConnection.prototype.createOffer = function () {\n    var pc = this;\n\n    if (pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError', 'Can not call createOffer after close'));\n    }\n\n    var numAudioTracks = pc.transceivers.filter(function (t) {\n      return t.kind === 'audio';\n    }).length;\n    var numVideoTracks = pc.transceivers.filter(function (t) {\n      return t.kind === 'video';\n    }).length; // Determine number of audio and video tracks we need to send/recv.\n\n    var offerOptions = arguments[0];\n\n    if (offerOptions) {\n      // Reject Chrome legacy constraints.\n      if (offerOptions.mandatory || offerOptions.optional) {\n        throw new TypeError('Legacy mandatory/optional constraints not supported.');\n      }\n\n      if (offerOptions.offerToReceiveAudio !== undefined) {\n        if (offerOptions.offerToReceiveAudio === true) {\n          numAudioTracks = 1;\n        } else if (offerOptions.offerToReceiveAudio === false) {\n          numAudioTracks = 0;\n        } else {\n          numAudioTracks = offerOptions.offerToReceiveAudio;\n        }\n      }\n\n      if (offerOptions.offerToReceiveVideo !== undefined) {\n        if (offerOptions.offerToReceiveVideo === true) {\n          numVideoTracks = 1;\n        } else if (offerOptions.offerToReceiveVideo === false) {\n          numVideoTracks = 0;\n        } else {\n          numVideoTracks = offerOptions.offerToReceiveVideo;\n        }\n      }\n    }\n\n    pc.transceivers.forEach(function (transceiver) {\n      if (transceiver.kind === 'audio') {\n        numAudioTracks--;\n\n        if (numAudioTracks < 0) {\n          transceiver.wantReceive = false;\n        }\n      } else if (transceiver.kind === 'video') {\n        numVideoTracks--;\n\n        if (numVideoTracks < 0) {\n          transceiver.wantReceive = false;\n        }\n      }\n    }); // Create M-lines for recvonly streams.\n\n    while (numAudioTracks > 0 || numVideoTracks > 0) {\n      if (numAudioTracks > 0) {\n        pc._createTransceiver('audio');\n\n        numAudioTracks--;\n      }\n\n      if (numVideoTracks > 0) {\n        pc._createTransceiver('video');\n\n        numVideoTracks--;\n      }\n    }\n\n    var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId, pc._sdpSessionVersion++);\n    pc.transceivers.forEach(function (transceiver, sdpMLineIndex) {\n      // For each track, create an ice gatherer, ice transport,\n      // dtls transport, potentially rtpsender and rtpreceiver.\n      var track = transceiver.track;\n      var kind = transceiver.kind;\n      var mid = transceiver.mid || SDPUtils.generateIdentifier();\n      transceiver.mid = mid;\n\n      if (!transceiver.iceGatherer) {\n        transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex, pc.usingBundle);\n      }\n\n      var localCapabilities = window.RTCRtpSender.getCapabilities(kind); // filter RTX until additional stuff needed for RTX is implemented\n      // in adapter.js\n\n      if (edgeVersion < 15019) {\n        localCapabilities.codecs = localCapabilities.codecs.filter(function (codec) {\n          return codec.name !== 'rtx';\n        });\n      }\n\n      localCapabilities.codecs.forEach(function (codec) {\n        // work around https://bugs.chromium.org/p/webrtc/issues/detail?id=6552\n        // by adding level-asymmetry-allowed=1\n        if (codec.name === 'H264' && codec.parameters['level-asymmetry-allowed'] === undefined) {\n          codec.parameters['level-asymmetry-allowed'] = '1';\n        } // for subsequent offers, we might have to re-use the payload\n        // type of the last offer.\n\n\n        if (transceiver.remoteCapabilities && transceiver.remoteCapabilities.codecs) {\n          transceiver.remoteCapabilities.codecs.forEach(function (remoteCodec) {\n            if (codec.name.toLowerCase() === remoteCodec.name.toLowerCase() && codec.clockRate === remoteCodec.clockRate) {\n              codec.preferredPayloadType = remoteCodec.payloadType;\n            }\n          });\n        }\n      });\n      localCapabilities.headerExtensions.forEach(function (hdrExt) {\n        var remoteExtensions = transceiver.remoteCapabilities && transceiver.remoteCapabilities.headerExtensions || [];\n        remoteExtensions.forEach(function (rHdrExt) {\n          if (hdrExt.uri === rHdrExt.uri) {\n            hdrExt.id = rHdrExt.id;\n          }\n        });\n      }); // generate an ssrc now, to be used later in rtpSender.send\n\n      var sendEncodingParameters = transceiver.sendEncodingParameters || [{\n        ssrc: (2 * sdpMLineIndex + 1) * 1001\n      }];\n\n      if (track) {\n        // add RTX\n        if (edgeVersion >= 15019 && kind === 'video' && !sendEncodingParameters[0].rtx) {\n          sendEncodingParameters[0].rtx = {\n            ssrc: sendEncodingParameters[0].ssrc + 1\n          };\n        }\n      }\n\n      if (transceiver.wantReceive) {\n        transceiver.rtpReceiver = new window.RTCRtpReceiver(transceiver.dtlsTransport, kind);\n      }\n\n      transceiver.localCapabilities = localCapabilities;\n      transceiver.sendEncodingParameters = sendEncodingParameters;\n    }); // always offer BUNDLE and dispose on return if not supported.\n\n    if (pc._config.bundlePolicy !== 'max-compat') {\n      sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function (t) {\n        return t.mid;\n      }).join(' ') + '\\r\\n';\n    }\n\n    sdp += 'a=ice-options:trickle\\r\\n';\n    pc.transceivers.forEach(function (transceiver, sdpMLineIndex) {\n      sdp += writeMediaSection(transceiver, transceiver.localCapabilities, 'offer', transceiver.stream, pc._dtlsRole);\n      sdp += 'a=rtcp-rsize\\r\\n';\n\n      if (transceiver.iceGatherer && pc.iceGatheringState !== 'new' && (sdpMLineIndex === 0 || !pc.usingBundle)) {\n        transceiver.iceGatherer.getLocalCandidates().forEach(function (cand) {\n          cand.component = 1;\n          sdp += 'a=' + SDPUtils.writeCandidate(cand) + '\\r\\n';\n        });\n\n        if (transceiver.iceGatherer.state === 'completed') {\n          sdp += 'a=end-of-candidates\\r\\n';\n        }\n      }\n    });\n    var desc = new window.RTCSessionDescription({\n      type: 'offer',\n      sdp: sdp\n    });\n    return Promise.resolve(desc);\n  };\n\n  RTCPeerConnection.prototype.createAnswer = function () {\n    var pc = this;\n\n    if (pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError', 'Can not call createAnswer after close'));\n    }\n\n    var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId, pc._sdpSessionVersion++);\n\n    if (pc.usingBundle) {\n      sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function (t) {\n        return t.mid;\n      }).join(' ') + '\\r\\n';\n    }\n\n    var mediaSectionsInOffer = SDPUtils.getMediaSections(pc.remoteDescription.sdp).length;\n    pc.transceivers.forEach(function (transceiver, sdpMLineIndex) {\n      if (sdpMLineIndex + 1 > mediaSectionsInOffer) {\n        return;\n      }\n\n      if (transceiver.isDatachannel) {\n        sdp += 'm=application 0 DTLS/SCTP 5000\\r\\n' + 'c=IN IP4 0.0.0.0\\r\\n' + 'a=mid:' + transceiver.mid + '\\r\\n';\n        return;\n      } // FIXME: look at direction.\n\n\n      if (transceiver.stream) {\n        var localTrack;\n\n        if (transceiver.kind === 'audio') {\n          localTrack = transceiver.stream.getAudioTracks()[0];\n        } else if (transceiver.kind === 'video') {\n          localTrack = transceiver.stream.getVideoTracks()[0];\n        }\n\n        if (localTrack) {\n          // add RTX\n          if (edgeVersion >= 15019 && transceiver.kind === 'video' && !transceiver.sendEncodingParameters[0].rtx) {\n            transceiver.sendEncodingParameters[0].rtx = {\n              ssrc: transceiver.sendEncodingParameters[0].ssrc + 1\n            };\n          }\n        }\n      } // Calculate intersection of capabilities.\n\n\n      var commonCapabilities = getCommonCapabilities(transceiver.localCapabilities, transceiver.remoteCapabilities);\n      var hasRtx = commonCapabilities.codecs.filter(function (c) {\n        return c.name.toLowerCase() === 'rtx';\n      }).length;\n\n      if (!hasRtx && transceiver.sendEncodingParameters[0].rtx) {\n        delete transceiver.sendEncodingParameters[0].rtx;\n      }\n\n      sdp += writeMediaSection(transceiver, commonCapabilities, 'answer', transceiver.stream, pc._dtlsRole);\n\n      if (transceiver.rtcpParameters && transceiver.rtcpParameters.reducedSize) {\n        sdp += 'a=rtcp-rsize\\r\\n';\n      }\n    });\n    var desc = new window.RTCSessionDescription({\n      type: 'answer',\n      sdp: sdp\n    });\n    return Promise.resolve(desc);\n  };\n\n  RTCPeerConnection.prototype.addIceCandidate = function (candidate) {\n    var pc = this;\n    var sections;\n\n    if (candidate && !(candidate.sdpMLineIndex !== undefined || candidate.sdpMid)) {\n      return Promise.reject(new TypeError('sdpMLineIndex or sdpMid required'));\n    } // TODO: needs to go into ops queue.\n\n\n    return new Promise(function (resolve, reject) {\n      if (!pc.remoteDescription) {\n        return reject(makeError('InvalidStateError', 'Can not add ICE candidate without a remote description'));\n      } else if (!candidate || candidate.candidate === '') {\n        for (var j = 0; j < pc.transceivers.length; j++) {\n          if (pc.transceivers[j].isDatachannel) {\n            continue;\n          }\n\n          pc.transceivers[j].iceTransport.addRemoteCandidate({});\n          sections = SDPUtils.getMediaSections(pc.remoteDescription.sdp);\n          sections[j] += 'a=end-of-candidates\\r\\n';\n          pc.remoteDescription.sdp = SDPUtils.getDescription(pc.remoteDescription.sdp) + sections.join('');\n\n          if (pc.usingBundle) {\n            break;\n          }\n        }\n      } else {\n        var sdpMLineIndex = candidate.sdpMLineIndex;\n\n        if (candidate.sdpMid) {\n          for (var i = 0; i < pc.transceivers.length; i++) {\n            if (pc.transceivers[i].mid === candidate.sdpMid) {\n              sdpMLineIndex = i;\n              break;\n            }\n          }\n        }\n\n        var transceiver = pc.transceivers[sdpMLineIndex];\n\n        if (transceiver) {\n          if (transceiver.isDatachannel) {\n            return resolve();\n          }\n\n          var cand = Object.keys(candidate.candidate).length > 0 ? SDPUtils.parseCandidate(candidate.candidate) : {}; // Ignore Chrome's invalid candidates since Edge does not like them.\n\n          if (cand.protocol === 'tcp' && (cand.port === 0 || cand.port === 9)) {\n            return resolve();\n          } // Ignore RTCP candidates, we assume RTCP-MUX.\n\n\n          if (cand.component && cand.component !== 1) {\n            return resolve();\n          } // when using bundle, avoid adding candidates to the wrong\n          // ice transport. And avoid adding candidates added in the SDP.\n\n\n          if (sdpMLineIndex === 0 || sdpMLineIndex > 0 && transceiver.iceTransport !== pc.transceivers[0].iceTransport) {\n            if (!maybeAddCandidate(transceiver.iceTransport, cand)) {\n              return reject(makeError('OperationError', 'Can not add ICE candidate'));\n            }\n          } // update the remoteDescription.\n\n\n          var candidateString = candidate.candidate.trim();\n\n          if (candidateString.indexOf('a=') === 0) {\n            candidateString = candidateString.substr(2);\n          }\n\n          sections = SDPUtils.getMediaSections(pc.remoteDescription.sdp);\n          sections[sdpMLineIndex] += 'a=' + (cand.type ? candidateString : 'end-of-candidates') + '\\r\\n';\n          pc.remoteDescription.sdp = sections.join('');\n        } else {\n          return reject(makeError('OperationError', 'Can not add ICE candidate'));\n        }\n      }\n\n      resolve();\n    });\n  };\n\n  RTCPeerConnection.prototype.getStats = function () {\n    var promises = [];\n    this.transceivers.forEach(function (transceiver) {\n      ['rtpSender', 'rtpReceiver', 'iceGatherer', 'iceTransport', 'dtlsTransport'].forEach(function (method) {\n        if (transceiver[method]) {\n          promises.push(transceiver[method].getStats());\n        }\n      });\n    });\n\n    var fixStatsType = function (stat) {\n      return {\n        inboundrtp: 'inbound-rtp',\n        outboundrtp: 'outbound-rtp',\n        candidatepair: 'candidate-pair',\n        localcandidate: 'local-candidate',\n        remotecandidate: 'remote-candidate'\n      }[stat.type] || stat.type;\n    };\n\n    return new Promise(function (resolve) {\n      // shim getStats with maplike support\n      var results = new Map();\n      Promise.all(promises).then(function (res) {\n        res.forEach(function (result) {\n          Object.keys(result).forEach(function (id) {\n            result[id].type = fixStatsType(result[id]);\n            results.set(id, result[id]);\n          });\n        });\n        resolve(results);\n      });\n    });\n  }; // legacy callback shims. Should be moved to adapter.js some days.\n\n\n  var methods = ['createOffer', 'createAnswer'];\n  methods.forEach(function (method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n\n    RTCPeerConnection.prototype[method] = function () {\n      var args = arguments;\n\n      if (typeof args[0] === 'function' || typeof args[1] === 'function') {\n        // legacy\n        return nativeMethod.apply(this, [arguments[2]]).then(function (description) {\n          if (typeof args[0] === 'function') {\n            args[0].apply(null, [description]);\n          }\n        }, function (error) {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null, [error]);\n          }\n        });\n      }\n\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n  methods = ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate'];\n  methods.forEach(function (method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n\n    RTCPeerConnection.prototype[method] = function () {\n      var args = arguments;\n\n      if (typeof args[1] === 'function' || typeof args[2] === 'function') {\n        // legacy\n        return nativeMethod.apply(this, arguments).then(function () {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null);\n          }\n        }, function (error) {\n          if (typeof args[2] === 'function') {\n            args[2].apply(null, [error]);\n          }\n        });\n      }\n\n      return nativeMethod.apply(this, arguments);\n    };\n  }); // getStats is special. It doesn't have a spec legacy method yet we support\n  // getStats(something, cb) without error callbacks.\n\n  ['getStats'].forEach(function (method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n\n    RTCPeerConnection.prototype[method] = function () {\n      var args = arguments;\n\n      if (typeof args[1] === 'function') {\n        return nativeMethod.apply(this, arguments).then(function () {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null);\n          }\n        });\n      }\n\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n  return RTCPeerConnection;\n};","map":{"version":3,"names":["SDPUtils","require","writeMediaSection","transceiver","caps","type","stream","dtlsRole","sdp","writeRtpDescription","kind","writeIceParameters","iceGatherer","getLocalParameters","writeDtlsParameters","dtlsTransport","mid","rtpSender","rtpReceiver","trackId","_initialTrackId","track","id","msid","sendEncodingParameters","ssrc","rtx","localCName","filterIceServers","iceServers","edgeVersion","hasTurn","JSON","parse","stringify","filter","server","urls","url","console","warn","isString","validTurn","indexOf","length","getCommonCapabilities","localCapabilities","remoteCapabilities","commonCapabilities","codecs","headerExtensions","fecMechanisms","findCodecByPayloadType","pt","parseInt","i","payloadType","preferredPayloadType","rtxCapabilityMatches","lRtx","rRtx","lCodecs","rCodecs","lCodec","parameters","apt","rCodec","name","toLowerCase","forEach","clockRate","numChannels","Math","min","push","rtcpFeedback","fb","j","parameter","lHeaderExtension","rHeaderExtension","uri","isActionAllowedInSignalingState","action","signalingState","offer","setLocalDescription","setRemoteDescription","answer","maybeAddCandidate","iceTransport","candidate","alreadyAdded","getRemoteCandidates","find","remoteCandidate","foundation","ip","port","priority","protocol","addRemoteCandidate","makeError","description","e","Error","module","exports","window","addTrackToStreamAndFireEvent","addTrack","dispatchEvent","MediaStreamTrackEvent","removeTrackFromStreamAndFireEvent","removeTrack","fireAddTrack","pc","receiver","streams","trackEvent","Event","setTimeout","_dispatchEvent","RTCPeerConnection","config","_eventTarget","document","createDocumentFragment","method","bind","canTrickleIceCandidates","needNegotiation","localStreams","remoteStreams","localDescription","remoteDescription","iceConnectionState","iceGatheringState","usingBundle","bundlePolicy","rtcpMuxPolicy","iceTransportPolicy","_iceGatherers","iceCandidatePoolSize","RTCIceGatherer","gatherPolicy","_config","transceivers","_sdpSessionId","generateSessionId","_sdpSessionVersion","_dtlsRole","undefined","_isClosed","prototype","onicecandidate","onaddstream","ontrack","onremovestream","onsignalingstatechange","oniceconnectionstatechange","onicegatheringstatechange","onnegotiationneeded","ondatachannel","event","_emitGatheringStateChange","getConfiguration","getLocalStreams","getRemoteStreams","_createTransceiver","hasBundleTransport","recvEncodingParameters","associatedRemoteMediaStreams","wantReceive","transports","_createIceAndDtlsTransports","alreadyExists","s","_maybeFireNegotiationNeeded","RTCRtpSender","addStream","getTracks","clonedStream","clone","idx","clonedTrack","addEventListener","enabled","sender","TypeError","t","stop","map","splice","removeStream","getSenders","getReceivers","_createIceGatherer","sdpMLineIndex","shift","Object","defineProperty","value","writable","bufferedCandidateEvents","bufferCandidates","end","keys","state","_gather","onlocalcandidate","removeEventListener","evt","sdpMid","cand","component","serializedCandidate","writeCandidate","assign","parseCandidate","sections","getMediaSections","getDescription","join","complete","every","RTCIceTransport","onicestatechange","_updateConnectionState","RTCDtlsTransport","ondtlsstatechange","onerror","_disposeIceAndDtlsTransports","_transceive","send","recv","params","encodings","rtcp","cname","compound","rtcpParameters","p","receive","Promise","reject","sessionpart","splitSections","mediaSection","parseRtpParameters","isIceLite","matchPrefix","rejected","isRejected","isDatachannel","remoteIceParameters","getIceParameters","remoteDtlsParameters","getDtlsParameters","role","start","_updateSignalingState","resolve","receiverList","iceOptions","substr","split","lines","splitLines","getKind","direction","getDirection","remoteMsid","parseMsid","getMid","generateIdentifier","parseRtpEncodingParameters","parseRtcpParameters","isComplete","cands","setTransport","setRemoteCandidates","RTCRtpReceiver","getCapabilities","codec","isNewTrack","MediaStream","get","default","nativeTrack","sid","item","close","newState","states","closed","connecting","checking","connected","completed","disconnected","failed","new","createOffer","numAudioTracks","numVideoTracks","offerOptions","arguments","mandatory","optional","offerToReceiveAudio","offerToReceiveVideo","writeSessionBoilerplate","remoteCodec","hdrExt","remoteExtensions","rHdrExt","getLocalCandidates","desc","RTCSessionDescription","createAnswer","mediaSectionsInOffer","localTrack","getAudioTracks","getVideoTracks","hasRtx","c","reducedSize","addIceCandidate","candidateString","trim","getStats","promises","fixStatsType","stat","inboundrtp","outboundrtp","candidatepair","localcandidate","remotecandidate","results","Map","all","then","res","result","set","methods","nativeMethod","args","apply","error"],"sources":["/home/david/Desktop/workSpace/bots-dashboard/node_modules/rtcpeerconnection-shim/rtcpeerconnection.js"],"sourcesContent":["/*\n *  Copyright (c) 2017 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\n\nvar SDPUtils = require('sdp');\n\nfunction writeMediaSection(transceiver, caps, type, stream, dtlsRole) {\n  var sdp = SDPUtils.writeRtpDescription(transceiver.kind, caps);\n\n  // Map ICE parameters (ufrag, pwd) to SDP.\n  sdp += SDPUtils.writeIceParameters(\n      transceiver.iceGatherer.getLocalParameters());\n\n  // Map DTLS parameters to SDP.\n  sdp += SDPUtils.writeDtlsParameters(\n      transceiver.dtlsTransport.getLocalParameters(),\n      type === 'offer' ? 'actpass' : dtlsRole || 'active');\n\n  sdp += 'a=mid:' + transceiver.mid + '\\r\\n';\n\n  if (transceiver.rtpSender && transceiver.rtpReceiver) {\n    sdp += 'a=sendrecv\\r\\n';\n  } else if (transceiver.rtpSender) {\n    sdp += 'a=sendonly\\r\\n';\n  } else if (transceiver.rtpReceiver) {\n    sdp += 'a=recvonly\\r\\n';\n  } else {\n    sdp += 'a=inactive\\r\\n';\n  }\n\n  if (transceiver.rtpSender) {\n    var trackId = transceiver.rtpSender._initialTrackId ||\n        transceiver.rtpSender.track.id;\n    transceiver.rtpSender._initialTrackId = trackId;\n    // spec.\n    var msid = 'msid:' + (stream ? stream.id : '-') + ' ' +\n        trackId + '\\r\\n';\n    sdp += 'a=' + msid;\n    // for Chrome. Legacy should no longer be required.\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +\n        ' ' + msid;\n\n    // RTX\n    if (transceiver.sendEncodingParameters[0].rtx) {\n      sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +\n          ' ' + msid;\n      sdp += 'a=ssrc-group:FID ' +\n          transceiver.sendEncodingParameters[0].ssrc + ' ' +\n          transceiver.sendEncodingParameters[0].rtx.ssrc +\n          '\\r\\n';\n    }\n  }\n  // FIXME: this should be written by writeRtpDescription.\n  sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +\n      ' cname:' + SDPUtils.localCName + '\\r\\n';\n  if (transceiver.rtpSender && transceiver.sendEncodingParameters[0].rtx) {\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +\n        ' cname:' + SDPUtils.localCName + '\\r\\n';\n  }\n  return sdp;\n}\n\n// Edge does not like\n// 1) stun: filtered after 14393 unless ?transport=udp is present\n// 2) turn: that does not have all of turn:host:port?transport=udp\n// 3) turn: with ipv6 addresses\n// 4) turn: occurring muliple times\nfunction filterIceServers(iceServers, edgeVersion) {\n  var hasTurn = false;\n  iceServers = JSON.parse(JSON.stringify(iceServers));\n  return iceServers.filter(function(server) {\n    if (server && (server.urls || server.url)) {\n      var urls = server.urls || server.url;\n      if (server.url && !server.urls) {\n        console.warn('RTCIceServer.url is deprecated! Use urls instead.');\n      }\n      var isString = typeof urls === 'string';\n      if (isString) {\n        urls = [urls];\n      }\n      urls = urls.filter(function(url) {\n        var validTurn = url.indexOf('turn:') === 0 &&\n            url.indexOf('transport=udp') !== -1 &&\n            url.indexOf('turn:[') === -1 &&\n            !hasTurn;\n\n        if (validTurn) {\n          hasTurn = true;\n          return true;\n        }\n        return url.indexOf('stun:') === 0 && edgeVersion >= 14393 &&\n            url.indexOf('?transport=udp') === -1;\n      });\n\n      delete server.url;\n      server.urls = isString ? urls[0] : urls;\n      return !!urls.length;\n    }\n  });\n}\n\n// Determines the intersection of local and remote capabilities.\nfunction getCommonCapabilities(localCapabilities, remoteCapabilities) {\n  var commonCapabilities = {\n    codecs: [],\n    headerExtensions: [],\n    fecMechanisms: []\n  };\n\n  var findCodecByPayloadType = function(pt, codecs) {\n    pt = parseInt(pt, 10);\n    for (var i = 0; i < codecs.length; i++) {\n      if (codecs[i].payloadType === pt ||\n          codecs[i].preferredPayloadType === pt) {\n        return codecs[i];\n      }\n    }\n  };\n\n  var rtxCapabilityMatches = function(lRtx, rRtx, lCodecs, rCodecs) {\n    var lCodec = findCodecByPayloadType(lRtx.parameters.apt, lCodecs);\n    var rCodec = findCodecByPayloadType(rRtx.parameters.apt, rCodecs);\n    return lCodec && rCodec &&\n        lCodec.name.toLowerCase() === rCodec.name.toLowerCase();\n  };\n\n  localCapabilities.codecs.forEach(function(lCodec) {\n    for (var i = 0; i < remoteCapabilities.codecs.length; i++) {\n      var rCodec = remoteCapabilities.codecs[i];\n      if (lCodec.name.toLowerCase() === rCodec.name.toLowerCase() &&\n          lCodec.clockRate === rCodec.clockRate) {\n        if (lCodec.name.toLowerCase() === 'rtx' &&\n            lCodec.parameters && rCodec.parameters.apt) {\n          // for RTX we need to find the local rtx that has a apt\n          // which points to the same local codec as the remote one.\n          if (!rtxCapabilityMatches(lCodec, rCodec,\n              localCapabilities.codecs, remoteCapabilities.codecs)) {\n            continue;\n          }\n        }\n        rCodec = JSON.parse(JSON.stringify(rCodec)); // deepcopy\n        // number of channels is the highest common number of channels\n        rCodec.numChannels = Math.min(lCodec.numChannels,\n            rCodec.numChannels);\n        // push rCodec so we reply with offerer payload type\n        commonCapabilities.codecs.push(rCodec);\n\n        // determine common feedback mechanisms\n        rCodec.rtcpFeedback = rCodec.rtcpFeedback.filter(function(fb) {\n          for (var j = 0; j < lCodec.rtcpFeedback.length; j++) {\n            if (lCodec.rtcpFeedback[j].type === fb.type &&\n                lCodec.rtcpFeedback[j].parameter === fb.parameter) {\n              return true;\n            }\n          }\n          return false;\n        });\n        // FIXME: also need to determine .parameters\n        //  see https://github.com/openpeer/ortc/issues/569\n        break;\n      }\n    }\n  });\n\n  localCapabilities.headerExtensions.forEach(function(lHeaderExtension) {\n    for (var i = 0; i < remoteCapabilities.headerExtensions.length;\n         i++) {\n      var rHeaderExtension = remoteCapabilities.headerExtensions[i];\n      if (lHeaderExtension.uri === rHeaderExtension.uri) {\n        commonCapabilities.headerExtensions.push(rHeaderExtension);\n        break;\n      }\n    }\n  });\n\n  // FIXME: fecMechanisms\n  return commonCapabilities;\n}\n\n// is action=setLocalDescription with type allowed in signalingState\nfunction isActionAllowedInSignalingState(action, type, signalingState) {\n  return {\n    offer: {\n      setLocalDescription: ['stable', 'have-local-offer'],\n      setRemoteDescription: ['stable', 'have-remote-offer']\n    },\n    answer: {\n      setLocalDescription: ['have-remote-offer', 'have-local-pranswer'],\n      setRemoteDescription: ['have-local-offer', 'have-remote-pranswer']\n    }\n  }[type][action].indexOf(signalingState) !== -1;\n}\n\nfunction maybeAddCandidate(iceTransport, candidate) {\n  // Edge's internal representation adds some fields therefore\n  // not all fieldѕ are taken into account.\n  var alreadyAdded = iceTransport.getRemoteCandidates()\n      .find(function(remoteCandidate) {\n        return candidate.foundation === remoteCandidate.foundation &&\n            candidate.ip === remoteCandidate.ip &&\n            candidate.port === remoteCandidate.port &&\n            candidate.priority === remoteCandidate.priority &&\n            candidate.protocol === remoteCandidate.protocol &&\n            candidate.type === remoteCandidate.type;\n      });\n  if (!alreadyAdded) {\n    iceTransport.addRemoteCandidate(candidate);\n  }\n  return !alreadyAdded;\n}\n\n\nfunction makeError(name, description) {\n  var e = new Error(description);\n  e.name = name;\n  return e;\n}\n\nmodule.exports = function(window, edgeVersion) {\n  // https://w3c.github.io/mediacapture-main/#mediastream\n  // Helper function to add the track to the stream and\n  // dispatch the event ourselves.\n  function addTrackToStreamAndFireEvent(track, stream) {\n    stream.addTrack(track);\n    stream.dispatchEvent(new window.MediaStreamTrackEvent('addtrack',\n        {track: track}));\n  }\n\n  function removeTrackFromStreamAndFireEvent(track, stream) {\n    stream.removeTrack(track);\n    stream.dispatchEvent(new window.MediaStreamTrackEvent('removetrack',\n        {track: track}));\n  }\n\n  function fireAddTrack(pc, track, receiver, streams) {\n    var trackEvent = new Event('track');\n    trackEvent.track = track;\n    trackEvent.receiver = receiver;\n    trackEvent.transceiver = {receiver: receiver};\n    trackEvent.streams = streams;\n    window.setTimeout(function() {\n      pc._dispatchEvent('track', trackEvent);\n    });\n  }\n\n  var RTCPeerConnection = function(config) {\n    var pc = this;\n\n    var _eventTarget = document.createDocumentFragment();\n    ['addEventListener', 'removeEventListener', 'dispatchEvent']\n        .forEach(function(method) {\n          pc[method] = _eventTarget[method].bind(_eventTarget);\n        });\n\n    this.canTrickleIceCandidates = null;\n\n    this.needNegotiation = false;\n\n    this.localStreams = [];\n    this.remoteStreams = [];\n\n    this.localDescription = null;\n    this.remoteDescription = null;\n\n    this.signalingState = 'stable';\n    this.iceConnectionState = 'new';\n    this.iceGatheringState = 'new';\n\n    config = JSON.parse(JSON.stringify(config || {}));\n\n    this.usingBundle = config.bundlePolicy === 'max-bundle';\n    if (config.rtcpMuxPolicy === 'negotiate') {\n      throw(makeError('NotSupportedError',\n          'rtcpMuxPolicy \\'negotiate\\' is not supported'));\n    } else if (!config.rtcpMuxPolicy) {\n      config.rtcpMuxPolicy = 'require';\n    }\n\n    switch (config.iceTransportPolicy) {\n      case 'all':\n      case 'relay':\n        break;\n      default:\n        config.iceTransportPolicy = 'all';\n        break;\n    }\n\n    switch (config.bundlePolicy) {\n      case 'balanced':\n      case 'max-compat':\n      case 'max-bundle':\n        break;\n      default:\n        config.bundlePolicy = 'balanced';\n        break;\n    }\n\n    config.iceServers = filterIceServers(config.iceServers || [], edgeVersion);\n\n    this._iceGatherers = [];\n    if (config.iceCandidatePoolSize) {\n      for (var i = config.iceCandidatePoolSize; i > 0; i--) {\n        this._iceGatherers.push(new window.RTCIceGatherer({\n          iceServers: config.iceServers,\n          gatherPolicy: config.iceTransportPolicy\n        }));\n      }\n    } else {\n      config.iceCandidatePoolSize = 0;\n    }\n\n    this._config = config;\n\n    // per-track iceGathers, iceTransports, dtlsTransports, rtpSenders, ...\n    // everything that is needed to describe a SDP m-line.\n    this.transceivers = [];\n\n    this._sdpSessionId = SDPUtils.generateSessionId();\n    this._sdpSessionVersion = 0;\n\n    this._dtlsRole = undefined; // role for a=setup to use in answers.\n\n    this._isClosed = false;\n  };\n\n  // set up event handlers on prototype\n  RTCPeerConnection.prototype.onicecandidate = null;\n  RTCPeerConnection.prototype.onaddstream = null;\n  RTCPeerConnection.prototype.ontrack = null;\n  RTCPeerConnection.prototype.onremovestream = null;\n  RTCPeerConnection.prototype.onsignalingstatechange = null;\n  RTCPeerConnection.prototype.oniceconnectionstatechange = null;\n  RTCPeerConnection.prototype.onicegatheringstatechange = null;\n  RTCPeerConnection.prototype.onnegotiationneeded = null;\n  RTCPeerConnection.prototype.ondatachannel = null;\n\n  RTCPeerConnection.prototype._dispatchEvent = function(name, event) {\n    if (this._isClosed) {\n      return;\n    }\n    this.dispatchEvent(event);\n    if (typeof this['on' + name] === 'function') {\n      this['on' + name](event);\n    }\n  };\n\n  RTCPeerConnection.prototype._emitGatheringStateChange = function() {\n    var event = new Event('icegatheringstatechange');\n    this._dispatchEvent('icegatheringstatechange', event);\n  };\n\n  RTCPeerConnection.prototype.getConfiguration = function() {\n    return this._config;\n  };\n\n  RTCPeerConnection.prototype.getLocalStreams = function() {\n    return this.localStreams;\n  };\n\n  RTCPeerConnection.prototype.getRemoteStreams = function() {\n    return this.remoteStreams;\n  };\n\n  // internal helper to create a transceiver object.\n  // (whih is not yet the same as the WebRTC 1.0 transceiver)\n  RTCPeerConnection.prototype._createTransceiver = function(kind) {\n    var hasBundleTransport = this.transceivers.length > 0;\n    var transceiver = {\n      track: null,\n      iceGatherer: null,\n      iceTransport: null,\n      dtlsTransport: null,\n      localCapabilities: null,\n      remoteCapabilities: null,\n      rtpSender: null,\n      rtpReceiver: null,\n      kind: kind,\n      mid: null,\n      sendEncodingParameters: null,\n      recvEncodingParameters: null,\n      stream: null,\n      associatedRemoteMediaStreams: [],\n      wantReceive: true\n    };\n    if (this.usingBundle && hasBundleTransport) {\n      transceiver.iceTransport = this.transceivers[0].iceTransport;\n      transceiver.dtlsTransport = this.transceivers[0].dtlsTransport;\n    } else {\n      var transports = this._createIceAndDtlsTransports();\n      transceiver.iceTransport = transports.iceTransport;\n      transceiver.dtlsTransport = transports.dtlsTransport;\n    }\n    this.transceivers.push(transceiver);\n    return transceiver;\n  };\n\n  RTCPeerConnection.prototype.addTrack = function(track, stream) {\n    if (this._isClosed) {\n      throw makeError('InvalidStateError',\n          'Attempted to call addTrack on a closed peerconnection.');\n    }\n\n    var alreadyExists = this.transceivers.find(function(s) {\n      return s.track === track;\n    });\n\n    if (alreadyExists) {\n      throw makeError('InvalidAccessError', 'Track already exists.');\n    }\n\n    var transceiver;\n    for (var i = 0; i < this.transceivers.length; i++) {\n      if (!this.transceivers[i].track &&\n          this.transceivers[i].kind === track.kind) {\n        transceiver = this.transceivers[i];\n      }\n    }\n    if (!transceiver) {\n      transceiver = this._createTransceiver(track.kind);\n    }\n\n    this._maybeFireNegotiationNeeded();\n\n    if (this.localStreams.indexOf(stream) === -1) {\n      this.localStreams.push(stream);\n    }\n\n    transceiver.track = track;\n    transceiver.stream = stream;\n    transceiver.rtpSender = new window.RTCRtpSender(track,\n        transceiver.dtlsTransport);\n    return transceiver.rtpSender;\n  };\n\n  RTCPeerConnection.prototype.addStream = function(stream) {\n    var pc = this;\n    if (edgeVersion >= 15025) {\n      stream.getTracks().forEach(function(track) {\n        pc.addTrack(track, stream);\n      });\n    } else {\n      // Clone is necessary for local demos mostly, attaching directly\n      // to two different senders does not work (build 10547).\n      // Fixed in 15025 (or earlier)\n      var clonedStream = stream.clone();\n      stream.getTracks().forEach(function(track, idx) {\n        var clonedTrack = clonedStream.getTracks()[idx];\n        track.addEventListener('enabled', function(event) {\n          clonedTrack.enabled = event.enabled;\n        });\n      });\n      clonedStream.getTracks().forEach(function(track) {\n        pc.addTrack(track, clonedStream);\n      });\n    }\n  };\n\n  RTCPeerConnection.prototype.removeTrack = function(sender) {\n    if (this._isClosed) {\n      throw makeError('InvalidStateError',\n          'Attempted to call removeTrack on a closed peerconnection.');\n    }\n\n    if (!(sender instanceof window.RTCRtpSender)) {\n      throw new TypeError('Argument 1 of RTCPeerConnection.removeTrack ' +\n          'does not implement interface RTCRtpSender.');\n    }\n\n    var transceiver = this.transceivers.find(function(t) {\n      return t.rtpSender === sender;\n    });\n\n    if (!transceiver) {\n      throw makeError('InvalidAccessError',\n          'Sender was not created by this connection.');\n    }\n    var stream = transceiver.stream;\n\n    transceiver.rtpSender.stop();\n    transceiver.rtpSender = null;\n    transceiver.track = null;\n    transceiver.stream = null;\n\n    // remove the stream from the set of local streams\n    var localStreams = this.transceivers.map(function(t) {\n      return t.stream;\n    });\n    if (localStreams.indexOf(stream) === -1 &&\n        this.localStreams.indexOf(stream) > -1) {\n      this.localStreams.splice(this.localStreams.indexOf(stream), 1);\n    }\n\n    this._maybeFireNegotiationNeeded();\n  };\n\n  RTCPeerConnection.prototype.removeStream = function(stream) {\n    var pc = this;\n    stream.getTracks().forEach(function(track) {\n      var sender = pc.getSenders().find(function(s) {\n        return s.track === track;\n      });\n      if (sender) {\n        pc.removeTrack(sender);\n      }\n    });\n  };\n\n  RTCPeerConnection.prototype.getSenders = function() {\n    return this.transceivers.filter(function(transceiver) {\n      return !!transceiver.rtpSender;\n    })\n    .map(function(transceiver) {\n      return transceiver.rtpSender;\n    });\n  };\n\n  RTCPeerConnection.prototype.getReceivers = function() {\n    return this.transceivers.filter(function(transceiver) {\n      return !!transceiver.rtpReceiver;\n    })\n    .map(function(transceiver) {\n      return transceiver.rtpReceiver;\n    });\n  };\n\n\n  RTCPeerConnection.prototype._createIceGatherer = function(sdpMLineIndex,\n      usingBundle) {\n    var pc = this;\n    if (usingBundle && sdpMLineIndex > 0) {\n      return this.transceivers[0].iceGatherer;\n    } else if (this._iceGatherers.length) {\n      return this._iceGatherers.shift();\n    }\n    var iceGatherer = new window.RTCIceGatherer({\n      iceServers: this._config.iceServers,\n      gatherPolicy: this._config.iceTransportPolicy\n    });\n    Object.defineProperty(iceGatherer, 'state',\n        {value: 'new', writable: true}\n    );\n\n    this.transceivers[sdpMLineIndex].bufferedCandidateEvents = [];\n    this.transceivers[sdpMLineIndex].bufferCandidates = function(event) {\n      var end = !event.candidate || Object.keys(event.candidate).length === 0;\n      // polyfill since RTCIceGatherer.state is not implemented in\n      // Edge 10547 yet.\n      iceGatherer.state = end ? 'completed' : 'gathering';\n      if (pc.transceivers[sdpMLineIndex].bufferedCandidateEvents !== null) {\n        pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event);\n      }\n    };\n    iceGatherer.addEventListener('localcandidate',\n      this.transceivers[sdpMLineIndex].bufferCandidates);\n    return iceGatherer;\n  };\n\n  // start gathering from an RTCIceGatherer.\n  RTCPeerConnection.prototype._gather = function(mid, sdpMLineIndex) {\n    var pc = this;\n    var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;\n    if (iceGatherer.onlocalcandidate) {\n      return;\n    }\n    var bufferedCandidateEvents =\n      this.transceivers[sdpMLineIndex].bufferedCandidateEvents;\n    this.transceivers[sdpMLineIndex].bufferedCandidateEvents = null;\n    iceGatherer.removeEventListener('localcandidate',\n      this.transceivers[sdpMLineIndex].bufferCandidates);\n    iceGatherer.onlocalcandidate = function(evt) {\n      if (pc.usingBundle && sdpMLineIndex > 0) {\n        // if we know that we use bundle we can drop candidates with\n        // ѕdpMLineIndex > 0. If we don't do this then our state gets\n        // confused since we dispose the extra ice gatherer.\n        return;\n      }\n      var event = new Event('icecandidate');\n      event.candidate = {sdpMid: mid, sdpMLineIndex: sdpMLineIndex};\n\n      var cand = evt.candidate;\n      // Edge emits an empty object for RTCIceCandidateComplete‥\n      var end = !cand || Object.keys(cand).length === 0;\n      if (end) {\n        // polyfill since RTCIceGatherer.state is not implemented in\n        // Edge 10547 yet.\n        if (iceGatherer.state === 'new' || iceGatherer.state === 'gathering') {\n          iceGatherer.state = 'completed';\n        }\n      } else {\n        if (iceGatherer.state === 'new') {\n          iceGatherer.state = 'gathering';\n        }\n        // RTCIceCandidate doesn't have a component, needs to be added\n        cand.component = 1;\n        var serializedCandidate = SDPUtils.writeCandidate(cand);\n        event.candidate = Object.assign(event.candidate,\n            SDPUtils.parseCandidate(serializedCandidate));\n        event.candidate.candidate = serializedCandidate;\n      }\n\n      // update local description.\n      var sections = SDPUtils.getMediaSections(pc.localDescription.sdp);\n      if (!end) {\n        sections[event.candidate.sdpMLineIndex] +=\n            'a=' + event.candidate.candidate + '\\r\\n';\n      } else {\n        sections[event.candidate.sdpMLineIndex] +=\n            'a=end-of-candidates\\r\\n';\n      }\n      pc.localDescription.sdp =\n          SDPUtils.getDescription(pc.localDescription.sdp) +\n          sections.join('');\n      var complete = pc.transceivers.every(function(transceiver) {\n        return transceiver.iceGatherer &&\n            transceiver.iceGatherer.state === 'completed';\n      });\n\n      if (pc.iceGatheringState !== 'gathering') {\n        pc.iceGatheringState = 'gathering';\n        pc._emitGatheringStateChange();\n      }\n\n      // Emit candidate. Also emit null candidate when all gatherers are\n      // complete.\n      if (!end) {\n        pc._dispatchEvent('icecandidate', event);\n      }\n      if (complete) {\n        pc._dispatchEvent('icecandidate', new Event('icecandidate'));\n        pc.iceGatheringState = 'complete';\n        pc._emitGatheringStateChange();\n      }\n    };\n\n    // emit already gathered candidates.\n    window.setTimeout(function() {\n      bufferedCandidateEvents.forEach(function(e) {\n        iceGatherer.onlocalcandidate(e);\n      });\n    }, 0);\n  };\n\n  // Create ICE transport and DTLS transport.\n  RTCPeerConnection.prototype._createIceAndDtlsTransports = function() {\n    var pc = this;\n    var iceTransport = new window.RTCIceTransport(null);\n    iceTransport.onicestatechange = function() {\n      pc._updateConnectionState();\n    };\n\n    var dtlsTransport = new window.RTCDtlsTransport(iceTransport);\n    dtlsTransport.ondtlsstatechange = function() {\n      pc._updateConnectionState();\n    };\n    dtlsTransport.onerror = function() {\n      // onerror does not set state to failed by itself.\n      Object.defineProperty(dtlsTransport, 'state',\n          {value: 'failed', writable: true});\n      pc._updateConnectionState();\n    };\n\n    return {\n      iceTransport: iceTransport,\n      dtlsTransport: dtlsTransport\n    };\n  };\n\n  // Destroy ICE gatherer, ICE transport and DTLS transport.\n  // Without triggering the callbacks.\n  RTCPeerConnection.prototype._disposeIceAndDtlsTransports = function(\n      sdpMLineIndex) {\n    var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;\n    if (iceGatherer) {\n      delete iceGatherer.onlocalcandidate;\n      delete this.transceivers[sdpMLineIndex].iceGatherer;\n    }\n    var iceTransport = this.transceivers[sdpMLineIndex].iceTransport;\n    if (iceTransport) {\n      delete iceTransport.onicestatechange;\n      delete this.transceivers[sdpMLineIndex].iceTransport;\n    }\n    var dtlsTransport = this.transceivers[sdpMLineIndex].dtlsTransport;\n    if (dtlsTransport) {\n      delete dtlsTransport.ondtlsstatechange;\n      delete dtlsTransport.onerror;\n      delete this.transceivers[sdpMLineIndex].dtlsTransport;\n    }\n  };\n\n  // Start the RTP Sender and Receiver for a transceiver.\n  RTCPeerConnection.prototype._transceive = function(transceiver,\n      send, recv) {\n    var params = getCommonCapabilities(transceiver.localCapabilities,\n        transceiver.remoteCapabilities);\n    if (send && transceiver.rtpSender) {\n      params.encodings = transceiver.sendEncodingParameters;\n      params.rtcp = {\n        cname: SDPUtils.localCName,\n        compound: transceiver.rtcpParameters.compound\n      };\n      if (transceiver.recvEncodingParameters.length) {\n        params.rtcp.ssrc = transceiver.recvEncodingParameters[0].ssrc;\n      }\n      transceiver.rtpSender.send(params);\n    }\n    if (recv && transceiver.rtpReceiver && params.codecs.length > 0) {\n      // remove RTX field in Edge 14942\n      if (transceiver.kind === 'video'\n          && transceiver.recvEncodingParameters\n          && edgeVersion < 15019) {\n        transceiver.recvEncodingParameters.forEach(function(p) {\n          delete p.rtx;\n        });\n      }\n      if (transceiver.recvEncodingParameters.length) {\n        params.encodings = transceiver.recvEncodingParameters;\n      } else {\n        params.encodings = [{}];\n      }\n      params.rtcp = {\n        compound: transceiver.rtcpParameters.compound\n      };\n      if (transceiver.rtcpParameters.cname) {\n        params.rtcp.cname = transceiver.rtcpParameters.cname;\n      }\n      if (transceiver.sendEncodingParameters.length) {\n        params.rtcp.ssrc = transceiver.sendEncodingParameters[0].ssrc;\n      }\n      transceiver.rtpReceiver.receive(params);\n    }\n  };\n\n  RTCPeerConnection.prototype.setLocalDescription = function(description) {\n    var pc = this;\n\n    // Note: pranswer is not supported.\n    if (['offer', 'answer'].indexOf(description.type) === -1) {\n      return Promise.reject(makeError('TypeError',\n          'Unsupported type \"' + description.type + '\"'));\n    }\n\n    if (!isActionAllowedInSignalingState('setLocalDescription',\n        description.type, pc.signalingState) || pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError',\n          'Can not set local ' + description.type +\n          ' in state ' + pc.signalingState));\n    }\n\n    var sections;\n    var sessionpart;\n    if (description.type === 'offer') {\n      // VERY limited support for SDP munging. Limited to:\n      // * changing the order of codecs\n      sections = SDPUtils.splitSections(description.sdp);\n      sessionpart = sections.shift();\n      sections.forEach(function(mediaSection, sdpMLineIndex) {\n        var caps = SDPUtils.parseRtpParameters(mediaSection);\n        pc.transceivers[sdpMLineIndex].localCapabilities = caps;\n      });\n\n      pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {\n        pc._gather(transceiver.mid, sdpMLineIndex);\n      });\n    } else if (description.type === 'answer') {\n      sections = SDPUtils.splitSections(pc.remoteDescription.sdp);\n      sessionpart = sections.shift();\n      var isIceLite = SDPUtils.matchPrefix(sessionpart,\n          'a=ice-lite').length > 0;\n      sections.forEach(function(mediaSection, sdpMLineIndex) {\n        var transceiver = pc.transceivers[sdpMLineIndex];\n        var iceGatherer = transceiver.iceGatherer;\n        var iceTransport = transceiver.iceTransport;\n        var dtlsTransport = transceiver.dtlsTransport;\n        var localCapabilities = transceiver.localCapabilities;\n        var remoteCapabilities = transceiver.remoteCapabilities;\n\n        // treat bundle-only as not-rejected.\n        var rejected = SDPUtils.isRejected(mediaSection) &&\n            SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;\n\n        if (!rejected && !transceiver.isDatachannel) {\n          var remoteIceParameters = SDPUtils.getIceParameters(\n              mediaSection, sessionpart);\n          var remoteDtlsParameters = SDPUtils.getDtlsParameters(\n              mediaSection, sessionpart);\n          if (isIceLite) {\n            remoteDtlsParameters.role = 'server';\n          }\n\n          if (!pc.usingBundle || sdpMLineIndex === 0) {\n            pc._gather(transceiver.mid, sdpMLineIndex);\n            if (iceTransport.state === 'new') {\n              iceTransport.start(iceGatherer, remoteIceParameters,\n                  isIceLite ? 'controlling' : 'controlled');\n            }\n            if (dtlsTransport.state === 'new') {\n              dtlsTransport.start(remoteDtlsParameters);\n            }\n          }\n\n          // Calculate intersection of capabilities.\n          var params = getCommonCapabilities(localCapabilities,\n              remoteCapabilities);\n\n          // Start the RTCRtpSender. The RTCRtpReceiver for this\n          // transceiver has already been started in setRemoteDescription.\n          pc._transceive(transceiver,\n              params.codecs.length > 0,\n              false);\n        }\n      });\n    }\n\n    pc.localDescription = {\n      type: description.type,\n      sdp: description.sdp\n    };\n    if (description.type === 'offer') {\n      pc._updateSignalingState('have-local-offer');\n    } else {\n      pc._updateSignalingState('stable');\n    }\n\n    return Promise.resolve();\n  };\n\n  RTCPeerConnection.prototype.setRemoteDescription = function(description) {\n    var pc = this;\n\n    // Note: pranswer is not supported.\n    if (['offer', 'answer'].indexOf(description.type) === -1) {\n      return Promise.reject(makeError('TypeError',\n          'Unsupported type \"' + description.type + '\"'));\n    }\n\n    if (!isActionAllowedInSignalingState('setRemoteDescription',\n        description.type, pc.signalingState) || pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError',\n          'Can not set remote ' + description.type +\n          ' in state ' + pc.signalingState));\n    }\n\n    var streams = {};\n    pc.remoteStreams.forEach(function(stream) {\n      streams[stream.id] = stream;\n    });\n    var receiverList = [];\n    var sections = SDPUtils.splitSections(description.sdp);\n    var sessionpart = sections.shift();\n    var isIceLite = SDPUtils.matchPrefix(sessionpart,\n        'a=ice-lite').length > 0;\n    var usingBundle = SDPUtils.matchPrefix(sessionpart,\n        'a=group:BUNDLE ').length > 0;\n    pc.usingBundle = usingBundle;\n    var iceOptions = SDPUtils.matchPrefix(sessionpart,\n        'a=ice-options:')[0];\n    if (iceOptions) {\n      pc.canTrickleIceCandidates = iceOptions.substr(14).split(' ')\n          .indexOf('trickle') >= 0;\n    } else {\n      pc.canTrickleIceCandidates = false;\n    }\n\n    sections.forEach(function(mediaSection, sdpMLineIndex) {\n      var lines = SDPUtils.splitLines(mediaSection);\n      var kind = SDPUtils.getKind(mediaSection);\n      // treat bundle-only as not-rejected.\n      var rejected = SDPUtils.isRejected(mediaSection) &&\n          SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;\n      var protocol = lines[0].substr(2).split(' ')[2];\n\n      var direction = SDPUtils.getDirection(mediaSection, sessionpart);\n      var remoteMsid = SDPUtils.parseMsid(mediaSection);\n\n      var mid = SDPUtils.getMid(mediaSection) || SDPUtils.generateIdentifier();\n\n      // Reject datachannels which are not implemented yet.\n      if (kind === 'application' && protocol === 'DTLS/SCTP') {\n        pc.transceivers[sdpMLineIndex] = {\n          mid: mid,\n          isDatachannel: true\n        };\n        return;\n      }\n\n      var transceiver;\n      var iceGatherer;\n      var iceTransport;\n      var dtlsTransport;\n      var rtpReceiver;\n      var sendEncodingParameters;\n      var recvEncodingParameters;\n      var localCapabilities;\n\n      var track;\n      // FIXME: ensure the mediaSection has rtcp-mux set.\n      var remoteCapabilities = SDPUtils.parseRtpParameters(mediaSection);\n      var remoteIceParameters;\n      var remoteDtlsParameters;\n      if (!rejected) {\n        remoteIceParameters = SDPUtils.getIceParameters(mediaSection,\n            sessionpart);\n        remoteDtlsParameters = SDPUtils.getDtlsParameters(mediaSection,\n            sessionpart);\n        remoteDtlsParameters.role = 'client';\n      }\n      recvEncodingParameters =\n          SDPUtils.parseRtpEncodingParameters(mediaSection);\n\n      var rtcpParameters = SDPUtils.parseRtcpParameters(mediaSection);\n\n      var isComplete = SDPUtils.matchPrefix(mediaSection,\n          'a=end-of-candidates', sessionpart).length > 0;\n      var cands = SDPUtils.matchPrefix(mediaSection, 'a=candidate:')\n          .map(function(cand) {\n            return SDPUtils.parseCandidate(cand);\n          })\n          .filter(function(cand) {\n            return cand.component === 1;\n          });\n\n      // Check if we can use BUNDLE and dispose transports.\n      if ((description.type === 'offer' || description.type === 'answer') &&\n          !rejected && usingBundle && sdpMLineIndex > 0 &&\n          pc.transceivers[sdpMLineIndex]) {\n        pc._disposeIceAndDtlsTransports(sdpMLineIndex);\n        pc.transceivers[sdpMLineIndex].iceGatherer =\n            pc.transceivers[0].iceGatherer;\n        pc.transceivers[sdpMLineIndex].iceTransport =\n            pc.transceivers[0].iceTransport;\n        pc.transceivers[sdpMLineIndex].dtlsTransport =\n            pc.transceivers[0].dtlsTransport;\n        if (pc.transceivers[sdpMLineIndex].rtpSender) {\n          pc.transceivers[sdpMLineIndex].rtpSender.setTransport(\n              pc.transceivers[0].dtlsTransport);\n        }\n        if (pc.transceivers[sdpMLineIndex].rtpReceiver) {\n          pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(\n              pc.transceivers[0].dtlsTransport);\n        }\n      }\n      if (description.type === 'offer' && !rejected) {\n        transceiver = pc.transceivers[sdpMLineIndex] ||\n            pc._createTransceiver(kind);\n        transceiver.mid = mid;\n\n        if (!transceiver.iceGatherer) {\n          transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex,\n              usingBundle);\n        }\n\n        if (cands.length && transceiver.iceTransport.state === 'new') {\n          if (isComplete && (!usingBundle || sdpMLineIndex === 0)) {\n            transceiver.iceTransport.setRemoteCandidates(cands);\n          } else {\n            cands.forEach(function(candidate) {\n              maybeAddCandidate(transceiver.iceTransport, candidate);\n            });\n          }\n        }\n\n        localCapabilities = window.RTCRtpReceiver.getCapabilities(kind);\n\n        // filter RTX until additional stuff needed for RTX is implemented\n        // in adapter.js\n        if (edgeVersion < 15019) {\n          localCapabilities.codecs = localCapabilities.codecs.filter(\n              function(codec) {\n                return codec.name !== 'rtx';\n              });\n        }\n\n        sendEncodingParameters = transceiver.sendEncodingParameters || [{\n          ssrc: (2 * sdpMLineIndex + 2) * 1001\n        }];\n\n        // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams\n        var isNewTrack = false;\n        if (direction === 'sendrecv' || direction === 'sendonly') {\n          isNewTrack = !transceiver.rtpReceiver;\n          rtpReceiver = transceiver.rtpReceiver ||\n              new window.RTCRtpReceiver(transceiver.dtlsTransport, kind);\n\n          if (isNewTrack) {\n            var stream;\n            track = rtpReceiver.track;\n            // FIXME: does not work with Plan B.\n            if (remoteMsid && remoteMsid.stream === '-') {\n              // no-op. a stream id of '-' means: no associated stream.\n            } else if (remoteMsid) {\n              if (!streams[remoteMsid.stream]) {\n                streams[remoteMsid.stream] = new window.MediaStream();\n                Object.defineProperty(streams[remoteMsid.stream], 'id', {\n                  get: function() {\n                    return remoteMsid.stream;\n                  }\n                });\n              }\n              Object.defineProperty(track, 'id', {\n                get: function() {\n                  return remoteMsid.track;\n                }\n              });\n              stream = streams[remoteMsid.stream];\n            } else {\n              if (!streams.default) {\n                streams.default = new window.MediaStream();\n              }\n              stream = streams.default;\n            }\n            if (stream) {\n              addTrackToStreamAndFireEvent(track, stream);\n              transceiver.associatedRemoteMediaStreams.push(stream);\n            }\n            receiverList.push([track, rtpReceiver, stream]);\n          }\n        } else if (transceiver.rtpReceiver && transceiver.rtpReceiver.track) {\n          transceiver.associatedRemoteMediaStreams.forEach(function(s) {\n            var nativeTrack = s.getTracks().find(function(t) {\n              return t.id === transceiver.rtpReceiver.track.id;\n            });\n            if (nativeTrack) {\n              removeTrackFromStreamAndFireEvent(nativeTrack, s);\n            }\n          });\n          transceiver.associatedRemoteMediaStreams = [];\n        }\n\n        transceiver.localCapabilities = localCapabilities;\n        transceiver.remoteCapabilities = remoteCapabilities;\n        transceiver.rtpReceiver = rtpReceiver;\n        transceiver.rtcpParameters = rtcpParameters;\n        transceiver.sendEncodingParameters = sendEncodingParameters;\n        transceiver.recvEncodingParameters = recvEncodingParameters;\n\n        // Start the RTCRtpReceiver now. The RTPSender is started in\n        // setLocalDescription.\n        pc._transceive(pc.transceivers[sdpMLineIndex],\n            false,\n            isNewTrack);\n      } else if (description.type === 'answer' && !rejected) {\n        transceiver = pc.transceivers[sdpMLineIndex];\n        iceGatherer = transceiver.iceGatherer;\n        iceTransport = transceiver.iceTransport;\n        dtlsTransport = transceiver.dtlsTransport;\n        rtpReceiver = transceiver.rtpReceiver;\n        sendEncodingParameters = transceiver.sendEncodingParameters;\n        localCapabilities = transceiver.localCapabilities;\n\n        pc.transceivers[sdpMLineIndex].recvEncodingParameters =\n            recvEncodingParameters;\n        pc.transceivers[sdpMLineIndex].remoteCapabilities =\n            remoteCapabilities;\n        pc.transceivers[sdpMLineIndex].rtcpParameters = rtcpParameters;\n\n        if (cands.length && iceTransport.state === 'new') {\n          if ((isIceLite || isComplete) &&\n              (!usingBundle || sdpMLineIndex === 0)) {\n            iceTransport.setRemoteCandidates(cands);\n          } else {\n            cands.forEach(function(candidate) {\n              maybeAddCandidate(transceiver.iceTransport, candidate);\n            });\n          }\n        }\n\n        if (!usingBundle || sdpMLineIndex === 0) {\n          if (iceTransport.state === 'new') {\n            iceTransport.start(iceGatherer, remoteIceParameters,\n                'controlling');\n          }\n          if (dtlsTransport.state === 'new') {\n            dtlsTransport.start(remoteDtlsParameters);\n          }\n        }\n\n        pc._transceive(transceiver,\n            direction === 'sendrecv' || direction === 'recvonly',\n            direction === 'sendrecv' || direction === 'sendonly');\n\n        // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams\n        if (rtpReceiver &&\n            (direction === 'sendrecv' || direction === 'sendonly')) {\n          track = rtpReceiver.track;\n          if (remoteMsid) {\n            if (!streams[remoteMsid.stream]) {\n              streams[remoteMsid.stream] = new window.MediaStream();\n            }\n            addTrackToStreamAndFireEvent(track, streams[remoteMsid.stream]);\n            receiverList.push([track, rtpReceiver, streams[remoteMsid.stream]]);\n          } else {\n            if (!streams.default) {\n              streams.default = new window.MediaStream();\n            }\n            addTrackToStreamAndFireEvent(track, streams.default);\n            receiverList.push([track, rtpReceiver, streams.default]);\n          }\n        } else {\n          // FIXME: actually the receiver should be created later.\n          delete transceiver.rtpReceiver;\n        }\n      }\n    });\n\n    if (pc._dtlsRole === undefined) {\n      pc._dtlsRole = description.type === 'offer' ? 'active' : 'passive';\n    }\n\n    pc.remoteDescription = {\n      type: description.type,\n      sdp: description.sdp\n    };\n    if (description.type === 'offer') {\n      pc._updateSignalingState('have-remote-offer');\n    } else {\n      pc._updateSignalingState('stable');\n    }\n    Object.keys(streams).forEach(function(sid) {\n      var stream = streams[sid];\n      if (stream.getTracks().length) {\n        if (pc.remoteStreams.indexOf(stream) === -1) {\n          pc.remoteStreams.push(stream);\n          var event = new Event('addstream');\n          event.stream = stream;\n          window.setTimeout(function() {\n            pc._dispatchEvent('addstream', event);\n          });\n        }\n\n        receiverList.forEach(function(item) {\n          var track = item[0];\n          var receiver = item[1];\n          if (stream.id !== item[2].id) {\n            return;\n          }\n          fireAddTrack(pc, track, receiver, [stream]);\n        });\n      }\n    });\n    receiverList.forEach(function(item) {\n      if (item[2]) {\n        return;\n      }\n      fireAddTrack(pc, item[0], item[1], []);\n    });\n\n    // check whether addIceCandidate({}) was called within four seconds after\n    // setRemoteDescription.\n    window.setTimeout(function() {\n      if (!(pc && pc.transceivers)) {\n        return;\n      }\n      pc.transceivers.forEach(function(transceiver) {\n        if (transceiver.iceTransport &&\n            transceiver.iceTransport.state === 'new' &&\n            transceiver.iceTransport.getRemoteCandidates().length > 0) {\n          console.warn('Timeout for addRemoteCandidate. Consider sending ' +\n              'an end-of-candidates notification');\n          transceiver.iceTransport.addRemoteCandidate({});\n        }\n      });\n    }, 4000);\n\n    return Promise.resolve();\n  };\n\n  RTCPeerConnection.prototype.close = function() {\n    this.transceivers.forEach(function(transceiver) {\n      /* not yet\n      if (transceiver.iceGatherer) {\n        transceiver.iceGatherer.close();\n      }\n      */\n      if (transceiver.iceTransport) {\n        transceiver.iceTransport.stop();\n      }\n      if (transceiver.dtlsTransport) {\n        transceiver.dtlsTransport.stop();\n      }\n      if (transceiver.rtpSender) {\n        transceiver.rtpSender.stop();\n      }\n      if (transceiver.rtpReceiver) {\n        transceiver.rtpReceiver.stop();\n      }\n    });\n    // FIXME: clean up tracks, local streams, remote streams, etc\n    this._isClosed = true;\n    this._updateSignalingState('closed');\n  };\n\n  // Update the signaling state.\n  RTCPeerConnection.prototype._updateSignalingState = function(newState) {\n    this.signalingState = newState;\n    var event = new Event('signalingstatechange');\n    this._dispatchEvent('signalingstatechange', event);\n  };\n\n  // Determine whether to fire the negotiationneeded event.\n  RTCPeerConnection.prototype._maybeFireNegotiationNeeded = function() {\n    var pc = this;\n    if (this.signalingState !== 'stable' || this.needNegotiation === true) {\n      return;\n    }\n    this.needNegotiation = true;\n    window.setTimeout(function() {\n      if (pc.needNegotiation) {\n        pc.needNegotiation = false;\n        var event = new Event('negotiationneeded');\n        pc._dispatchEvent('negotiationneeded', event);\n      }\n    }, 0);\n  };\n\n  // Update the connection state.\n  RTCPeerConnection.prototype._updateConnectionState = function() {\n    var newState;\n    var states = {\n      'new': 0,\n      closed: 0,\n      connecting: 0,\n      checking: 0,\n      connected: 0,\n      completed: 0,\n      disconnected: 0,\n      failed: 0\n    };\n    this.transceivers.forEach(function(transceiver) {\n      states[transceiver.iceTransport.state]++;\n      states[transceiver.dtlsTransport.state]++;\n    });\n    // ICETransport.completed and connected are the same for this purpose.\n    states.connected += states.completed;\n\n    newState = 'new';\n    if (states.failed > 0) {\n      newState = 'failed';\n    } else if (states.connecting > 0 || states.checking > 0) {\n      newState = 'connecting';\n    } else if (states.disconnected > 0) {\n      newState = 'disconnected';\n    } else if (states.new > 0) {\n      newState = 'new';\n    } else if (states.connected > 0 || states.completed > 0) {\n      newState = 'connected';\n    }\n\n    if (newState !== this.iceConnectionState) {\n      this.iceConnectionState = newState;\n      var event = new Event('iceconnectionstatechange');\n      this._dispatchEvent('iceconnectionstatechange', event);\n    }\n  };\n\n  RTCPeerConnection.prototype.createOffer = function() {\n    var pc = this;\n\n    if (pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError',\n          'Can not call createOffer after close'));\n    }\n\n    var numAudioTracks = pc.transceivers.filter(function(t) {\n      return t.kind === 'audio';\n    }).length;\n    var numVideoTracks = pc.transceivers.filter(function(t) {\n      return t.kind === 'video';\n    }).length;\n\n    // Determine number of audio and video tracks we need to send/recv.\n    var offerOptions = arguments[0];\n    if (offerOptions) {\n      // Reject Chrome legacy constraints.\n      if (offerOptions.mandatory || offerOptions.optional) {\n        throw new TypeError(\n            'Legacy mandatory/optional constraints not supported.');\n      }\n      if (offerOptions.offerToReceiveAudio !== undefined) {\n        if (offerOptions.offerToReceiveAudio === true) {\n          numAudioTracks = 1;\n        } else if (offerOptions.offerToReceiveAudio === false) {\n          numAudioTracks = 0;\n        } else {\n          numAudioTracks = offerOptions.offerToReceiveAudio;\n        }\n      }\n      if (offerOptions.offerToReceiveVideo !== undefined) {\n        if (offerOptions.offerToReceiveVideo === true) {\n          numVideoTracks = 1;\n        } else if (offerOptions.offerToReceiveVideo === false) {\n          numVideoTracks = 0;\n        } else {\n          numVideoTracks = offerOptions.offerToReceiveVideo;\n        }\n      }\n    }\n\n    pc.transceivers.forEach(function(transceiver) {\n      if (transceiver.kind === 'audio') {\n        numAudioTracks--;\n        if (numAudioTracks < 0) {\n          transceiver.wantReceive = false;\n        }\n      } else if (transceiver.kind === 'video') {\n        numVideoTracks--;\n        if (numVideoTracks < 0) {\n          transceiver.wantReceive = false;\n        }\n      }\n    });\n\n    // Create M-lines for recvonly streams.\n    while (numAudioTracks > 0 || numVideoTracks > 0) {\n      if (numAudioTracks > 0) {\n        pc._createTransceiver('audio');\n        numAudioTracks--;\n      }\n      if (numVideoTracks > 0) {\n        pc._createTransceiver('video');\n        numVideoTracks--;\n      }\n    }\n\n    var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,\n        pc._sdpSessionVersion++);\n    pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {\n      // For each track, create an ice gatherer, ice transport,\n      // dtls transport, potentially rtpsender and rtpreceiver.\n      var track = transceiver.track;\n      var kind = transceiver.kind;\n      var mid = transceiver.mid || SDPUtils.generateIdentifier();\n      transceiver.mid = mid;\n\n      if (!transceiver.iceGatherer) {\n        transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex,\n            pc.usingBundle);\n      }\n\n      var localCapabilities = window.RTCRtpSender.getCapabilities(kind);\n      // filter RTX until additional stuff needed for RTX is implemented\n      // in adapter.js\n      if (edgeVersion < 15019) {\n        localCapabilities.codecs = localCapabilities.codecs.filter(\n            function(codec) {\n              return codec.name !== 'rtx';\n            });\n      }\n      localCapabilities.codecs.forEach(function(codec) {\n        // work around https://bugs.chromium.org/p/webrtc/issues/detail?id=6552\n        // by adding level-asymmetry-allowed=1\n        if (codec.name === 'H264' &&\n            codec.parameters['level-asymmetry-allowed'] === undefined) {\n          codec.parameters['level-asymmetry-allowed'] = '1';\n        }\n\n        // for subsequent offers, we might have to re-use the payload\n        // type of the last offer.\n        if (transceiver.remoteCapabilities &&\n            transceiver.remoteCapabilities.codecs) {\n          transceiver.remoteCapabilities.codecs.forEach(function(remoteCodec) {\n            if (codec.name.toLowerCase() === remoteCodec.name.toLowerCase() &&\n                codec.clockRate === remoteCodec.clockRate) {\n              codec.preferredPayloadType = remoteCodec.payloadType;\n            }\n          });\n        }\n      });\n      localCapabilities.headerExtensions.forEach(function(hdrExt) {\n        var remoteExtensions = transceiver.remoteCapabilities &&\n            transceiver.remoteCapabilities.headerExtensions || [];\n        remoteExtensions.forEach(function(rHdrExt) {\n          if (hdrExt.uri === rHdrExt.uri) {\n            hdrExt.id = rHdrExt.id;\n          }\n        });\n      });\n\n      // generate an ssrc now, to be used later in rtpSender.send\n      var sendEncodingParameters = transceiver.sendEncodingParameters || [{\n        ssrc: (2 * sdpMLineIndex + 1) * 1001\n      }];\n      if (track) {\n        // add RTX\n        if (edgeVersion >= 15019 && kind === 'video' &&\n            !sendEncodingParameters[0].rtx) {\n          sendEncodingParameters[0].rtx = {\n            ssrc: sendEncodingParameters[0].ssrc + 1\n          };\n        }\n      }\n\n      if (transceiver.wantReceive) {\n        transceiver.rtpReceiver = new window.RTCRtpReceiver(\n            transceiver.dtlsTransport, kind);\n      }\n\n      transceiver.localCapabilities = localCapabilities;\n      transceiver.sendEncodingParameters = sendEncodingParameters;\n    });\n\n    // always offer BUNDLE and dispose on return if not supported.\n    if (pc._config.bundlePolicy !== 'max-compat') {\n      sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function(t) {\n        return t.mid;\n      }).join(' ') + '\\r\\n';\n    }\n    sdp += 'a=ice-options:trickle\\r\\n';\n\n    pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {\n      sdp += writeMediaSection(transceiver, transceiver.localCapabilities,\n          'offer', transceiver.stream, pc._dtlsRole);\n      sdp += 'a=rtcp-rsize\\r\\n';\n\n      if (transceiver.iceGatherer && pc.iceGatheringState !== 'new' &&\n          (sdpMLineIndex === 0 || !pc.usingBundle)) {\n        transceiver.iceGatherer.getLocalCandidates().forEach(function(cand) {\n          cand.component = 1;\n          sdp += 'a=' + SDPUtils.writeCandidate(cand) + '\\r\\n';\n        });\n\n        if (transceiver.iceGatherer.state === 'completed') {\n          sdp += 'a=end-of-candidates\\r\\n';\n        }\n      }\n    });\n\n    var desc = new window.RTCSessionDescription({\n      type: 'offer',\n      sdp: sdp\n    });\n    return Promise.resolve(desc);\n  };\n\n  RTCPeerConnection.prototype.createAnswer = function() {\n    var pc = this;\n\n    if (pc._isClosed) {\n      return Promise.reject(makeError('InvalidStateError',\n          'Can not call createAnswer after close'));\n    }\n\n    var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,\n        pc._sdpSessionVersion++);\n    if (pc.usingBundle) {\n      sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function(t) {\n        return t.mid;\n      }).join(' ') + '\\r\\n';\n    }\n    var mediaSectionsInOffer = SDPUtils.getMediaSections(\n        pc.remoteDescription.sdp).length;\n    pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {\n      if (sdpMLineIndex + 1 > mediaSectionsInOffer) {\n        return;\n      }\n      if (transceiver.isDatachannel) {\n        sdp += 'm=application 0 DTLS/SCTP 5000\\r\\n' +\n            'c=IN IP4 0.0.0.0\\r\\n' +\n            'a=mid:' + transceiver.mid + '\\r\\n';\n        return;\n      }\n\n      // FIXME: look at direction.\n      if (transceiver.stream) {\n        var localTrack;\n        if (transceiver.kind === 'audio') {\n          localTrack = transceiver.stream.getAudioTracks()[0];\n        } else if (transceiver.kind === 'video') {\n          localTrack = transceiver.stream.getVideoTracks()[0];\n        }\n        if (localTrack) {\n          // add RTX\n          if (edgeVersion >= 15019 && transceiver.kind === 'video' &&\n              !transceiver.sendEncodingParameters[0].rtx) {\n            transceiver.sendEncodingParameters[0].rtx = {\n              ssrc: transceiver.sendEncodingParameters[0].ssrc + 1\n            };\n          }\n        }\n      }\n\n      // Calculate intersection of capabilities.\n      var commonCapabilities = getCommonCapabilities(\n          transceiver.localCapabilities,\n          transceiver.remoteCapabilities);\n\n      var hasRtx = commonCapabilities.codecs.filter(function(c) {\n        return c.name.toLowerCase() === 'rtx';\n      }).length;\n      if (!hasRtx && transceiver.sendEncodingParameters[0].rtx) {\n        delete transceiver.sendEncodingParameters[0].rtx;\n      }\n\n      sdp += writeMediaSection(transceiver, commonCapabilities,\n          'answer', transceiver.stream, pc._dtlsRole);\n      if (transceiver.rtcpParameters &&\n          transceiver.rtcpParameters.reducedSize) {\n        sdp += 'a=rtcp-rsize\\r\\n';\n      }\n    });\n\n    var desc = new window.RTCSessionDescription({\n      type: 'answer',\n      sdp: sdp\n    });\n    return Promise.resolve(desc);\n  };\n\n  RTCPeerConnection.prototype.addIceCandidate = function(candidate) {\n    var pc = this;\n    var sections;\n    if (candidate && !(candidate.sdpMLineIndex !== undefined ||\n        candidate.sdpMid)) {\n      return Promise.reject(new TypeError('sdpMLineIndex or sdpMid required'));\n    }\n\n    // TODO: needs to go into ops queue.\n    return new Promise(function(resolve, reject) {\n      if (!pc.remoteDescription) {\n        return reject(makeError('InvalidStateError',\n            'Can not add ICE candidate without a remote description'));\n      } else if (!candidate || candidate.candidate === '') {\n        for (var j = 0; j < pc.transceivers.length; j++) {\n          if (pc.transceivers[j].isDatachannel) {\n            continue;\n          }\n          pc.transceivers[j].iceTransport.addRemoteCandidate({});\n          sections = SDPUtils.getMediaSections(pc.remoteDescription.sdp);\n          sections[j] += 'a=end-of-candidates\\r\\n';\n          pc.remoteDescription.sdp =\n              SDPUtils.getDescription(pc.remoteDescription.sdp) +\n              sections.join('');\n          if (pc.usingBundle) {\n            break;\n          }\n        }\n      } else {\n        var sdpMLineIndex = candidate.sdpMLineIndex;\n        if (candidate.sdpMid) {\n          for (var i = 0; i < pc.transceivers.length; i++) {\n            if (pc.transceivers[i].mid === candidate.sdpMid) {\n              sdpMLineIndex = i;\n              break;\n            }\n          }\n        }\n        var transceiver = pc.transceivers[sdpMLineIndex];\n        if (transceiver) {\n          if (transceiver.isDatachannel) {\n            return resolve();\n          }\n          var cand = Object.keys(candidate.candidate).length > 0 ?\n              SDPUtils.parseCandidate(candidate.candidate) : {};\n          // Ignore Chrome's invalid candidates since Edge does not like them.\n          if (cand.protocol === 'tcp' && (cand.port === 0 || cand.port === 9)) {\n            return resolve();\n          }\n          // Ignore RTCP candidates, we assume RTCP-MUX.\n          if (cand.component && cand.component !== 1) {\n            return resolve();\n          }\n          // when using bundle, avoid adding candidates to the wrong\n          // ice transport. And avoid adding candidates added in the SDP.\n          if (sdpMLineIndex === 0 || (sdpMLineIndex > 0 &&\n              transceiver.iceTransport !== pc.transceivers[0].iceTransport)) {\n            if (!maybeAddCandidate(transceiver.iceTransport, cand)) {\n              return reject(makeError('OperationError',\n                  'Can not add ICE candidate'));\n            }\n          }\n\n          // update the remoteDescription.\n          var candidateString = candidate.candidate.trim();\n          if (candidateString.indexOf('a=') === 0) {\n            candidateString = candidateString.substr(2);\n          }\n          sections = SDPUtils.getMediaSections(pc.remoteDescription.sdp);\n          sections[sdpMLineIndex] += 'a=' +\n              (cand.type ? candidateString : 'end-of-candidates')\n              + '\\r\\n';\n          pc.remoteDescription.sdp = sections.join('');\n        } else {\n          return reject(makeError('OperationError',\n              'Can not add ICE candidate'));\n        }\n      }\n      resolve();\n    });\n  };\n\n  RTCPeerConnection.prototype.getStats = function() {\n    var promises = [];\n    this.transceivers.forEach(function(transceiver) {\n      ['rtpSender', 'rtpReceiver', 'iceGatherer', 'iceTransport',\n          'dtlsTransport'].forEach(function(method) {\n            if (transceiver[method]) {\n              promises.push(transceiver[method].getStats());\n            }\n          });\n    });\n    var fixStatsType = function(stat) {\n      return {\n        inboundrtp: 'inbound-rtp',\n        outboundrtp: 'outbound-rtp',\n        candidatepair: 'candidate-pair',\n        localcandidate: 'local-candidate',\n        remotecandidate: 'remote-candidate'\n      }[stat.type] || stat.type;\n    };\n    return new Promise(function(resolve) {\n      // shim getStats with maplike support\n      var results = new Map();\n      Promise.all(promises).then(function(res) {\n        res.forEach(function(result) {\n          Object.keys(result).forEach(function(id) {\n            result[id].type = fixStatsType(result[id]);\n            results.set(id, result[id]);\n          });\n        });\n        resolve(results);\n      });\n    });\n  };\n\n  // legacy callback shims. Should be moved to adapter.js some days.\n  var methods = ['createOffer', 'createAnswer'];\n  methods.forEach(function(method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n    RTCPeerConnection.prototype[method] = function() {\n      var args = arguments;\n      if (typeof args[0] === 'function' ||\n          typeof args[1] === 'function') { // legacy\n        return nativeMethod.apply(this, [arguments[2]])\n        .then(function(description) {\n          if (typeof args[0] === 'function') {\n            args[0].apply(null, [description]);\n          }\n        }, function(error) {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null, [error]);\n          }\n        });\n      }\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n\n  methods = ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate'];\n  methods.forEach(function(method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n    RTCPeerConnection.prototype[method] = function() {\n      var args = arguments;\n      if (typeof args[1] === 'function' ||\n          typeof args[2] === 'function') { // legacy\n        return nativeMethod.apply(this, arguments)\n        .then(function() {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null);\n          }\n        }, function(error) {\n          if (typeof args[2] === 'function') {\n            args[2].apply(null, [error]);\n          }\n        });\n      }\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n\n  // getStats is special. It doesn't have a spec legacy method yet we support\n  // getStats(something, cb) without error callbacks.\n  ['getStats'].forEach(function(method) {\n    var nativeMethod = RTCPeerConnection.prototype[method];\n    RTCPeerConnection.prototype[method] = function() {\n      var args = arguments;\n      if (typeof args[1] === 'function') {\n        return nativeMethod.apply(this, arguments)\n        .then(function() {\n          if (typeof args[1] === 'function') {\n            args[1].apply(null);\n          }\n        });\n      }\n      return nativeMethod.apply(this, arguments);\n    };\n  });\n\n  return RTCPeerConnection;\n};\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;AACC;AACD;;AAEA,IAAIA,QAAQ,GAAGC,OAAO,CAAC,KAAD,CAAtB;;AAEA,SAASC,iBAAT,CAA2BC,WAA3B,EAAwCC,IAAxC,EAA8CC,IAA9C,EAAoDC,MAApD,EAA4DC,QAA5D,EAAsE;EACpE,IAAIC,GAAG,GAAGR,QAAQ,CAACS,mBAAT,CAA6BN,WAAW,CAACO,IAAzC,EAA+CN,IAA/C,CAAV,CADoE,CAGpE;;EACAI,GAAG,IAAIR,QAAQ,CAACW,kBAAT,CACHR,WAAW,CAACS,WAAZ,CAAwBC,kBAAxB,EADG,CAAP,CAJoE,CAOpE;;EACAL,GAAG,IAAIR,QAAQ,CAACc,mBAAT,CACHX,WAAW,CAACY,aAAZ,CAA0BF,kBAA1B,EADG,EAEHR,IAAI,KAAK,OAAT,GAAmB,SAAnB,GAA+BE,QAAQ,IAAI,QAFxC,CAAP;EAIAC,GAAG,IAAI,WAAWL,WAAW,CAACa,GAAvB,GAA6B,MAApC;;EAEA,IAAIb,WAAW,CAACc,SAAZ,IAAyBd,WAAW,CAACe,WAAzC,EAAsD;IACpDV,GAAG,IAAI,gBAAP;EACD,CAFD,MAEO,IAAIL,WAAW,CAACc,SAAhB,EAA2B;IAChCT,GAAG,IAAI,gBAAP;EACD,CAFM,MAEA,IAAIL,WAAW,CAACe,WAAhB,EAA6B;IAClCV,GAAG,IAAI,gBAAP;EACD,CAFM,MAEA;IACLA,GAAG,IAAI,gBAAP;EACD;;EAED,IAAIL,WAAW,CAACc,SAAhB,EAA2B;IACzB,IAAIE,OAAO,GAAGhB,WAAW,CAACc,SAAZ,CAAsBG,eAAtB,IACVjB,WAAW,CAACc,SAAZ,CAAsBI,KAAtB,CAA4BC,EADhC;IAEAnB,WAAW,CAACc,SAAZ,CAAsBG,eAAtB,GAAwCD,OAAxC,CAHyB,CAIzB;;IACA,IAAII,IAAI,GAAG,WAAWjB,MAAM,GAAGA,MAAM,CAACgB,EAAV,GAAe,GAAhC,IAAuC,GAAvC,GACPH,OADO,GACG,MADd;IAEAX,GAAG,IAAI,OAAOe,IAAd,CAPyB,CAQzB;;IACAf,GAAG,IAAI,YAAYL,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCC,IAAlD,GACH,GADG,GACGF,IADV,CATyB,CAYzB;;IACA,IAAIpB,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCE,GAA1C,EAA+C;MAC7ClB,GAAG,IAAI,YAAYL,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCE,GAAtC,CAA0CD,IAAtD,GACH,GADG,GACGF,IADV;MAEAf,GAAG,IAAI,sBACHL,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCC,IADnC,GAC0C,GAD1C,GAEHtB,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCE,GAAtC,CAA0CD,IAFvC,GAGH,MAHJ;IAID;EACF,CA7CmE,CA8CpE;;;EACAjB,GAAG,IAAI,YAAYL,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCC,IAAlD,GACH,SADG,GACSzB,QAAQ,CAAC2B,UADlB,GAC+B,MADtC;;EAEA,IAAIxB,WAAW,CAACc,SAAZ,IAAyBd,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCE,GAAnE,EAAwE;IACtElB,GAAG,IAAI,YAAYL,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCE,GAAtC,CAA0CD,IAAtD,GACH,SADG,GACSzB,QAAQ,CAAC2B,UADlB,GAC+B,MADtC;EAED;;EACD,OAAOnB,GAAP;AACD,C,CAED;AACA;AACA;AACA;AACA;;;AACA,SAASoB,gBAAT,CAA0BC,UAA1B,EAAsCC,WAAtC,EAAmD;EACjD,IAAIC,OAAO,GAAG,KAAd;EACAF,UAAU,GAAGG,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAeL,UAAf,CAAX,CAAb;EACA,OAAOA,UAAU,CAACM,MAAX,CAAkB,UAASC,MAAT,EAAiB;IACxC,IAAIA,MAAM,KAAKA,MAAM,CAACC,IAAP,IAAeD,MAAM,CAACE,GAA3B,CAAV,EAA2C;MACzC,IAAID,IAAI,GAAGD,MAAM,CAACC,IAAP,IAAeD,MAAM,CAACE,GAAjC;;MACA,IAAIF,MAAM,CAACE,GAAP,IAAc,CAACF,MAAM,CAACC,IAA1B,EAAgC;QAC9BE,OAAO,CAACC,IAAR,CAAa,mDAAb;MACD;;MACD,IAAIC,QAAQ,GAAG,OAAOJ,IAAP,KAAgB,QAA/B;;MACA,IAAII,QAAJ,EAAc;QACZJ,IAAI,GAAG,CAACA,IAAD,CAAP;MACD;;MACDA,IAAI,GAAGA,IAAI,CAACF,MAAL,CAAY,UAASG,GAAT,EAAc;QAC/B,IAAII,SAAS,GAAGJ,GAAG,CAACK,OAAJ,CAAY,OAAZ,MAAyB,CAAzB,IACZL,GAAG,CAACK,OAAJ,CAAY,eAAZ,MAAiC,CAAC,CADtB,IAEZL,GAAG,CAACK,OAAJ,CAAY,QAAZ,MAA0B,CAAC,CAFf,IAGZ,CAACZ,OAHL;;QAKA,IAAIW,SAAJ,EAAe;UACbX,OAAO,GAAG,IAAV;UACA,OAAO,IAAP;QACD;;QACD,OAAOO,GAAG,CAACK,OAAJ,CAAY,OAAZ,MAAyB,CAAzB,IAA8Bb,WAAW,IAAI,KAA7C,IACHQ,GAAG,CAACK,OAAJ,CAAY,gBAAZ,MAAkC,CAAC,CADvC;MAED,CAZM,CAAP;MAcA,OAAOP,MAAM,CAACE,GAAd;MACAF,MAAM,CAACC,IAAP,GAAcI,QAAQ,GAAGJ,IAAI,CAAC,CAAD,CAAP,GAAaA,IAAnC;MACA,OAAO,CAAC,CAACA,IAAI,CAACO,MAAd;IACD;EACF,CA5BM,CAAP;AA6BD,C,CAED;;;AACA,SAASC,qBAAT,CAA+BC,iBAA/B,EAAkDC,kBAAlD,EAAsE;EACpE,IAAIC,kBAAkB,GAAG;IACvBC,MAAM,EAAE,EADe;IAEvBC,gBAAgB,EAAE,EAFK;IAGvBC,aAAa,EAAE;EAHQ,CAAzB;;EAMA,IAAIC,sBAAsB,GAAG,UAASC,EAAT,EAAaJ,MAAb,EAAqB;IAChDI,EAAE,GAAGC,QAAQ,CAACD,EAAD,EAAK,EAAL,CAAb;;IACA,KAAK,IAAIE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGN,MAAM,CAACL,MAA3B,EAAmCW,CAAC,EAApC,EAAwC;MACtC,IAAIN,MAAM,CAACM,CAAD,CAAN,CAAUC,WAAV,KAA0BH,EAA1B,IACAJ,MAAM,CAACM,CAAD,CAAN,CAAUE,oBAAV,KAAmCJ,EADvC,EAC2C;QACzC,OAAOJ,MAAM,CAACM,CAAD,CAAb;MACD;IACF;EACF,CARD;;EAUA,IAAIG,oBAAoB,GAAG,UAASC,IAAT,EAAeC,IAAf,EAAqBC,OAArB,EAA8BC,OAA9B,EAAuC;IAChE,IAAIC,MAAM,GAAGX,sBAAsB,CAACO,IAAI,CAACK,UAAL,CAAgBC,GAAjB,EAAsBJ,OAAtB,CAAnC;IACA,IAAIK,MAAM,GAAGd,sBAAsB,CAACQ,IAAI,CAACI,UAAL,CAAgBC,GAAjB,EAAsBH,OAAtB,CAAnC;IACA,OAAOC,MAAM,IAAIG,MAAV,IACHH,MAAM,CAACI,IAAP,CAAYC,WAAZ,OAA8BF,MAAM,CAACC,IAAP,CAAYC,WAAZ,EADlC;EAED,CALD;;EAOAtB,iBAAiB,CAACG,MAAlB,CAAyBoB,OAAzB,CAAiC,UAASN,MAAT,EAAiB;IAChD,KAAK,IAAIR,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGR,kBAAkB,CAACE,MAAnB,CAA0BL,MAA9C,EAAsDW,CAAC,EAAvD,EAA2D;MACzD,IAAIW,MAAM,GAAGnB,kBAAkB,CAACE,MAAnB,CAA0BM,CAA1B,CAAb;;MACA,IAAIQ,MAAM,CAACI,IAAP,CAAYC,WAAZ,OAA8BF,MAAM,CAACC,IAAP,CAAYC,WAAZ,EAA9B,IACAL,MAAM,CAACO,SAAP,KAAqBJ,MAAM,CAACI,SADhC,EAC2C;QACzC,IAAIP,MAAM,CAACI,IAAP,CAAYC,WAAZ,OAA8B,KAA9B,IACAL,MAAM,CAACC,UADP,IACqBE,MAAM,CAACF,UAAP,CAAkBC,GAD3C,EACgD;UAC9C;UACA;UACA,IAAI,CAACP,oBAAoB,CAACK,MAAD,EAASG,MAAT,EACrBpB,iBAAiB,CAACG,MADG,EACKF,kBAAkB,CAACE,MADxB,CAAzB,EAC0D;YACxD;UACD;QACF;;QACDiB,MAAM,GAAGlC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAegC,MAAf,CAAX,CAAT,CAVyC,CAUI;QAC7C;;QACAA,MAAM,CAACK,WAAP,GAAqBC,IAAI,CAACC,GAAL,CAASV,MAAM,CAACQ,WAAhB,EACjBL,MAAM,CAACK,WADU,CAArB,CAZyC,CAczC;;QACAvB,kBAAkB,CAACC,MAAnB,CAA0ByB,IAA1B,CAA+BR,MAA/B,EAfyC,CAiBzC;;QACAA,MAAM,CAACS,YAAP,GAAsBT,MAAM,CAACS,YAAP,CAAoBxC,MAApB,CAA2B,UAASyC,EAAT,EAAa;UAC5D,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGd,MAAM,CAACY,YAAP,CAAoB/B,MAAxC,EAAgDiC,CAAC,EAAjD,EAAqD;YACnD,IAAId,MAAM,CAACY,YAAP,CAAoBE,CAApB,EAAuBxE,IAAvB,KAAgCuE,EAAE,CAACvE,IAAnC,IACA0D,MAAM,CAACY,YAAP,CAAoBE,CAApB,EAAuBC,SAAvB,KAAqCF,EAAE,CAACE,SAD5C,EACuD;cACrD,OAAO,IAAP;YACD;UACF;;UACD,OAAO,KAAP;QACD,CARqB,CAAtB,CAlByC,CA2BzC;QACA;;QACA;MACD;IACF;EACF,CApCD;EAsCAhC,iBAAiB,CAACI,gBAAlB,CAAmCmB,OAAnC,CAA2C,UAASU,gBAAT,EAA2B;IACpE,KAAK,IAAIxB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGR,kBAAkB,CAACG,gBAAnB,CAAoCN,MAAxD,EACKW,CAAC,EADN,EACU;MACR,IAAIyB,gBAAgB,GAAGjC,kBAAkB,CAACG,gBAAnB,CAAoCK,CAApC,CAAvB;;MACA,IAAIwB,gBAAgB,CAACE,GAAjB,KAAyBD,gBAAgB,CAACC,GAA9C,EAAmD;QACjDjC,kBAAkB,CAACE,gBAAnB,CAAoCwB,IAApC,CAAyCM,gBAAzC;QACA;MACD;IACF;EACF,CATD,EA9DoE,CAyEpE;;EACA,OAAOhC,kBAAP;AACD,C,CAED;;;AACA,SAASkC,+BAAT,CAAyCC,MAAzC,EAAiD9E,IAAjD,EAAuD+E,cAAvD,EAAuE;EACrE,OAAO;IACLC,KAAK,EAAE;MACLC,mBAAmB,EAAE,CAAC,QAAD,EAAW,kBAAX,CADhB;MAELC,oBAAoB,EAAE,CAAC,QAAD,EAAW,mBAAX;IAFjB,CADF;IAKLC,MAAM,EAAE;MACNF,mBAAmB,EAAE,CAAC,mBAAD,EAAsB,qBAAtB,CADf;MAENC,oBAAoB,EAAE,CAAC,kBAAD,EAAqB,sBAArB;IAFhB;EALH,EASLlF,IATK,EASC8E,MATD,EASSxC,OATT,CASiByC,cATjB,MASqC,CAAC,CAT7C;AAUD;;AAED,SAASK,iBAAT,CAA2BC,YAA3B,EAAyCC,SAAzC,EAAoD;EAClD;EACA;EACA,IAAIC,YAAY,GAAGF,YAAY,CAACG,mBAAb,GACdC,IADc,CACT,UAASC,eAAT,EAA0B;IAC9B,OAAOJ,SAAS,CAACK,UAAV,KAAyBD,eAAe,CAACC,UAAzC,IACHL,SAAS,CAACM,EAAV,KAAiBF,eAAe,CAACE,EAD9B,IAEHN,SAAS,CAACO,IAAV,KAAmBH,eAAe,CAACG,IAFhC,IAGHP,SAAS,CAACQ,QAAV,KAAuBJ,eAAe,CAACI,QAHpC,IAIHR,SAAS,CAACS,QAAV,KAAuBL,eAAe,CAACK,QAJpC,IAKHT,SAAS,CAACtF,IAAV,KAAmB0F,eAAe,CAAC1F,IALvC;EAMD,CARc,CAAnB;;EASA,IAAI,CAACuF,YAAL,EAAmB;IACjBF,YAAY,CAACW,kBAAb,CAAgCV,SAAhC;EACD;;EACD,OAAO,CAACC,YAAR;AACD;;AAGD,SAASU,SAAT,CAAmBnC,IAAnB,EAAyBoC,WAAzB,EAAsC;EACpC,IAAIC,CAAC,GAAG,IAAIC,KAAJ,CAAUF,WAAV,CAAR;EACAC,CAAC,CAACrC,IAAF,GAASA,IAAT;EACA,OAAOqC,CAAP;AACD;;AAEDE,MAAM,CAACC,OAAP,GAAiB,UAASC,MAAT,EAAiB9E,WAAjB,EAA8B;EAC7C;EACA;EACA;EACA,SAAS+E,4BAAT,CAAsCxF,KAAtC,EAA6Cf,MAA7C,EAAqD;IACnDA,MAAM,CAACwG,QAAP,CAAgBzF,KAAhB;IACAf,MAAM,CAACyG,aAAP,CAAqB,IAAIH,MAAM,CAACI,qBAAX,CAAiC,UAAjC,EACjB;MAAC3F,KAAK,EAAEA;IAAR,CADiB,CAArB;EAED;;EAED,SAAS4F,iCAAT,CAA2C5F,KAA3C,EAAkDf,MAAlD,EAA0D;IACxDA,MAAM,CAAC4G,WAAP,CAAmB7F,KAAnB;IACAf,MAAM,CAACyG,aAAP,CAAqB,IAAIH,MAAM,CAACI,qBAAX,CAAiC,aAAjC,EACjB;MAAC3F,KAAK,EAAEA;IAAR,CADiB,CAArB;EAED;;EAED,SAAS8F,YAAT,CAAsBC,EAAtB,EAA0B/F,KAA1B,EAAiCgG,QAAjC,EAA2CC,OAA3C,EAAoD;IAClD,IAAIC,UAAU,GAAG,IAAIC,KAAJ,CAAU,OAAV,CAAjB;IACAD,UAAU,CAAClG,KAAX,GAAmBA,KAAnB;IACAkG,UAAU,CAACF,QAAX,GAAsBA,QAAtB;IACAE,UAAU,CAACpH,WAAX,GAAyB;MAACkH,QAAQ,EAAEA;IAAX,CAAzB;IACAE,UAAU,CAACD,OAAX,GAAqBA,OAArB;IACAV,MAAM,CAACa,UAAP,CAAkB,YAAW;MAC3BL,EAAE,CAACM,cAAH,CAAkB,OAAlB,EAA2BH,UAA3B;IACD,CAFD;EAGD;;EAED,IAAII,iBAAiB,GAAG,UAASC,MAAT,EAAiB;IACvC,IAAIR,EAAE,GAAG,IAAT;;IAEA,IAAIS,YAAY,GAAGC,QAAQ,CAACC,sBAAT,EAAnB;;IACA,CAAC,kBAAD,EAAqB,qBAArB,EAA4C,eAA5C,EACK1D,OADL,CACa,UAAS2D,MAAT,EAAiB;MACxBZ,EAAE,CAACY,MAAD,CAAF,GAAaH,YAAY,CAACG,MAAD,CAAZ,CAAqBC,IAArB,CAA0BJ,YAA1B,CAAb;IACD,CAHL;IAKA,KAAKK,uBAAL,GAA+B,IAA/B;IAEA,KAAKC,eAAL,GAAuB,KAAvB;IAEA,KAAKC,YAAL,GAAoB,EAApB;IACA,KAAKC,aAAL,GAAqB,EAArB;IAEA,KAAKC,gBAAL,GAAwB,IAAxB;IACA,KAAKC,iBAAL,GAAyB,IAAzB;IAEA,KAAKnD,cAAL,GAAsB,QAAtB;IACA,KAAKoD,kBAAL,GAA0B,KAA1B;IACA,KAAKC,iBAAL,GAAyB,KAAzB;IAEAb,MAAM,GAAG5F,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAe0F,MAAM,IAAI,EAAzB,CAAX,CAAT;IAEA,KAAKc,WAAL,GAAmBd,MAAM,CAACe,YAAP,KAAwB,YAA3C;;IACA,IAAIf,MAAM,CAACgB,aAAP,KAAyB,WAA7B,EAA0C;MACxC,MAAMtC,SAAS,CAAC,mBAAD,EACX,8CADW,CAAf;IAED,CAHD,MAGO,IAAI,CAACsB,MAAM,CAACgB,aAAZ,EAA2B;MAChChB,MAAM,CAACgB,aAAP,GAAuB,SAAvB;IACD;;IAED,QAAQhB,MAAM,CAACiB,kBAAf;MACE,KAAK,KAAL;MACA,KAAK,OAAL;QACE;;MACF;QACEjB,MAAM,CAACiB,kBAAP,GAA4B,KAA5B;QACA;IANJ;;IASA,QAAQjB,MAAM,CAACe,YAAf;MACE,KAAK,UAAL;MACA,KAAK,YAAL;MACA,KAAK,YAAL;QACE;;MACF;QACEf,MAAM,CAACe,YAAP,GAAsB,UAAtB;QACA;IAPJ;;IAUAf,MAAM,CAAC/F,UAAP,GAAoBD,gBAAgB,CAACgG,MAAM,CAAC/F,UAAP,IAAqB,EAAtB,EAA0BC,WAA1B,CAApC;IAEA,KAAKgH,aAAL,GAAqB,EAArB;;IACA,IAAIlB,MAAM,CAACmB,oBAAX,EAAiC;MAC/B,KAAK,IAAIxF,CAAC,GAAGqE,MAAM,CAACmB,oBAApB,EAA0CxF,CAAC,GAAG,CAA9C,EAAiDA,CAAC,EAAlD,EAAsD;QACpD,KAAKuF,aAAL,CAAmBpE,IAAnB,CAAwB,IAAIkC,MAAM,CAACoC,cAAX,CAA0B;UAChDnH,UAAU,EAAE+F,MAAM,CAAC/F,UAD6B;UAEhDoH,YAAY,EAAErB,MAAM,CAACiB;QAF2B,CAA1B,CAAxB;MAID;IACF,CAPD,MAOO;MACLjB,MAAM,CAACmB,oBAAP,GAA8B,CAA9B;IACD;;IAED,KAAKG,OAAL,GAAetB,MAAf,CAlEuC,CAoEvC;IACA;;IACA,KAAKuB,YAAL,GAAoB,EAApB;IAEA,KAAKC,aAAL,GAAqBpJ,QAAQ,CAACqJ,iBAAT,EAArB;IACA,KAAKC,kBAAL,GAA0B,CAA1B;IAEA,KAAKC,SAAL,GAAiBC,SAAjB,CA3EuC,CA2EX;;IAE5B,KAAKC,SAAL,GAAiB,KAAjB;EACD,CA9ED,CA3B6C,CA2G7C;;;EACA9B,iBAAiB,CAAC+B,SAAlB,CAA4BC,cAA5B,GAA6C,IAA7C;EACAhC,iBAAiB,CAAC+B,SAAlB,CAA4BE,WAA5B,GAA0C,IAA1C;EACAjC,iBAAiB,CAAC+B,SAAlB,CAA4BG,OAA5B,GAAsC,IAAtC;EACAlC,iBAAiB,CAAC+B,SAAlB,CAA4BI,cAA5B,GAA6C,IAA7C;EACAnC,iBAAiB,CAAC+B,SAAlB,CAA4BK,sBAA5B,GAAqD,IAArD;EACApC,iBAAiB,CAAC+B,SAAlB,CAA4BM,0BAA5B,GAAyD,IAAzD;EACArC,iBAAiB,CAAC+B,SAAlB,CAA4BO,yBAA5B,GAAwD,IAAxD;EACAtC,iBAAiB,CAAC+B,SAAlB,CAA4BQ,mBAA5B,GAAkD,IAAlD;EACAvC,iBAAiB,CAAC+B,SAAlB,CAA4BS,aAA5B,GAA4C,IAA5C;;EAEAxC,iBAAiB,CAAC+B,SAAlB,CAA4BhC,cAA5B,GAA6C,UAASvD,IAAT,EAAeiG,KAAf,EAAsB;IACjE,IAAI,KAAKX,SAAT,EAAoB;MAClB;IACD;;IACD,KAAK1C,aAAL,CAAmBqD,KAAnB;;IACA,IAAI,OAAO,KAAK,OAAOjG,IAAZ,CAAP,KAA6B,UAAjC,EAA6C;MAC3C,KAAK,OAAOA,IAAZ,EAAkBiG,KAAlB;IACD;EACF,CARD;;EAUAzC,iBAAiB,CAAC+B,SAAlB,CAA4BW,yBAA5B,GAAwD,YAAW;IACjE,IAAID,KAAK,GAAG,IAAI5C,KAAJ,CAAU,yBAAV,CAAZ;;IACA,KAAKE,cAAL,CAAoB,yBAApB,EAA+C0C,KAA/C;EACD,CAHD;;EAKAzC,iBAAiB,CAAC+B,SAAlB,CAA4BY,gBAA5B,GAA+C,YAAW;IACxD,OAAO,KAAKpB,OAAZ;EACD,CAFD;;EAIAvB,iBAAiB,CAAC+B,SAAlB,CAA4Ba,eAA5B,GAA8C,YAAW;IACvD,OAAO,KAAKnC,YAAZ;EACD,CAFD;;EAIAT,iBAAiB,CAAC+B,SAAlB,CAA4Bc,gBAA5B,GAA+C,YAAW;IACxD,OAAO,KAAKnC,aAAZ;EACD,CAFD,CA7I6C,CAiJ7C;EACA;;;EACAV,iBAAiB,CAAC+B,SAAlB,CAA4Be,kBAA5B,GAAiD,UAAS/J,IAAT,EAAe;IAC9D,IAAIgK,kBAAkB,GAAG,KAAKvB,YAAL,CAAkBvG,MAAlB,GAA2B,CAApD;IACA,IAAIzC,WAAW,GAAG;MAChBkB,KAAK,EAAE,IADS;MAEhBT,WAAW,EAAE,IAFG;MAGhB8E,YAAY,EAAE,IAHE;MAIhB3E,aAAa,EAAE,IAJC;MAKhB+B,iBAAiB,EAAE,IALH;MAMhBC,kBAAkB,EAAE,IANJ;MAOhB9B,SAAS,EAAE,IAPK;MAQhBC,WAAW,EAAE,IARG;MAShBR,IAAI,EAAEA,IATU;MAUhBM,GAAG,EAAE,IAVW;MAWhBQ,sBAAsB,EAAE,IAXR;MAYhBmJ,sBAAsB,EAAE,IAZR;MAahBrK,MAAM,EAAE,IAbQ;MAchBsK,4BAA4B,EAAE,EAdd;MAehBC,WAAW,EAAE;IAfG,CAAlB;;IAiBA,IAAI,KAAKnC,WAAL,IAAoBgC,kBAAxB,EAA4C;MAC1CvK,WAAW,CAACuF,YAAZ,GAA2B,KAAKyD,YAAL,CAAkB,CAAlB,EAAqBzD,YAAhD;MACAvF,WAAW,CAACY,aAAZ,GAA4B,KAAKoI,YAAL,CAAkB,CAAlB,EAAqBpI,aAAjD;IACD,CAHD,MAGO;MACL,IAAI+J,UAAU,GAAG,KAAKC,2BAAL,EAAjB;;MACA5K,WAAW,CAACuF,YAAZ,GAA2BoF,UAAU,CAACpF,YAAtC;MACAvF,WAAW,CAACY,aAAZ,GAA4B+J,UAAU,CAAC/J,aAAvC;IACD;;IACD,KAAKoI,YAAL,CAAkBzE,IAAlB,CAAuBvE,WAAvB;IACA,OAAOA,WAAP;EACD,CA7BD;;EA+BAwH,iBAAiB,CAAC+B,SAAlB,CAA4B5C,QAA5B,GAAuC,UAASzF,KAAT,EAAgBf,MAAhB,EAAwB;IAC7D,IAAI,KAAKmJ,SAAT,EAAoB;MAClB,MAAMnD,SAAS,CAAC,mBAAD,EACX,wDADW,CAAf;IAED;;IAED,IAAI0E,aAAa,GAAG,KAAK7B,YAAL,CAAkBrD,IAAlB,CAAuB,UAASmF,CAAT,EAAY;MACrD,OAAOA,CAAC,CAAC5J,KAAF,KAAYA,KAAnB;IACD,CAFmB,CAApB;;IAIA,IAAI2J,aAAJ,EAAmB;MACjB,MAAM1E,SAAS,CAAC,oBAAD,EAAuB,uBAAvB,CAAf;IACD;;IAED,IAAInG,WAAJ;;IACA,KAAK,IAAIoD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK4F,YAAL,CAAkBvG,MAAtC,EAA8CW,CAAC,EAA/C,EAAmD;MACjD,IAAI,CAAC,KAAK4F,YAAL,CAAkB5F,CAAlB,EAAqBlC,KAAtB,IACA,KAAK8H,YAAL,CAAkB5F,CAAlB,EAAqB7C,IAArB,KAA8BW,KAAK,CAACX,IADxC,EAC8C;QAC5CP,WAAW,GAAG,KAAKgJ,YAAL,CAAkB5F,CAAlB,CAAd;MACD;IACF;;IACD,IAAI,CAACpD,WAAL,EAAkB;MAChBA,WAAW,GAAG,KAAKsK,kBAAL,CAAwBpJ,KAAK,CAACX,IAA9B,CAAd;IACD;;IAED,KAAKwK,2BAAL;;IAEA,IAAI,KAAK9C,YAAL,CAAkBzF,OAAlB,CAA0BrC,MAA1B,MAAsC,CAAC,CAA3C,EAA8C;MAC5C,KAAK8H,YAAL,CAAkB1D,IAAlB,CAAuBpE,MAAvB;IACD;;IAEDH,WAAW,CAACkB,KAAZ,GAAoBA,KAApB;IACAlB,WAAW,CAACG,MAAZ,GAAqBA,MAArB;IACAH,WAAW,CAACc,SAAZ,GAAwB,IAAI2F,MAAM,CAACuE,YAAX,CAAwB9J,KAAxB,EACpBlB,WAAW,CAACY,aADQ,CAAxB;IAEA,OAAOZ,WAAW,CAACc,SAAnB;EACD,CApCD;;EAsCA0G,iBAAiB,CAAC+B,SAAlB,CAA4B0B,SAA5B,GAAwC,UAAS9K,MAAT,EAAiB;IACvD,IAAI8G,EAAE,GAAG,IAAT;;IACA,IAAItF,WAAW,IAAI,KAAnB,EAA0B;MACxBxB,MAAM,CAAC+K,SAAP,GAAmBhH,OAAnB,CAA2B,UAAShD,KAAT,EAAgB;QACzC+F,EAAE,CAACN,QAAH,CAAYzF,KAAZ,EAAmBf,MAAnB;MACD,CAFD;IAGD,CAJD,MAIO;MACL;MACA;MACA;MACA,IAAIgL,YAAY,GAAGhL,MAAM,CAACiL,KAAP,EAAnB;MACAjL,MAAM,CAAC+K,SAAP,GAAmBhH,OAAnB,CAA2B,UAAShD,KAAT,EAAgBmK,GAAhB,EAAqB;QAC9C,IAAIC,WAAW,GAAGH,YAAY,CAACD,SAAb,GAAyBG,GAAzB,CAAlB;QACAnK,KAAK,CAACqK,gBAAN,CAAuB,SAAvB,EAAkC,UAAStB,KAAT,EAAgB;UAChDqB,WAAW,CAACE,OAAZ,GAAsBvB,KAAK,CAACuB,OAA5B;QACD,CAFD;MAGD,CALD;MAMAL,YAAY,CAACD,SAAb,GAAyBhH,OAAzB,CAAiC,UAAShD,KAAT,EAAgB;QAC/C+F,EAAE,CAACN,QAAH,CAAYzF,KAAZ,EAAmBiK,YAAnB;MACD,CAFD;IAGD;EACF,CArBD;;EAuBA3D,iBAAiB,CAAC+B,SAAlB,CAA4BxC,WAA5B,GAA0C,UAAS0E,MAAT,EAAiB;IACzD,IAAI,KAAKnC,SAAT,EAAoB;MAClB,MAAMnD,SAAS,CAAC,mBAAD,EACX,2DADW,CAAf;IAED;;IAED,IAAI,EAAEsF,MAAM,YAAYhF,MAAM,CAACuE,YAA3B,CAAJ,EAA8C;MAC5C,MAAM,IAAIU,SAAJ,CAAc,iDAChB,4CADE,CAAN;IAED;;IAED,IAAI1L,WAAW,GAAG,KAAKgJ,YAAL,CAAkBrD,IAAlB,CAAuB,UAASgG,CAAT,EAAY;MACnD,OAAOA,CAAC,CAAC7K,SAAF,KAAgB2K,MAAvB;IACD,CAFiB,CAAlB;;IAIA,IAAI,CAACzL,WAAL,EAAkB;MAChB,MAAMmG,SAAS,CAAC,oBAAD,EACX,4CADW,CAAf;IAED;;IACD,IAAIhG,MAAM,GAAGH,WAAW,CAACG,MAAzB;IAEAH,WAAW,CAACc,SAAZ,CAAsB8K,IAAtB;IACA5L,WAAW,CAACc,SAAZ,GAAwB,IAAxB;IACAd,WAAW,CAACkB,KAAZ,GAAoB,IAApB;IACAlB,WAAW,CAACG,MAAZ,GAAqB,IAArB,CAxByD,CA0BzD;;IACA,IAAI8H,YAAY,GAAG,KAAKe,YAAL,CAAkB6C,GAAlB,CAAsB,UAASF,CAAT,EAAY;MACnD,OAAOA,CAAC,CAACxL,MAAT;IACD,CAFkB,CAAnB;;IAGA,IAAI8H,YAAY,CAACzF,OAAb,CAAqBrC,MAArB,MAAiC,CAAC,CAAlC,IACA,KAAK8H,YAAL,CAAkBzF,OAAlB,CAA0BrC,MAA1B,IAAoC,CAAC,CADzC,EAC4C;MAC1C,KAAK8H,YAAL,CAAkB6D,MAAlB,CAAyB,KAAK7D,YAAL,CAAkBzF,OAAlB,CAA0BrC,MAA1B,CAAzB,EAA4D,CAA5D;IACD;;IAED,KAAK4K,2BAAL;EACD,CApCD;;EAsCAvD,iBAAiB,CAAC+B,SAAlB,CAA4BwC,YAA5B,GAA2C,UAAS5L,MAAT,EAAiB;IAC1D,IAAI8G,EAAE,GAAG,IAAT;IACA9G,MAAM,CAAC+K,SAAP,GAAmBhH,OAAnB,CAA2B,UAAShD,KAAT,EAAgB;MACzC,IAAIuK,MAAM,GAAGxE,EAAE,CAAC+E,UAAH,GAAgBrG,IAAhB,CAAqB,UAASmF,CAAT,EAAY;QAC5C,OAAOA,CAAC,CAAC5J,KAAF,KAAYA,KAAnB;MACD,CAFY,CAAb;;MAGA,IAAIuK,MAAJ,EAAY;QACVxE,EAAE,CAACF,WAAH,CAAe0E,MAAf;MACD;IACF,CAPD;EAQD,CAVD;;EAYAjE,iBAAiB,CAAC+B,SAAlB,CAA4ByC,UAA5B,GAAyC,YAAW;IAClD,OAAO,KAAKhD,YAAL,CAAkBhH,MAAlB,CAAyB,UAAShC,WAAT,EAAsB;MACpD,OAAO,CAAC,CAACA,WAAW,CAACc,SAArB;IACD,CAFM,EAGN+K,GAHM,CAGF,UAAS7L,WAAT,EAAsB;MACzB,OAAOA,WAAW,CAACc,SAAnB;IACD,CALM,CAAP;EAMD,CAPD;;EASA0G,iBAAiB,CAAC+B,SAAlB,CAA4B0C,YAA5B,GAA2C,YAAW;IACpD,OAAO,KAAKjD,YAAL,CAAkBhH,MAAlB,CAAyB,UAAShC,WAAT,EAAsB;MACpD,OAAO,CAAC,CAACA,WAAW,CAACe,WAArB;IACD,CAFM,EAGN8K,GAHM,CAGF,UAAS7L,WAAT,EAAsB;MACzB,OAAOA,WAAW,CAACe,WAAnB;IACD,CALM,CAAP;EAMD,CAPD;;EAUAyG,iBAAiB,CAAC+B,SAAlB,CAA4B2C,kBAA5B,GAAiD,UAASC,aAAT,EAC7C5D,WAD6C,EAChC;IACf,IAAItB,EAAE,GAAG,IAAT;;IACA,IAAIsB,WAAW,IAAI4D,aAAa,GAAG,CAAnC,EAAsC;MACpC,OAAO,KAAKnD,YAAL,CAAkB,CAAlB,EAAqBvI,WAA5B;IACD,CAFD,MAEO,IAAI,KAAKkI,aAAL,CAAmBlG,MAAvB,EAA+B;MACpC,OAAO,KAAKkG,aAAL,CAAmByD,KAAnB,EAAP;IACD;;IACD,IAAI3L,WAAW,GAAG,IAAIgG,MAAM,CAACoC,cAAX,CAA0B;MAC1CnH,UAAU,EAAE,KAAKqH,OAAL,CAAarH,UADiB;MAE1CoH,YAAY,EAAE,KAAKC,OAAL,CAAaL;IAFe,CAA1B,CAAlB;IAIA2D,MAAM,CAACC,cAAP,CAAsB7L,WAAtB,EAAmC,OAAnC,EACI;MAAC8L,KAAK,EAAE,KAAR;MAAeC,QAAQ,EAAE;IAAzB,CADJ;IAIA,KAAKxD,YAAL,CAAkBmD,aAAlB,EAAiCM,uBAAjC,GAA2D,EAA3D;;IACA,KAAKzD,YAAL,CAAkBmD,aAAlB,EAAiCO,gBAAjC,GAAoD,UAASzC,KAAT,EAAgB;MAClE,IAAI0C,GAAG,GAAG,CAAC1C,KAAK,CAACzE,SAAP,IAAoB6G,MAAM,CAACO,IAAP,CAAY3C,KAAK,CAACzE,SAAlB,EAA6B/C,MAA7B,KAAwC,CAAtE,CADkE,CAElE;MACA;;MACAhC,WAAW,CAACoM,KAAZ,GAAoBF,GAAG,GAAG,WAAH,GAAiB,WAAxC;;MACA,IAAI1F,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+BM,uBAA/B,KAA2D,IAA/D,EAAqE;QACnExF,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+BM,uBAA/B,CAAuDlI,IAAvD,CAA4D0F,KAA5D;MACD;IACF,CARD;;IASAxJ,WAAW,CAAC8K,gBAAZ,CAA6B,gBAA7B,EACE,KAAKvC,YAAL,CAAkBmD,aAAlB,EAAiCO,gBADnC;IAEA,OAAOjM,WAAP;EACD,CA7BD,CApT6C,CAmV7C;;;EACA+G,iBAAiB,CAAC+B,SAAlB,CAA4BuD,OAA5B,GAAsC,UAASjM,GAAT,EAAcsL,aAAd,EAA6B;IACjE,IAAIlF,EAAE,GAAG,IAAT;IACA,IAAIxG,WAAW,GAAG,KAAKuI,YAAL,CAAkBmD,aAAlB,EAAiC1L,WAAnD;;IACA,IAAIA,WAAW,CAACsM,gBAAhB,EAAkC;MAChC;IACD;;IACD,IAAIN,uBAAuB,GACzB,KAAKzD,YAAL,CAAkBmD,aAAlB,EAAiCM,uBADnC;IAEA,KAAKzD,YAAL,CAAkBmD,aAAlB,EAAiCM,uBAAjC,GAA2D,IAA3D;IACAhM,WAAW,CAACuM,mBAAZ,CAAgC,gBAAhC,EACE,KAAKhE,YAAL,CAAkBmD,aAAlB,EAAiCO,gBADnC;;IAEAjM,WAAW,CAACsM,gBAAZ,GAA+B,UAASE,GAAT,EAAc;MAC3C,IAAIhG,EAAE,CAACsB,WAAH,IAAkB4D,aAAa,GAAG,CAAtC,EAAyC;QACvC;QACA;QACA;QACA;MACD;;MACD,IAAIlC,KAAK,GAAG,IAAI5C,KAAJ,CAAU,cAAV,CAAZ;MACA4C,KAAK,CAACzE,SAAN,GAAkB;QAAC0H,MAAM,EAAErM,GAAT;QAAcsL,aAAa,EAAEA;MAA7B,CAAlB;MAEA,IAAIgB,IAAI,GAAGF,GAAG,CAACzH,SAAf,CAV2C,CAW3C;;MACA,IAAImH,GAAG,GAAG,CAACQ,IAAD,IAASd,MAAM,CAACO,IAAP,CAAYO,IAAZ,EAAkB1K,MAAlB,KAA6B,CAAhD;;MACA,IAAIkK,GAAJ,EAAS;QACP;QACA;QACA,IAAIlM,WAAW,CAACoM,KAAZ,KAAsB,KAAtB,IAA+BpM,WAAW,CAACoM,KAAZ,KAAsB,WAAzD,EAAsE;UACpEpM,WAAW,CAACoM,KAAZ,GAAoB,WAApB;QACD;MACF,CAND,MAMO;QACL,IAAIpM,WAAW,CAACoM,KAAZ,KAAsB,KAA1B,EAAiC;UAC/BpM,WAAW,CAACoM,KAAZ,GAAoB,WAApB;QACD,CAHI,CAIL;;;QACAM,IAAI,CAACC,SAAL,GAAiB,CAAjB;QACA,IAAIC,mBAAmB,GAAGxN,QAAQ,CAACyN,cAAT,CAAwBH,IAAxB,CAA1B;QACAlD,KAAK,CAACzE,SAAN,GAAkB6G,MAAM,CAACkB,MAAP,CAActD,KAAK,CAACzE,SAApB,EACd3F,QAAQ,CAAC2N,cAAT,CAAwBH,mBAAxB,CADc,CAAlB;QAEApD,KAAK,CAACzE,SAAN,CAAgBA,SAAhB,GAA4B6H,mBAA5B;MACD,CA7B0C,CA+B3C;;;MACA,IAAII,QAAQ,GAAG5N,QAAQ,CAAC6N,gBAAT,CAA0BzG,EAAE,CAACkB,gBAAH,CAAoB9H,GAA9C,CAAf;;MACA,IAAI,CAACsM,GAAL,EAAU;QACRc,QAAQ,CAACxD,KAAK,CAACzE,SAAN,CAAgB2G,aAAjB,CAAR,IACI,OAAOlC,KAAK,CAACzE,SAAN,CAAgBA,SAAvB,GAAmC,MADvC;MAED,CAHD,MAGO;QACLiI,QAAQ,CAACxD,KAAK,CAACzE,SAAN,CAAgB2G,aAAjB,CAAR,IACI,yBADJ;MAED;;MACDlF,EAAE,CAACkB,gBAAH,CAAoB9H,GAApB,GACIR,QAAQ,CAAC8N,cAAT,CAAwB1G,EAAE,CAACkB,gBAAH,CAAoB9H,GAA5C,IACAoN,QAAQ,CAACG,IAAT,CAAc,EAAd,CAFJ;MAGA,IAAIC,QAAQ,GAAG5G,EAAE,CAAC+B,YAAH,CAAgB8E,KAAhB,CAAsB,UAAS9N,WAAT,EAAsB;QACzD,OAAOA,WAAW,CAACS,WAAZ,IACHT,WAAW,CAACS,WAAZ,CAAwBoM,KAAxB,KAAkC,WADtC;MAED,CAHc,CAAf;;MAKA,IAAI5F,EAAE,CAACqB,iBAAH,KAAyB,WAA7B,EAA0C;QACxCrB,EAAE,CAACqB,iBAAH,GAAuB,WAAvB;;QACArB,EAAE,CAACiD,yBAAH;MACD,CAnD0C,CAqD3C;MACA;;;MACA,IAAI,CAACyC,GAAL,EAAU;QACR1F,EAAE,CAACM,cAAH,CAAkB,cAAlB,EAAkC0C,KAAlC;MACD;;MACD,IAAI4D,QAAJ,EAAc;QACZ5G,EAAE,CAACM,cAAH,CAAkB,cAAlB,EAAkC,IAAIF,KAAJ,CAAU,cAAV,CAAlC;;QACAJ,EAAE,CAACqB,iBAAH,GAAuB,UAAvB;;QACArB,EAAE,CAACiD,yBAAH;MACD;IACF,CA/DD,CAXiE,CA4EjE;;;IACAzD,MAAM,CAACa,UAAP,CAAkB,YAAW;MAC3BmF,uBAAuB,CAACvI,OAAxB,CAAgC,UAASmC,CAAT,EAAY;QAC1C5F,WAAW,CAACsM,gBAAZ,CAA6B1G,CAA7B;MACD,CAFD;IAGD,CAJD,EAIG,CAJH;EAKD,CAlFD,CApV6C,CAwa7C;;;EACAmB,iBAAiB,CAAC+B,SAAlB,CAA4BqB,2BAA5B,GAA0D,YAAW;IACnE,IAAI3D,EAAE,GAAG,IAAT;IACA,IAAI1B,YAAY,GAAG,IAAIkB,MAAM,CAACsH,eAAX,CAA2B,IAA3B,CAAnB;;IACAxI,YAAY,CAACyI,gBAAb,GAAgC,YAAW;MACzC/G,EAAE,CAACgH,sBAAH;IACD,CAFD;;IAIA,IAAIrN,aAAa,GAAG,IAAI6F,MAAM,CAACyH,gBAAX,CAA4B3I,YAA5B,CAApB;;IACA3E,aAAa,CAACuN,iBAAd,GAAkC,YAAW;MAC3ClH,EAAE,CAACgH,sBAAH;IACD,CAFD;;IAGArN,aAAa,CAACwN,OAAd,GAAwB,YAAW;MACjC;MACA/B,MAAM,CAACC,cAAP,CAAsB1L,aAAtB,EAAqC,OAArC,EACI;QAAC2L,KAAK,EAAE,QAAR;QAAkBC,QAAQ,EAAE;MAA5B,CADJ;;MAEAvF,EAAE,CAACgH,sBAAH;IACD,CALD;;IAOA,OAAO;MACL1I,YAAY,EAAEA,YADT;MAEL3E,aAAa,EAAEA;IAFV,CAAP;EAID,CAtBD,CAza6C,CAic7C;EACA;;;EACA4G,iBAAiB,CAAC+B,SAAlB,CAA4B8E,4BAA5B,GAA2D,UACvDlC,aADuD,EACxC;IACjB,IAAI1L,WAAW,GAAG,KAAKuI,YAAL,CAAkBmD,aAAlB,EAAiC1L,WAAnD;;IACA,IAAIA,WAAJ,EAAiB;MACf,OAAOA,WAAW,CAACsM,gBAAnB;MACA,OAAO,KAAK/D,YAAL,CAAkBmD,aAAlB,EAAiC1L,WAAxC;IACD;;IACD,IAAI8E,YAAY,GAAG,KAAKyD,YAAL,CAAkBmD,aAAlB,EAAiC5G,YAApD;;IACA,IAAIA,YAAJ,EAAkB;MAChB,OAAOA,YAAY,CAACyI,gBAApB;MACA,OAAO,KAAKhF,YAAL,CAAkBmD,aAAlB,EAAiC5G,YAAxC;IACD;;IACD,IAAI3E,aAAa,GAAG,KAAKoI,YAAL,CAAkBmD,aAAlB,EAAiCvL,aAArD;;IACA,IAAIA,aAAJ,EAAmB;MACjB,OAAOA,aAAa,CAACuN,iBAArB;MACA,OAAOvN,aAAa,CAACwN,OAArB;MACA,OAAO,KAAKpF,YAAL,CAAkBmD,aAAlB,EAAiCvL,aAAxC;IACD;EACF,CAlBD,CAnc6C,CAud7C;;;EACA4G,iBAAiB,CAAC+B,SAAlB,CAA4B+E,WAA5B,GAA0C,UAAStO,WAAT,EACtCuO,IADsC,EAChCC,IADgC,EAC1B;IACd,IAAIC,MAAM,GAAG/L,qBAAqB,CAAC1C,WAAW,CAAC2C,iBAAb,EAC9B3C,WAAW,CAAC4C,kBADkB,CAAlC;;IAEA,IAAI2L,IAAI,IAAIvO,WAAW,CAACc,SAAxB,EAAmC;MACjC2N,MAAM,CAACC,SAAP,GAAmB1O,WAAW,CAACqB,sBAA/B;MACAoN,MAAM,CAACE,IAAP,GAAc;QACZC,KAAK,EAAE/O,QAAQ,CAAC2B,UADJ;QAEZqN,QAAQ,EAAE7O,WAAW,CAAC8O,cAAZ,CAA2BD;MAFzB,CAAd;;MAIA,IAAI7O,WAAW,CAACwK,sBAAZ,CAAmC/H,MAAvC,EAA+C;QAC7CgM,MAAM,CAACE,IAAP,CAAYrN,IAAZ,GAAmBtB,WAAW,CAACwK,sBAAZ,CAAmC,CAAnC,EAAsClJ,IAAzD;MACD;;MACDtB,WAAW,CAACc,SAAZ,CAAsByN,IAAtB,CAA2BE,MAA3B;IACD;;IACD,IAAID,IAAI,IAAIxO,WAAW,CAACe,WAApB,IAAmC0N,MAAM,CAAC3L,MAAP,CAAcL,MAAd,GAAuB,CAA9D,EAAiE;MAC/D;MACA,IAAIzC,WAAW,CAACO,IAAZ,KAAqB,OAArB,IACGP,WAAW,CAACwK,sBADf,IAEG7I,WAAW,GAAG,KAFrB,EAE4B;QAC1B3B,WAAW,CAACwK,sBAAZ,CAAmCtG,OAAnC,CAA2C,UAAS6K,CAAT,EAAY;UACrD,OAAOA,CAAC,CAACxN,GAAT;QACD,CAFD;MAGD;;MACD,IAAIvB,WAAW,CAACwK,sBAAZ,CAAmC/H,MAAvC,EAA+C;QAC7CgM,MAAM,CAACC,SAAP,GAAmB1O,WAAW,CAACwK,sBAA/B;MACD,CAFD,MAEO;QACLiE,MAAM,CAACC,SAAP,GAAmB,CAAC,EAAD,CAAnB;MACD;;MACDD,MAAM,CAACE,IAAP,GAAc;QACZE,QAAQ,EAAE7O,WAAW,CAAC8O,cAAZ,CAA2BD;MADzB,CAAd;;MAGA,IAAI7O,WAAW,CAAC8O,cAAZ,CAA2BF,KAA/B,EAAsC;QACpCH,MAAM,CAACE,IAAP,CAAYC,KAAZ,GAAoB5O,WAAW,CAAC8O,cAAZ,CAA2BF,KAA/C;MACD;;MACD,IAAI5O,WAAW,CAACqB,sBAAZ,CAAmCoB,MAAvC,EAA+C;QAC7CgM,MAAM,CAACE,IAAP,CAAYrN,IAAZ,GAAmBtB,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCC,IAAzD;MACD;;MACDtB,WAAW,CAACe,WAAZ,CAAwBiO,OAAxB,CAAgCP,MAAhC;IACD;EACF,CAxCD;;EA0CAjH,iBAAiB,CAAC+B,SAAlB,CAA4BpE,mBAA5B,GAAkD,UAASiB,WAAT,EAAsB;IACtE,IAAIa,EAAE,GAAG,IAAT,CADsE,CAGtE;;IACA,IAAI,CAAC,OAAD,EAAU,QAAV,EAAoBzE,OAApB,CAA4B4D,WAAW,CAAClG,IAAxC,MAAkD,CAAC,CAAvD,EAA0D;MACxD,OAAO+O,OAAO,CAACC,MAAR,CAAe/I,SAAS,CAAC,WAAD,EAC3B,uBAAuBC,WAAW,CAAClG,IAAnC,GAA0C,GADf,CAAxB,CAAP;IAED;;IAED,IAAI,CAAC6E,+BAA+B,CAAC,qBAAD,EAChCqB,WAAW,CAAClG,IADoB,EACd+G,EAAE,CAAChC,cADW,CAAhC,IACwCgC,EAAE,CAACqC,SAD/C,EAC0D;MACxD,OAAO2F,OAAO,CAACC,MAAR,CAAe/I,SAAS,CAAC,mBAAD,EAC3B,uBAAuBC,WAAW,CAAClG,IAAnC,GACA,YADA,GACe+G,EAAE,CAAChC,cAFS,CAAxB,CAAP;IAGD;;IAED,IAAIwI,QAAJ;IACA,IAAI0B,WAAJ;;IACA,IAAI/I,WAAW,CAAClG,IAAZ,KAAqB,OAAzB,EAAkC;MAChC;MACA;MACAuN,QAAQ,GAAG5N,QAAQ,CAACuP,aAAT,CAAuBhJ,WAAW,CAAC/F,GAAnC,CAAX;MACA8O,WAAW,GAAG1B,QAAQ,CAACrB,KAAT,EAAd;MACAqB,QAAQ,CAACvJ,OAAT,CAAiB,UAASmL,YAAT,EAAuBlD,aAAvB,EAAsC;QACrD,IAAIlM,IAAI,GAAGJ,QAAQ,CAACyP,kBAAT,CAA4BD,YAA5B,CAAX;QACApI,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+BxJ,iBAA/B,GAAmD1C,IAAnD;MACD,CAHD;MAKAgH,EAAE,CAAC+B,YAAH,CAAgB9E,OAAhB,CAAwB,UAASlE,WAAT,EAAsBmM,aAAtB,EAAqC;QAC3DlF,EAAE,CAAC6F,OAAH,CAAW9M,WAAW,CAACa,GAAvB,EAA4BsL,aAA5B;MACD,CAFD;IAGD,CAbD,MAaO,IAAI/F,WAAW,CAAClG,IAAZ,KAAqB,QAAzB,EAAmC;MACxCuN,QAAQ,GAAG5N,QAAQ,CAACuP,aAAT,CAAuBnI,EAAE,CAACmB,iBAAH,CAAqB/H,GAA5C,CAAX;MACA8O,WAAW,GAAG1B,QAAQ,CAACrB,KAAT,EAAd;MACA,IAAImD,SAAS,GAAG1P,QAAQ,CAAC2P,WAAT,CAAqBL,WAArB,EACZ,YADY,EACE1M,MADF,GACW,CAD3B;MAEAgL,QAAQ,CAACvJ,OAAT,CAAiB,UAASmL,YAAT,EAAuBlD,aAAvB,EAAsC;QACrD,IAAInM,WAAW,GAAGiH,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,CAAlB;QACA,IAAI1L,WAAW,GAAGT,WAAW,CAACS,WAA9B;QACA,IAAI8E,YAAY,GAAGvF,WAAW,CAACuF,YAA/B;QACA,IAAI3E,aAAa,GAAGZ,WAAW,CAACY,aAAhC;QACA,IAAI+B,iBAAiB,GAAG3C,WAAW,CAAC2C,iBAApC;QACA,IAAIC,kBAAkB,GAAG5C,WAAW,CAAC4C,kBAArC,CANqD,CAQrD;;QACA,IAAI6M,QAAQ,GAAG5P,QAAQ,CAAC6P,UAAT,CAAoBL,YAApB,KACXxP,QAAQ,CAAC2P,WAAT,CAAqBH,YAArB,EAAmC,eAAnC,EAAoD5M,MAApD,KAA+D,CADnE;;QAGA,IAAI,CAACgN,QAAD,IAAa,CAACzP,WAAW,CAAC2P,aAA9B,EAA6C;UAC3C,IAAIC,mBAAmB,GAAG/P,QAAQ,CAACgQ,gBAAT,CACtBR,YADsB,EACRF,WADQ,CAA1B;UAEA,IAAIW,oBAAoB,GAAGjQ,QAAQ,CAACkQ,iBAAT,CACvBV,YADuB,EACTF,WADS,CAA3B;;UAEA,IAAII,SAAJ,EAAe;YACbO,oBAAoB,CAACE,IAArB,GAA4B,QAA5B;UACD;;UAED,IAAI,CAAC/I,EAAE,CAACsB,WAAJ,IAAmB4D,aAAa,KAAK,CAAzC,EAA4C;YAC1ClF,EAAE,CAAC6F,OAAH,CAAW9M,WAAW,CAACa,GAAvB,EAA4BsL,aAA5B;;YACA,IAAI5G,YAAY,CAACsH,KAAb,KAAuB,KAA3B,EAAkC;cAChCtH,YAAY,CAAC0K,KAAb,CAAmBxP,WAAnB,EAAgCmP,mBAAhC,EACIL,SAAS,GAAG,aAAH,GAAmB,YADhC;YAED;;YACD,IAAI3O,aAAa,CAACiM,KAAd,KAAwB,KAA5B,EAAmC;cACjCjM,aAAa,CAACqP,KAAd,CAAoBH,oBAApB;YACD;UACF,CAlB0C,CAoB3C;;;UACA,IAAIrB,MAAM,GAAG/L,qBAAqB,CAACC,iBAAD,EAC9BC,kBAD8B,CAAlC,CArB2C,CAwB3C;UACA;;UACAqE,EAAE,CAACqH,WAAH,CAAetO,WAAf,EACIyO,MAAM,CAAC3L,MAAP,CAAcL,MAAd,GAAuB,CAD3B,EAEI,KAFJ;QAGD;MACF,CA1CD;IA2CD;;IAEDwE,EAAE,CAACkB,gBAAH,GAAsB;MACpBjI,IAAI,EAAEkG,WAAW,CAAClG,IADE;MAEpBG,GAAG,EAAE+F,WAAW,CAAC/F;IAFG,CAAtB;;IAIA,IAAI+F,WAAW,CAAClG,IAAZ,KAAqB,OAAzB,EAAkC;MAChC+G,EAAE,CAACiJ,qBAAH,CAAyB,kBAAzB;IACD,CAFD,MAEO;MACLjJ,EAAE,CAACiJ,qBAAH,CAAyB,QAAzB;IACD;;IAED,OAAOjB,OAAO,CAACkB,OAAR,EAAP;EACD,CA5FD;;EA8FA3I,iBAAiB,CAAC+B,SAAlB,CAA4BnE,oBAA5B,GAAmD,UAASgB,WAAT,EAAsB;IACvE,IAAIa,EAAE,GAAG,IAAT,CADuE,CAGvE;;IACA,IAAI,CAAC,OAAD,EAAU,QAAV,EAAoBzE,OAApB,CAA4B4D,WAAW,CAAClG,IAAxC,MAAkD,CAAC,CAAvD,EAA0D;MACxD,OAAO+O,OAAO,CAACC,MAAR,CAAe/I,SAAS,CAAC,WAAD,EAC3B,uBAAuBC,WAAW,CAAClG,IAAnC,GAA0C,GADf,CAAxB,CAAP;IAED;;IAED,IAAI,CAAC6E,+BAA+B,CAAC,sBAAD,EAChCqB,WAAW,CAAClG,IADoB,EACd+G,EAAE,CAAChC,cADW,CAAhC,IACwCgC,EAAE,CAACqC,SAD/C,EAC0D;MACxD,OAAO2F,OAAO,CAACC,MAAR,CAAe/I,SAAS,CAAC,mBAAD,EAC3B,wBAAwBC,WAAW,CAAClG,IAApC,GACA,YADA,GACe+G,EAAE,CAAChC,cAFS,CAAxB,CAAP;IAGD;;IAED,IAAIkC,OAAO,GAAG,EAAd;IACAF,EAAE,CAACiB,aAAH,CAAiBhE,OAAjB,CAAyB,UAAS/D,MAAT,EAAiB;MACxCgH,OAAO,CAAChH,MAAM,CAACgB,EAAR,CAAP,GAAqBhB,MAArB;IACD,CAFD;IAGA,IAAIiQ,YAAY,GAAG,EAAnB;IACA,IAAI3C,QAAQ,GAAG5N,QAAQ,CAACuP,aAAT,CAAuBhJ,WAAW,CAAC/F,GAAnC,CAAf;IACA,IAAI8O,WAAW,GAAG1B,QAAQ,CAACrB,KAAT,EAAlB;IACA,IAAImD,SAAS,GAAG1P,QAAQ,CAAC2P,WAAT,CAAqBL,WAArB,EACZ,YADY,EACE1M,MADF,GACW,CAD3B;IAEA,IAAI8F,WAAW,GAAG1I,QAAQ,CAAC2P,WAAT,CAAqBL,WAArB,EACd,iBADc,EACK1M,MADL,GACc,CADhC;IAEAwE,EAAE,CAACsB,WAAH,GAAiBA,WAAjB;IACA,IAAI8H,UAAU,GAAGxQ,QAAQ,CAAC2P,WAAT,CAAqBL,WAArB,EACb,gBADa,EACK,CADL,CAAjB;;IAEA,IAAIkB,UAAJ,EAAgB;MACdpJ,EAAE,CAACc,uBAAH,GAA6BsI,UAAU,CAACC,MAAX,CAAkB,EAAlB,EAAsBC,KAAtB,CAA4B,GAA5B,EACxB/N,OADwB,CAChB,SADgB,KACF,CAD3B;IAED,CAHD,MAGO;MACLyE,EAAE,CAACc,uBAAH,GAA6B,KAA7B;IACD;;IAED0F,QAAQ,CAACvJ,OAAT,CAAiB,UAASmL,YAAT,EAAuBlD,aAAvB,EAAsC;MACrD,IAAIqE,KAAK,GAAG3Q,QAAQ,CAAC4Q,UAAT,CAAoBpB,YAApB,CAAZ;MACA,IAAI9O,IAAI,GAAGV,QAAQ,CAAC6Q,OAAT,CAAiBrB,YAAjB,CAAX,CAFqD,CAGrD;;MACA,IAAII,QAAQ,GAAG5P,QAAQ,CAAC6P,UAAT,CAAoBL,YAApB,KACXxP,QAAQ,CAAC2P,WAAT,CAAqBH,YAArB,EAAmC,eAAnC,EAAoD5M,MAApD,KAA+D,CADnE;MAEA,IAAIwD,QAAQ,GAAGuK,KAAK,CAAC,CAAD,CAAL,CAASF,MAAT,CAAgB,CAAhB,EAAmBC,KAAnB,CAAyB,GAAzB,EAA8B,CAA9B,CAAf;MAEA,IAAII,SAAS,GAAG9Q,QAAQ,CAAC+Q,YAAT,CAAsBvB,YAAtB,EAAoCF,WAApC,CAAhB;MACA,IAAI0B,UAAU,GAAGhR,QAAQ,CAACiR,SAAT,CAAmBzB,YAAnB,CAAjB;MAEA,IAAIxO,GAAG,GAAGhB,QAAQ,CAACkR,MAAT,CAAgB1B,YAAhB,KAAiCxP,QAAQ,CAACmR,kBAAT,EAA3C,CAXqD,CAarD;;MACA,IAAIzQ,IAAI,KAAK,aAAT,IAA0B0F,QAAQ,KAAK,WAA3C,EAAwD;QACtDgB,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,IAAiC;UAC/BtL,GAAG,EAAEA,GAD0B;UAE/B8O,aAAa,EAAE;QAFgB,CAAjC;QAIA;MACD;;MAED,IAAI3P,WAAJ;MACA,IAAIS,WAAJ;MACA,IAAI8E,YAAJ;MACA,IAAI3E,aAAJ;MACA,IAAIG,WAAJ;MACA,IAAIM,sBAAJ;MACA,IAAImJ,sBAAJ;MACA,IAAI7H,iBAAJ;MAEA,IAAIzB,KAAJ,CA/BqD,CAgCrD;;MACA,IAAI0B,kBAAkB,GAAG/C,QAAQ,CAACyP,kBAAT,CAA4BD,YAA5B,CAAzB;MACA,IAAIO,mBAAJ;MACA,IAAIE,oBAAJ;;MACA,IAAI,CAACL,QAAL,EAAe;QACbG,mBAAmB,GAAG/P,QAAQ,CAACgQ,gBAAT,CAA0BR,YAA1B,EAClBF,WADkB,CAAtB;QAEAW,oBAAoB,GAAGjQ,QAAQ,CAACkQ,iBAAT,CAA2BV,YAA3B,EACnBF,WADmB,CAAvB;QAEAW,oBAAoB,CAACE,IAArB,GAA4B,QAA5B;MACD;;MACDxF,sBAAsB,GAClB3K,QAAQ,CAACoR,0BAAT,CAAoC5B,YAApC,CADJ;MAGA,IAAIP,cAAc,GAAGjP,QAAQ,CAACqR,mBAAT,CAA6B7B,YAA7B,CAArB;MAEA,IAAI8B,UAAU,GAAGtR,QAAQ,CAAC2P,WAAT,CAAqBH,YAArB,EACb,qBADa,EACUF,WADV,EACuB1M,MADvB,GACgC,CADjD;MAEA,IAAI2O,KAAK,GAAGvR,QAAQ,CAAC2P,WAAT,CAAqBH,YAArB,EAAmC,cAAnC,EACPxD,GADO,CACH,UAASsB,IAAT,EAAe;QAClB,OAAOtN,QAAQ,CAAC2N,cAAT,CAAwBL,IAAxB,CAAP;MACD,CAHO,EAIPnL,MAJO,CAIA,UAASmL,IAAT,EAAe;QACrB,OAAOA,IAAI,CAACC,SAAL,KAAmB,CAA1B;MACD,CANO,CAAZ,CAlDqD,CA0DrD;;MACA,IAAI,CAAChH,WAAW,CAAClG,IAAZ,KAAqB,OAArB,IAAgCkG,WAAW,CAAClG,IAAZ,KAAqB,QAAtD,KACA,CAACuP,QADD,IACalH,WADb,IAC4B4D,aAAa,GAAG,CAD5C,IAEAlF,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,CAFJ,EAEoC;QAClClF,EAAE,CAACoH,4BAAH,CAAgClC,aAAhC;;QACAlF,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+B1L,WAA/B,GACIwG,EAAE,CAAC+B,YAAH,CAAgB,CAAhB,EAAmBvI,WADvB;QAEAwG,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+B5G,YAA/B,GACI0B,EAAE,CAAC+B,YAAH,CAAgB,CAAhB,EAAmBzD,YADvB;QAEA0B,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+BvL,aAA/B,GACIqG,EAAE,CAAC+B,YAAH,CAAgB,CAAhB,EAAmBpI,aADvB;;QAEA,IAAIqG,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+BrL,SAAnC,EAA8C;UAC5CmG,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+BrL,SAA/B,CAAyCuQ,YAAzC,CACIpK,EAAE,CAAC+B,YAAH,CAAgB,CAAhB,EAAmBpI,aADvB;QAED;;QACD,IAAIqG,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+BpL,WAAnC,EAAgD;UAC9CkG,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+BpL,WAA/B,CAA2CsQ,YAA3C,CACIpK,EAAE,CAAC+B,YAAH,CAAgB,CAAhB,EAAmBpI,aADvB;QAED;MACF;;MACD,IAAIwF,WAAW,CAAClG,IAAZ,KAAqB,OAArB,IAAgC,CAACuP,QAArC,EAA+C;QAC7CzP,WAAW,GAAGiH,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,KACVlF,EAAE,CAACqD,kBAAH,CAAsB/J,IAAtB,CADJ;QAEAP,WAAW,CAACa,GAAZ,GAAkBA,GAAlB;;QAEA,IAAI,CAACb,WAAW,CAACS,WAAjB,EAA8B;UAC5BT,WAAW,CAACS,WAAZ,GAA0BwG,EAAE,CAACiF,kBAAH,CAAsBC,aAAtB,EACtB5D,WADsB,CAA1B;QAED;;QAED,IAAI6I,KAAK,CAAC3O,MAAN,IAAgBzC,WAAW,CAACuF,YAAZ,CAAyBsH,KAAzB,KAAmC,KAAvD,EAA8D;UAC5D,IAAIsE,UAAU,KAAK,CAAC5I,WAAD,IAAgB4D,aAAa,KAAK,CAAvC,CAAd,EAAyD;YACvDnM,WAAW,CAACuF,YAAZ,CAAyB+L,mBAAzB,CAA6CF,KAA7C;UACD,CAFD,MAEO;YACLA,KAAK,CAAClN,OAAN,CAAc,UAASsB,SAAT,EAAoB;cAChCF,iBAAiB,CAACtF,WAAW,CAACuF,YAAb,EAA2BC,SAA3B,CAAjB;YACD,CAFD;UAGD;QACF;;QAED7C,iBAAiB,GAAG8D,MAAM,CAAC8K,cAAP,CAAsBC,eAAtB,CAAsCjR,IAAtC,CAApB,CApB6C,CAsB7C;QACA;;QACA,IAAIoB,WAAW,GAAG,KAAlB,EAAyB;UACvBgB,iBAAiB,CAACG,MAAlB,GAA2BH,iBAAiB,CAACG,MAAlB,CAAyBd,MAAzB,CACvB,UAASyP,KAAT,EAAgB;YACd,OAAOA,KAAK,CAACzN,IAAN,KAAe,KAAtB;UACD,CAHsB,CAA3B;QAID;;QAED3C,sBAAsB,GAAGrB,WAAW,CAACqB,sBAAZ,IAAsC,CAAC;UAC9DC,IAAI,EAAE,CAAC,IAAI6K,aAAJ,GAAoB,CAArB,IAA0B;QAD8B,CAAD,CAA/D,CA/B6C,CAmC7C;;QACA,IAAIuF,UAAU,GAAG,KAAjB;;QACA,IAAIf,SAAS,KAAK,UAAd,IAA4BA,SAAS,KAAK,UAA9C,EAA0D;UACxDe,UAAU,GAAG,CAAC1R,WAAW,CAACe,WAA1B;UACAA,WAAW,GAAGf,WAAW,CAACe,WAAZ,IACV,IAAI0F,MAAM,CAAC8K,cAAX,CAA0BvR,WAAW,CAACY,aAAtC,EAAqDL,IAArD,CADJ;;UAGA,IAAImR,UAAJ,EAAgB;YACd,IAAIvR,MAAJ;YACAe,KAAK,GAAGH,WAAW,CAACG,KAApB,CAFc,CAGd;;YACA,IAAI2P,UAAU,IAAIA,UAAU,CAAC1Q,MAAX,KAAsB,GAAxC,EAA6C,CAC3C;YACD,CAFD,MAEO,IAAI0Q,UAAJ,EAAgB;cACrB,IAAI,CAAC1J,OAAO,CAAC0J,UAAU,CAAC1Q,MAAZ,CAAZ,EAAiC;gBAC/BgH,OAAO,CAAC0J,UAAU,CAAC1Q,MAAZ,CAAP,GAA6B,IAAIsG,MAAM,CAACkL,WAAX,EAA7B;gBACAtF,MAAM,CAACC,cAAP,CAAsBnF,OAAO,CAAC0J,UAAU,CAAC1Q,MAAZ,CAA7B,EAAkD,IAAlD,EAAwD;kBACtDyR,GAAG,EAAE,YAAW;oBACd,OAAOf,UAAU,CAAC1Q,MAAlB;kBACD;gBAHqD,CAAxD;cAKD;;cACDkM,MAAM,CAACC,cAAP,CAAsBpL,KAAtB,EAA6B,IAA7B,EAAmC;gBACjC0Q,GAAG,EAAE,YAAW;kBACd,OAAOf,UAAU,CAAC3P,KAAlB;gBACD;cAHgC,CAAnC;cAKAf,MAAM,GAAGgH,OAAO,CAAC0J,UAAU,CAAC1Q,MAAZ,CAAhB;YACD,CAfM,MAeA;cACL,IAAI,CAACgH,OAAO,CAAC0K,OAAb,EAAsB;gBACpB1K,OAAO,CAAC0K,OAAR,GAAkB,IAAIpL,MAAM,CAACkL,WAAX,EAAlB;cACD;;cACDxR,MAAM,GAAGgH,OAAO,CAAC0K,OAAjB;YACD;;YACD,IAAI1R,MAAJ,EAAY;cACVuG,4BAA4B,CAACxF,KAAD,EAAQf,MAAR,CAA5B;cACAH,WAAW,CAACyK,4BAAZ,CAAyClG,IAAzC,CAA8CpE,MAA9C;YACD;;YACDiQ,YAAY,CAAC7L,IAAb,CAAkB,CAACrD,KAAD,EAAQH,WAAR,EAAqBZ,MAArB,CAAlB;UACD;QACF,CAtCD,MAsCO,IAAIH,WAAW,CAACe,WAAZ,IAA2Bf,WAAW,CAACe,WAAZ,CAAwBG,KAAvD,EAA8D;UACnElB,WAAW,CAACyK,4BAAZ,CAAyCvG,OAAzC,CAAiD,UAAS4G,CAAT,EAAY;YAC3D,IAAIgH,WAAW,GAAGhH,CAAC,CAACI,SAAF,GAAcvF,IAAd,CAAmB,UAASgG,CAAT,EAAY;cAC/C,OAAOA,CAAC,CAACxK,EAAF,KAASnB,WAAW,CAACe,WAAZ,CAAwBG,KAAxB,CAA8BC,EAA9C;YACD,CAFiB,CAAlB;;YAGA,IAAI2Q,WAAJ,EAAiB;cACfhL,iCAAiC,CAACgL,WAAD,EAAchH,CAAd,CAAjC;YACD;UACF,CAPD;UAQA9K,WAAW,CAACyK,4BAAZ,GAA2C,EAA3C;QACD;;QAEDzK,WAAW,CAAC2C,iBAAZ,GAAgCA,iBAAhC;QACA3C,WAAW,CAAC4C,kBAAZ,GAAiCA,kBAAjC;QACA5C,WAAW,CAACe,WAAZ,GAA0BA,WAA1B;QACAf,WAAW,CAAC8O,cAAZ,GAA6BA,cAA7B;QACA9O,WAAW,CAACqB,sBAAZ,GAAqCA,sBAArC;QACArB,WAAW,CAACwK,sBAAZ,GAAqCA,sBAArC,CA5F6C,CA8F7C;QACA;;QACAvD,EAAE,CAACqH,WAAH,CAAerH,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,CAAf,EACI,KADJ,EAEIuF,UAFJ;MAGD,CAnGD,MAmGO,IAAItL,WAAW,CAAClG,IAAZ,KAAqB,QAArB,IAAiC,CAACuP,QAAtC,EAAgD;QACrDzP,WAAW,GAAGiH,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,CAAd;QACA1L,WAAW,GAAGT,WAAW,CAACS,WAA1B;QACA8E,YAAY,GAAGvF,WAAW,CAACuF,YAA3B;QACA3E,aAAa,GAAGZ,WAAW,CAACY,aAA5B;QACAG,WAAW,GAAGf,WAAW,CAACe,WAA1B;QACAM,sBAAsB,GAAGrB,WAAW,CAACqB,sBAArC;QACAsB,iBAAiB,GAAG3C,WAAW,CAAC2C,iBAAhC;QAEAsE,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+B3B,sBAA/B,GACIA,sBADJ;QAEAvD,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+BvJ,kBAA/B,GACIA,kBADJ;QAEAqE,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,EAA+B2C,cAA/B,GAAgDA,cAAhD;;QAEA,IAAIsC,KAAK,CAAC3O,MAAN,IAAgB8C,YAAY,CAACsH,KAAb,KAAuB,KAA3C,EAAkD;UAChD,IAAI,CAAC0C,SAAS,IAAI4B,UAAd,MACC,CAAC5I,WAAD,IAAgB4D,aAAa,KAAK,CADnC,CAAJ,EAC2C;YACzC5G,YAAY,CAAC+L,mBAAb,CAAiCF,KAAjC;UACD,CAHD,MAGO;YACLA,KAAK,CAAClN,OAAN,CAAc,UAASsB,SAAT,EAAoB;cAChCF,iBAAiB,CAACtF,WAAW,CAACuF,YAAb,EAA2BC,SAA3B,CAAjB;YACD,CAFD;UAGD;QACF;;QAED,IAAI,CAAC+C,WAAD,IAAgB4D,aAAa,KAAK,CAAtC,EAAyC;UACvC,IAAI5G,YAAY,CAACsH,KAAb,KAAuB,KAA3B,EAAkC;YAChCtH,YAAY,CAAC0K,KAAb,CAAmBxP,WAAnB,EAAgCmP,mBAAhC,EACI,aADJ;UAED;;UACD,IAAIhP,aAAa,CAACiM,KAAd,KAAwB,KAA5B,EAAmC;YACjCjM,aAAa,CAACqP,KAAd,CAAoBH,oBAApB;UACD;QACF;;QAED7I,EAAE,CAACqH,WAAH,CAAetO,WAAf,EACI2Q,SAAS,KAAK,UAAd,IAA4BA,SAAS,KAAK,UAD9C,EAEIA,SAAS,KAAK,UAAd,IAA4BA,SAAS,KAAK,UAF9C,EApCqD,CAwCrD;;;QACA,IAAI5P,WAAW,KACV4P,SAAS,KAAK,UAAd,IAA4BA,SAAS,KAAK,UADhC,CAAf,EAC4D;UAC1DzP,KAAK,GAAGH,WAAW,CAACG,KAApB;;UACA,IAAI2P,UAAJ,EAAgB;YACd,IAAI,CAAC1J,OAAO,CAAC0J,UAAU,CAAC1Q,MAAZ,CAAZ,EAAiC;cAC/BgH,OAAO,CAAC0J,UAAU,CAAC1Q,MAAZ,CAAP,GAA6B,IAAIsG,MAAM,CAACkL,WAAX,EAA7B;YACD;;YACDjL,4BAA4B,CAACxF,KAAD,EAAQiG,OAAO,CAAC0J,UAAU,CAAC1Q,MAAZ,CAAf,CAA5B;YACAiQ,YAAY,CAAC7L,IAAb,CAAkB,CAACrD,KAAD,EAAQH,WAAR,EAAqBoG,OAAO,CAAC0J,UAAU,CAAC1Q,MAAZ,CAA5B,CAAlB;UACD,CAND,MAMO;YACL,IAAI,CAACgH,OAAO,CAAC0K,OAAb,EAAsB;cACpB1K,OAAO,CAAC0K,OAAR,GAAkB,IAAIpL,MAAM,CAACkL,WAAX,EAAlB;YACD;;YACDjL,4BAA4B,CAACxF,KAAD,EAAQiG,OAAO,CAAC0K,OAAhB,CAA5B;YACAzB,YAAY,CAAC7L,IAAb,CAAkB,CAACrD,KAAD,EAAQH,WAAR,EAAqBoG,OAAO,CAAC0K,OAA7B,CAAlB;UACD;QACF,CAhBD,MAgBO;UACL;UACA,OAAO7R,WAAW,CAACe,WAAnB;QACD;MACF;IACF,CA/OD;;IAiPA,IAAIkG,EAAE,CAACmC,SAAH,KAAiBC,SAArB,EAAgC;MAC9BpC,EAAE,CAACmC,SAAH,GAAehD,WAAW,CAAClG,IAAZ,KAAqB,OAArB,GAA+B,QAA/B,GAA0C,SAAzD;IACD;;IAED+G,EAAE,CAACmB,iBAAH,GAAuB;MACrBlI,IAAI,EAAEkG,WAAW,CAAClG,IADG;MAErBG,GAAG,EAAE+F,WAAW,CAAC/F;IAFI,CAAvB;;IAIA,IAAI+F,WAAW,CAAClG,IAAZ,KAAqB,OAAzB,EAAkC;MAChC+G,EAAE,CAACiJ,qBAAH,CAAyB,mBAAzB;IACD,CAFD,MAEO;MACLjJ,EAAE,CAACiJ,qBAAH,CAAyB,QAAzB;IACD;;IACD7D,MAAM,CAACO,IAAP,CAAYzF,OAAZ,EAAqBjD,OAArB,CAA6B,UAAS6N,GAAT,EAAc;MACzC,IAAI5R,MAAM,GAAGgH,OAAO,CAAC4K,GAAD,CAApB;;MACA,IAAI5R,MAAM,CAAC+K,SAAP,GAAmBzI,MAAvB,EAA+B;QAC7B,IAAIwE,EAAE,CAACiB,aAAH,CAAiB1F,OAAjB,CAAyBrC,MAAzB,MAAqC,CAAC,CAA1C,EAA6C;UAC3C8G,EAAE,CAACiB,aAAH,CAAiB3D,IAAjB,CAAsBpE,MAAtB;UACA,IAAI8J,KAAK,GAAG,IAAI5C,KAAJ,CAAU,WAAV,CAAZ;UACA4C,KAAK,CAAC9J,MAAN,GAAeA,MAAf;UACAsG,MAAM,CAACa,UAAP,CAAkB,YAAW;YAC3BL,EAAE,CAACM,cAAH,CAAkB,WAAlB,EAA+B0C,KAA/B;UACD,CAFD;QAGD;;QAEDmG,YAAY,CAAClM,OAAb,CAAqB,UAAS8N,IAAT,EAAe;UAClC,IAAI9Q,KAAK,GAAG8Q,IAAI,CAAC,CAAD,CAAhB;UACA,IAAI9K,QAAQ,GAAG8K,IAAI,CAAC,CAAD,CAAnB;;UACA,IAAI7R,MAAM,CAACgB,EAAP,KAAc6Q,IAAI,CAAC,CAAD,CAAJ,CAAQ7Q,EAA1B,EAA8B;YAC5B;UACD;;UACD6F,YAAY,CAACC,EAAD,EAAK/F,KAAL,EAAYgG,QAAZ,EAAsB,CAAC/G,MAAD,CAAtB,CAAZ;QACD,CAPD;MAQD;IACF,CArBD;IAsBAiQ,YAAY,CAAClM,OAAb,CAAqB,UAAS8N,IAAT,EAAe;MAClC,IAAIA,IAAI,CAAC,CAAD,CAAR,EAAa;QACX;MACD;;MACDhL,YAAY,CAACC,EAAD,EAAK+K,IAAI,CAAC,CAAD,CAAT,EAAcA,IAAI,CAAC,CAAD,CAAlB,EAAuB,EAAvB,CAAZ;IACD,CALD,EAzTuE,CAgUvE;IACA;;IACAvL,MAAM,CAACa,UAAP,CAAkB,YAAW;MAC3B,IAAI,EAAEL,EAAE,IAAIA,EAAE,CAAC+B,YAAX,CAAJ,EAA8B;QAC5B;MACD;;MACD/B,EAAE,CAAC+B,YAAH,CAAgB9E,OAAhB,CAAwB,UAASlE,WAAT,EAAsB;QAC5C,IAAIA,WAAW,CAACuF,YAAZ,IACAvF,WAAW,CAACuF,YAAZ,CAAyBsH,KAAzB,KAAmC,KADnC,IAEA7M,WAAW,CAACuF,YAAZ,CAAyBG,mBAAzB,GAA+CjD,MAA/C,GAAwD,CAF5D,EAE+D;UAC7DL,OAAO,CAACC,IAAR,CAAa,sDACT,mCADJ;UAEArC,WAAW,CAACuF,YAAZ,CAAyBW,kBAAzB,CAA4C,EAA5C;QACD;MACF,CARD;IASD,CAbD,EAaG,IAbH;IAeA,OAAO+I,OAAO,CAACkB,OAAR,EAAP;EACD,CAlVD;;EAoVA3I,iBAAiB,CAAC+B,SAAlB,CAA4B0I,KAA5B,GAAoC,YAAW;IAC7C,KAAKjJ,YAAL,CAAkB9E,OAAlB,CAA0B,UAASlE,WAAT,EAAsB;MAC9C;AACN;AACA;AACA;AACA;MACM,IAAIA,WAAW,CAACuF,YAAhB,EAA8B;QAC5BvF,WAAW,CAACuF,YAAZ,CAAyBqG,IAAzB;MACD;;MACD,IAAI5L,WAAW,CAACY,aAAhB,EAA+B;QAC7BZ,WAAW,CAACY,aAAZ,CAA0BgL,IAA1B;MACD;;MACD,IAAI5L,WAAW,CAACc,SAAhB,EAA2B;QACzBd,WAAW,CAACc,SAAZ,CAAsB8K,IAAtB;MACD;;MACD,IAAI5L,WAAW,CAACe,WAAhB,EAA6B;QAC3Bf,WAAW,CAACe,WAAZ,CAAwB6K,IAAxB;MACD;IACF,CAlBD,EAD6C,CAoB7C;;IACA,KAAKtC,SAAL,GAAiB,IAAjB;;IACA,KAAK4G,qBAAL,CAA2B,QAA3B;EACD,CAvBD,CAp7B6C,CA68B7C;;;EACA1I,iBAAiB,CAAC+B,SAAlB,CAA4B2G,qBAA5B,GAAoD,UAASgC,QAAT,EAAmB;IACrE,KAAKjN,cAAL,GAAsBiN,QAAtB;IACA,IAAIjI,KAAK,GAAG,IAAI5C,KAAJ,CAAU,sBAAV,CAAZ;;IACA,KAAKE,cAAL,CAAoB,sBAApB,EAA4C0C,KAA5C;EACD,CAJD,CA98B6C,CAo9B7C;;;EACAzC,iBAAiB,CAAC+B,SAAlB,CAA4BwB,2BAA5B,GAA0D,YAAW;IACnE,IAAI9D,EAAE,GAAG,IAAT;;IACA,IAAI,KAAKhC,cAAL,KAAwB,QAAxB,IAAoC,KAAK+C,eAAL,KAAyB,IAAjE,EAAuE;MACrE;IACD;;IACD,KAAKA,eAAL,GAAuB,IAAvB;IACAvB,MAAM,CAACa,UAAP,CAAkB,YAAW;MAC3B,IAAIL,EAAE,CAACe,eAAP,EAAwB;QACtBf,EAAE,CAACe,eAAH,GAAqB,KAArB;QACA,IAAIiC,KAAK,GAAG,IAAI5C,KAAJ,CAAU,mBAAV,CAAZ;;QACAJ,EAAE,CAACM,cAAH,CAAkB,mBAAlB,EAAuC0C,KAAvC;MACD;IACF,CAND,EAMG,CANH;EAOD,CAbD,CAr9B6C,CAo+B7C;;;EACAzC,iBAAiB,CAAC+B,SAAlB,CAA4B0E,sBAA5B,GAAqD,YAAW;IAC9D,IAAIiE,QAAJ;IACA,IAAIC,MAAM,GAAG;MACX,OAAO,CADI;MAEXC,MAAM,EAAE,CAFG;MAGXC,UAAU,EAAE,CAHD;MAIXC,QAAQ,EAAE,CAJC;MAKXC,SAAS,EAAE,CALA;MAMXC,SAAS,EAAE,CANA;MAOXC,YAAY,EAAE,CAPH;MAQXC,MAAM,EAAE;IARG,CAAb;IAUA,KAAK1J,YAAL,CAAkB9E,OAAlB,CAA0B,UAASlE,WAAT,EAAsB;MAC9CmS,MAAM,CAACnS,WAAW,CAACuF,YAAZ,CAAyBsH,KAA1B,CAAN;MACAsF,MAAM,CAACnS,WAAW,CAACY,aAAZ,CAA0BiM,KAA3B,CAAN;IACD,CAHD,EAZ8D,CAgB9D;;IACAsF,MAAM,CAACI,SAAP,IAAoBJ,MAAM,CAACK,SAA3B;IAEAN,QAAQ,GAAG,KAAX;;IACA,IAAIC,MAAM,CAACO,MAAP,GAAgB,CAApB,EAAuB;MACrBR,QAAQ,GAAG,QAAX;IACD,CAFD,MAEO,IAAIC,MAAM,CAACE,UAAP,GAAoB,CAApB,IAAyBF,MAAM,CAACG,QAAP,GAAkB,CAA/C,EAAkD;MACvDJ,QAAQ,GAAG,YAAX;IACD,CAFM,MAEA,IAAIC,MAAM,CAACM,YAAP,GAAsB,CAA1B,EAA6B;MAClCP,QAAQ,GAAG,cAAX;IACD,CAFM,MAEA,IAAIC,MAAM,CAACQ,GAAP,GAAa,CAAjB,EAAoB;MACzBT,QAAQ,GAAG,KAAX;IACD,CAFM,MAEA,IAAIC,MAAM,CAACI,SAAP,GAAmB,CAAnB,IAAwBJ,MAAM,CAACK,SAAP,GAAmB,CAA/C,EAAkD;MACvDN,QAAQ,GAAG,WAAX;IACD;;IAED,IAAIA,QAAQ,KAAK,KAAK7J,kBAAtB,EAA0C;MACxC,KAAKA,kBAAL,GAA0B6J,QAA1B;MACA,IAAIjI,KAAK,GAAG,IAAI5C,KAAJ,CAAU,0BAAV,CAAZ;;MACA,KAAKE,cAAL,CAAoB,0BAApB,EAAgD0C,KAAhD;IACD;EACF,CArCD;;EAuCAzC,iBAAiB,CAAC+B,SAAlB,CAA4BqJ,WAA5B,GAA0C,YAAW;IACnD,IAAI3L,EAAE,GAAG,IAAT;;IAEA,IAAIA,EAAE,CAACqC,SAAP,EAAkB;MAChB,OAAO2F,OAAO,CAACC,MAAR,CAAe/I,SAAS,CAAC,mBAAD,EAC3B,sCAD2B,CAAxB,CAAP;IAED;;IAED,IAAI0M,cAAc,GAAG5L,EAAE,CAAC+B,YAAH,CAAgBhH,MAAhB,CAAuB,UAAS2J,CAAT,EAAY;MACtD,OAAOA,CAAC,CAACpL,IAAF,KAAW,OAAlB;IACD,CAFoB,EAElBkC,MAFH;IAGA,IAAIqQ,cAAc,GAAG7L,EAAE,CAAC+B,YAAH,CAAgBhH,MAAhB,CAAuB,UAAS2J,CAAT,EAAY;MACtD,OAAOA,CAAC,CAACpL,IAAF,KAAW,OAAlB;IACD,CAFoB,EAElBkC,MAFH,CAXmD,CAenD;;IACA,IAAIsQ,YAAY,GAAGC,SAAS,CAAC,CAAD,CAA5B;;IACA,IAAID,YAAJ,EAAkB;MAChB;MACA,IAAIA,YAAY,CAACE,SAAb,IAA0BF,YAAY,CAACG,QAA3C,EAAqD;QACnD,MAAM,IAAIxH,SAAJ,CACF,sDADE,CAAN;MAED;;MACD,IAAIqH,YAAY,CAACI,mBAAb,KAAqC9J,SAAzC,EAAoD;QAClD,IAAI0J,YAAY,CAACI,mBAAb,KAAqC,IAAzC,EAA+C;UAC7CN,cAAc,GAAG,CAAjB;QACD,CAFD,MAEO,IAAIE,YAAY,CAACI,mBAAb,KAAqC,KAAzC,EAAgD;UACrDN,cAAc,GAAG,CAAjB;QACD,CAFM,MAEA;UACLA,cAAc,GAAGE,YAAY,CAACI,mBAA9B;QACD;MACF;;MACD,IAAIJ,YAAY,CAACK,mBAAb,KAAqC/J,SAAzC,EAAoD;QAClD,IAAI0J,YAAY,CAACK,mBAAb,KAAqC,IAAzC,EAA+C;UAC7CN,cAAc,GAAG,CAAjB;QACD,CAFD,MAEO,IAAIC,YAAY,CAACK,mBAAb,KAAqC,KAAzC,EAAgD;UACrDN,cAAc,GAAG,CAAjB;QACD,CAFM,MAEA;UACLA,cAAc,GAAGC,YAAY,CAACK,mBAA9B;QACD;MACF;IACF;;IAEDnM,EAAE,CAAC+B,YAAH,CAAgB9E,OAAhB,CAAwB,UAASlE,WAAT,EAAsB;MAC5C,IAAIA,WAAW,CAACO,IAAZ,KAAqB,OAAzB,EAAkC;QAChCsS,cAAc;;QACd,IAAIA,cAAc,GAAG,CAArB,EAAwB;UACtB7S,WAAW,CAAC0K,WAAZ,GAA0B,KAA1B;QACD;MACF,CALD,MAKO,IAAI1K,WAAW,CAACO,IAAZ,KAAqB,OAAzB,EAAkC;QACvCuS,cAAc;;QACd,IAAIA,cAAc,GAAG,CAArB,EAAwB;UACtB9S,WAAW,CAAC0K,WAAZ,GAA0B,KAA1B;QACD;MACF;IACF,CAZD,EA3CmD,CAyDnD;;IACA,OAAOmI,cAAc,GAAG,CAAjB,IAAsBC,cAAc,GAAG,CAA9C,EAAiD;MAC/C,IAAID,cAAc,GAAG,CAArB,EAAwB;QACtB5L,EAAE,CAACqD,kBAAH,CAAsB,OAAtB;;QACAuI,cAAc;MACf;;MACD,IAAIC,cAAc,GAAG,CAArB,EAAwB;QACtB7L,EAAE,CAACqD,kBAAH,CAAsB,OAAtB;;QACAwI,cAAc;MACf;IACF;;IAED,IAAIzS,GAAG,GAAGR,QAAQ,CAACwT,uBAAT,CAAiCpM,EAAE,CAACgC,aAApC,EACNhC,EAAE,CAACkC,kBAAH,EADM,CAAV;IAEAlC,EAAE,CAAC+B,YAAH,CAAgB9E,OAAhB,CAAwB,UAASlE,WAAT,EAAsBmM,aAAtB,EAAqC;MAC3D;MACA;MACA,IAAIjL,KAAK,GAAGlB,WAAW,CAACkB,KAAxB;MACA,IAAIX,IAAI,GAAGP,WAAW,CAACO,IAAvB;MACA,IAAIM,GAAG,GAAGb,WAAW,CAACa,GAAZ,IAAmBhB,QAAQ,CAACmR,kBAAT,EAA7B;MACAhR,WAAW,CAACa,GAAZ,GAAkBA,GAAlB;;MAEA,IAAI,CAACb,WAAW,CAACS,WAAjB,EAA8B;QAC5BT,WAAW,CAACS,WAAZ,GAA0BwG,EAAE,CAACiF,kBAAH,CAAsBC,aAAtB,EACtBlF,EAAE,CAACsB,WADmB,CAA1B;MAED;;MAED,IAAI5F,iBAAiB,GAAG8D,MAAM,CAACuE,YAAP,CAAoBwG,eAApB,CAAoCjR,IAApC,CAAxB,CAb2D,CAc3D;MACA;;MACA,IAAIoB,WAAW,GAAG,KAAlB,EAAyB;QACvBgB,iBAAiB,CAACG,MAAlB,GAA2BH,iBAAiB,CAACG,MAAlB,CAAyBd,MAAzB,CACvB,UAASyP,KAAT,EAAgB;UACd,OAAOA,KAAK,CAACzN,IAAN,KAAe,KAAtB;QACD,CAHsB,CAA3B;MAID;;MACDrB,iBAAiB,CAACG,MAAlB,CAAyBoB,OAAzB,CAAiC,UAASuN,KAAT,EAAgB;QAC/C;QACA;QACA,IAAIA,KAAK,CAACzN,IAAN,KAAe,MAAf,IACAyN,KAAK,CAAC5N,UAAN,CAAiB,yBAAjB,MAAgDwF,SADpD,EAC+D;UAC7DoI,KAAK,CAAC5N,UAAN,CAAiB,yBAAjB,IAA8C,GAA9C;QACD,CAN8C,CAQ/C;QACA;;;QACA,IAAI7D,WAAW,CAAC4C,kBAAZ,IACA5C,WAAW,CAAC4C,kBAAZ,CAA+BE,MADnC,EAC2C;UACzC9C,WAAW,CAAC4C,kBAAZ,CAA+BE,MAA/B,CAAsCoB,OAAtC,CAA8C,UAASoP,WAAT,EAAsB;YAClE,IAAI7B,KAAK,CAACzN,IAAN,CAAWC,WAAX,OAA6BqP,WAAW,CAACtP,IAAZ,CAAiBC,WAAjB,EAA7B,IACAwN,KAAK,CAACtN,SAAN,KAAoBmP,WAAW,CAACnP,SADpC,EAC+C;cAC7CsN,KAAK,CAACnO,oBAAN,GAA6BgQ,WAAW,CAACjQ,WAAzC;YACD;UACF,CALD;QAMD;MACF,CAnBD;MAoBAV,iBAAiB,CAACI,gBAAlB,CAAmCmB,OAAnC,CAA2C,UAASqP,MAAT,EAAiB;QAC1D,IAAIC,gBAAgB,GAAGxT,WAAW,CAAC4C,kBAAZ,IACnB5C,WAAW,CAAC4C,kBAAZ,CAA+BG,gBADZ,IACgC,EADvD;QAEAyQ,gBAAgB,CAACtP,OAAjB,CAAyB,UAASuP,OAAT,EAAkB;UACzC,IAAIF,MAAM,CAACzO,GAAP,KAAe2O,OAAO,CAAC3O,GAA3B,EAAgC;YAC9ByO,MAAM,CAACpS,EAAP,GAAYsS,OAAO,CAACtS,EAApB;UACD;QACF,CAJD;MAKD,CARD,EA1C2D,CAoD3D;;MACA,IAAIE,sBAAsB,GAAGrB,WAAW,CAACqB,sBAAZ,IAAsC,CAAC;QAClEC,IAAI,EAAE,CAAC,IAAI6K,aAAJ,GAAoB,CAArB,IAA0B;MADkC,CAAD,CAAnE;;MAGA,IAAIjL,KAAJ,EAAW;QACT;QACA,IAAIS,WAAW,IAAI,KAAf,IAAwBpB,IAAI,KAAK,OAAjC,IACA,CAACc,sBAAsB,CAAC,CAAD,CAAtB,CAA0BE,GAD/B,EACoC;UAClCF,sBAAsB,CAAC,CAAD,CAAtB,CAA0BE,GAA1B,GAAgC;YAC9BD,IAAI,EAAED,sBAAsB,CAAC,CAAD,CAAtB,CAA0BC,IAA1B,GAAiC;UADT,CAAhC;QAGD;MACF;;MAED,IAAItB,WAAW,CAAC0K,WAAhB,EAA6B;QAC3B1K,WAAW,CAACe,WAAZ,GAA0B,IAAI0F,MAAM,CAAC8K,cAAX,CACtBvR,WAAW,CAACY,aADU,EACKL,IADL,CAA1B;MAED;;MAEDP,WAAW,CAAC2C,iBAAZ,GAAgCA,iBAAhC;MACA3C,WAAW,CAACqB,sBAAZ,GAAqCA,sBAArC;IACD,CAzED,EAvEmD,CAkJnD;;IACA,IAAI4F,EAAE,CAAC8B,OAAH,CAAWP,YAAX,KAA4B,YAAhC,EAA8C;MAC5CnI,GAAG,IAAI,oBAAoB4G,EAAE,CAAC+B,YAAH,CAAgB6C,GAAhB,CAAoB,UAASF,CAAT,EAAY;QACzD,OAAOA,CAAC,CAAC9K,GAAT;MACD,CAF0B,EAExB+M,IAFwB,CAEnB,GAFmB,CAApB,GAEQ,MAFf;IAGD;;IACDvN,GAAG,IAAI,2BAAP;IAEA4G,EAAE,CAAC+B,YAAH,CAAgB9E,OAAhB,CAAwB,UAASlE,WAAT,EAAsBmM,aAAtB,EAAqC;MAC3D9L,GAAG,IAAIN,iBAAiB,CAACC,WAAD,EAAcA,WAAW,CAAC2C,iBAA1B,EACpB,OADoB,EACX3C,WAAW,CAACG,MADD,EACS8G,EAAE,CAACmC,SADZ,CAAxB;MAEA/I,GAAG,IAAI,kBAAP;;MAEA,IAAIL,WAAW,CAACS,WAAZ,IAA2BwG,EAAE,CAACqB,iBAAH,KAAyB,KAApD,KACC6D,aAAa,KAAK,CAAlB,IAAuB,CAAClF,EAAE,CAACsB,WAD5B,CAAJ,EAC8C;QAC5CvI,WAAW,CAACS,WAAZ,CAAwBiT,kBAAxB,GAA6CxP,OAA7C,CAAqD,UAASiJ,IAAT,EAAe;UAClEA,IAAI,CAACC,SAAL,GAAiB,CAAjB;UACA/M,GAAG,IAAI,OAAOR,QAAQ,CAACyN,cAAT,CAAwBH,IAAxB,CAAP,GAAuC,MAA9C;QACD,CAHD;;QAKA,IAAInN,WAAW,CAACS,WAAZ,CAAwBoM,KAAxB,KAAkC,WAAtC,EAAmD;UACjDxM,GAAG,IAAI,yBAAP;QACD;MACF;IACF,CAhBD;IAkBA,IAAIsT,IAAI,GAAG,IAAIlN,MAAM,CAACmN,qBAAX,CAAiC;MAC1C1T,IAAI,EAAE,OADoC;MAE1CG,GAAG,EAAEA;IAFqC,CAAjC,CAAX;IAIA,OAAO4O,OAAO,CAACkB,OAAR,CAAgBwD,IAAhB,CAAP;EACD,CAjLD;;EAmLAnM,iBAAiB,CAAC+B,SAAlB,CAA4BsK,YAA5B,GAA2C,YAAW;IACpD,IAAI5M,EAAE,GAAG,IAAT;;IAEA,IAAIA,EAAE,CAACqC,SAAP,EAAkB;MAChB,OAAO2F,OAAO,CAACC,MAAR,CAAe/I,SAAS,CAAC,mBAAD,EAC3B,uCAD2B,CAAxB,CAAP;IAED;;IAED,IAAI9F,GAAG,GAAGR,QAAQ,CAACwT,uBAAT,CAAiCpM,EAAE,CAACgC,aAApC,EACNhC,EAAE,CAACkC,kBAAH,EADM,CAAV;;IAEA,IAAIlC,EAAE,CAACsB,WAAP,EAAoB;MAClBlI,GAAG,IAAI,oBAAoB4G,EAAE,CAAC+B,YAAH,CAAgB6C,GAAhB,CAAoB,UAASF,CAAT,EAAY;QACzD,OAAOA,CAAC,CAAC9K,GAAT;MACD,CAF0B,EAExB+M,IAFwB,CAEnB,GAFmB,CAApB,GAEQ,MAFf;IAGD;;IACD,IAAIkG,oBAAoB,GAAGjU,QAAQ,CAAC6N,gBAAT,CACvBzG,EAAE,CAACmB,iBAAH,CAAqB/H,GADE,EACGoC,MAD9B;IAEAwE,EAAE,CAAC+B,YAAH,CAAgB9E,OAAhB,CAAwB,UAASlE,WAAT,EAAsBmM,aAAtB,EAAqC;MAC3D,IAAIA,aAAa,GAAG,CAAhB,GAAoB2H,oBAAxB,EAA8C;QAC5C;MACD;;MACD,IAAI9T,WAAW,CAAC2P,aAAhB,EAA+B;QAC7BtP,GAAG,IAAI,uCACH,sBADG,GAEH,QAFG,GAEQL,WAAW,CAACa,GAFpB,GAE0B,MAFjC;QAGA;MACD,CAT0D,CAW3D;;;MACA,IAAIb,WAAW,CAACG,MAAhB,EAAwB;QACtB,IAAI4T,UAAJ;;QACA,IAAI/T,WAAW,CAACO,IAAZ,KAAqB,OAAzB,EAAkC;UAChCwT,UAAU,GAAG/T,WAAW,CAACG,MAAZ,CAAmB6T,cAAnB,GAAoC,CAApC,CAAb;QACD,CAFD,MAEO,IAAIhU,WAAW,CAACO,IAAZ,KAAqB,OAAzB,EAAkC;UACvCwT,UAAU,GAAG/T,WAAW,CAACG,MAAZ,CAAmB8T,cAAnB,GAAoC,CAApC,CAAb;QACD;;QACD,IAAIF,UAAJ,EAAgB;UACd;UACA,IAAIpS,WAAW,IAAI,KAAf,IAAwB3B,WAAW,CAACO,IAAZ,KAAqB,OAA7C,IACA,CAACP,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCE,GAD3C,EACgD;YAC9CvB,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCE,GAAtC,GAA4C;cAC1CD,IAAI,EAAEtB,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCC,IAAtC,GAA6C;YADT,CAA5C;UAGD;QACF;MACF,CA5B0D,CA8B3D;;;MACA,IAAIuB,kBAAkB,GAAGH,qBAAqB,CAC1C1C,WAAW,CAAC2C,iBAD8B,EAE1C3C,WAAW,CAAC4C,kBAF8B,CAA9C;MAIA,IAAIsR,MAAM,GAAGrR,kBAAkB,CAACC,MAAnB,CAA0Bd,MAA1B,CAAiC,UAASmS,CAAT,EAAY;QACxD,OAAOA,CAAC,CAACnQ,IAAF,CAAOC,WAAP,OAAyB,KAAhC;MACD,CAFY,EAEVxB,MAFH;;MAGA,IAAI,CAACyR,MAAD,IAAWlU,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCE,GAArD,EAA0D;QACxD,OAAOvB,WAAW,CAACqB,sBAAZ,CAAmC,CAAnC,EAAsCE,GAA7C;MACD;;MAEDlB,GAAG,IAAIN,iBAAiB,CAACC,WAAD,EAAc6C,kBAAd,EACpB,QADoB,EACV7C,WAAW,CAACG,MADF,EACU8G,EAAE,CAACmC,SADb,CAAxB;;MAEA,IAAIpJ,WAAW,CAAC8O,cAAZ,IACA9O,WAAW,CAAC8O,cAAZ,CAA2BsF,WAD/B,EAC4C;QAC1C/T,GAAG,IAAI,kBAAP;MACD;IACF,CAhDD;IAkDA,IAAIsT,IAAI,GAAG,IAAIlN,MAAM,CAACmN,qBAAX,CAAiC;MAC1C1T,IAAI,EAAE,QADoC;MAE1CG,GAAG,EAAEA;IAFqC,CAAjC,CAAX;IAIA,OAAO4O,OAAO,CAACkB,OAAR,CAAgBwD,IAAhB,CAAP;EACD,CAxED;;EA0EAnM,iBAAiB,CAAC+B,SAAlB,CAA4B8K,eAA5B,GAA8C,UAAS7O,SAAT,EAAoB;IAChE,IAAIyB,EAAE,GAAG,IAAT;IACA,IAAIwG,QAAJ;;IACA,IAAIjI,SAAS,IAAI,EAAEA,SAAS,CAAC2G,aAAV,KAA4B9C,SAA5B,IACf7D,SAAS,CAAC0H,MADG,CAAjB,EACuB;MACrB,OAAO+B,OAAO,CAACC,MAAR,CAAe,IAAIxD,SAAJ,CAAc,kCAAd,CAAf,CAAP;IACD,CAN+D,CAQhE;;;IACA,OAAO,IAAIuD,OAAJ,CAAY,UAASkB,OAAT,EAAkBjB,MAAlB,EAA0B;MAC3C,IAAI,CAACjI,EAAE,CAACmB,iBAAR,EAA2B;QACzB,OAAO8G,MAAM,CAAC/I,SAAS,CAAC,mBAAD,EACnB,wDADmB,CAAV,CAAb;MAED,CAHD,MAGO,IAAI,CAACX,SAAD,IAAcA,SAAS,CAACA,SAAV,KAAwB,EAA1C,EAA8C;QACnD,KAAK,IAAId,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGuC,EAAE,CAAC+B,YAAH,CAAgBvG,MAApC,EAA4CiC,CAAC,EAA7C,EAAiD;UAC/C,IAAIuC,EAAE,CAAC+B,YAAH,CAAgBtE,CAAhB,EAAmBiL,aAAvB,EAAsC;YACpC;UACD;;UACD1I,EAAE,CAAC+B,YAAH,CAAgBtE,CAAhB,EAAmBa,YAAnB,CAAgCW,kBAAhC,CAAmD,EAAnD;UACAuH,QAAQ,GAAG5N,QAAQ,CAAC6N,gBAAT,CAA0BzG,EAAE,CAACmB,iBAAH,CAAqB/H,GAA/C,CAAX;UACAoN,QAAQ,CAAC/I,CAAD,CAAR,IAAe,yBAAf;UACAuC,EAAE,CAACmB,iBAAH,CAAqB/H,GAArB,GACIR,QAAQ,CAAC8N,cAAT,CAAwB1G,EAAE,CAACmB,iBAAH,CAAqB/H,GAA7C,IACAoN,QAAQ,CAACG,IAAT,CAAc,EAAd,CAFJ;;UAGA,IAAI3G,EAAE,CAACsB,WAAP,EAAoB;YAClB;UACD;QACF;MACF,CAfM,MAeA;QACL,IAAI4D,aAAa,GAAG3G,SAAS,CAAC2G,aAA9B;;QACA,IAAI3G,SAAS,CAAC0H,MAAd,EAAsB;UACpB,KAAK,IAAI9J,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG6D,EAAE,CAAC+B,YAAH,CAAgBvG,MAApC,EAA4CW,CAAC,EAA7C,EAAiD;YAC/C,IAAI6D,EAAE,CAAC+B,YAAH,CAAgB5F,CAAhB,EAAmBvC,GAAnB,KAA2B2E,SAAS,CAAC0H,MAAzC,EAAiD;cAC/Cf,aAAa,GAAG/I,CAAhB;cACA;YACD;UACF;QACF;;QACD,IAAIpD,WAAW,GAAGiH,EAAE,CAAC+B,YAAH,CAAgBmD,aAAhB,CAAlB;;QACA,IAAInM,WAAJ,EAAiB;UACf,IAAIA,WAAW,CAAC2P,aAAhB,EAA+B;YAC7B,OAAOQ,OAAO,EAAd;UACD;;UACD,IAAIhD,IAAI,GAAGd,MAAM,CAACO,IAAP,CAAYpH,SAAS,CAACA,SAAtB,EAAiC/C,MAAjC,GAA0C,CAA1C,GACP5C,QAAQ,CAAC2N,cAAT,CAAwBhI,SAAS,CAACA,SAAlC,CADO,GACwC,EADnD,CAJe,CAMf;;UACA,IAAI2H,IAAI,CAAClH,QAAL,KAAkB,KAAlB,KAA4BkH,IAAI,CAACpH,IAAL,KAAc,CAAd,IAAmBoH,IAAI,CAACpH,IAAL,KAAc,CAA7D,CAAJ,EAAqE;YACnE,OAAOoK,OAAO,EAAd;UACD,CATc,CAUf;;;UACA,IAAIhD,IAAI,CAACC,SAAL,IAAkBD,IAAI,CAACC,SAAL,KAAmB,CAAzC,EAA4C;YAC1C,OAAO+C,OAAO,EAAd;UACD,CAbc,CAcf;UACA;;;UACA,IAAIhE,aAAa,KAAK,CAAlB,IAAwBA,aAAa,GAAG,CAAhB,IACxBnM,WAAW,CAACuF,YAAZ,KAA6B0B,EAAE,CAAC+B,YAAH,CAAgB,CAAhB,EAAmBzD,YADpD,EACmE;YACjE,IAAI,CAACD,iBAAiB,CAACtF,WAAW,CAACuF,YAAb,EAA2B4H,IAA3B,CAAtB,EAAwD;cACtD,OAAO+B,MAAM,CAAC/I,SAAS,CAAC,gBAAD,EACnB,2BADmB,CAAV,CAAb;YAED;UACF,CAtBc,CAwBf;;;UACA,IAAImO,eAAe,GAAG9O,SAAS,CAACA,SAAV,CAAoB+O,IAApB,EAAtB;;UACA,IAAID,eAAe,CAAC9R,OAAhB,CAAwB,IAAxB,MAAkC,CAAtC,EAAyC;YACvC8R,eAAe,GAAGA,eAAe,CAAChE,MAAhB,CAAuB,CAAvB,CAAlB;UACD;;UACD7C,QAAQ,GAAG5N,QAAQ,CAAC6N,gBAAT,CAA0BzG,EAAE,CAACmB,iBAAH,CAAqB/H,GAA/C,CAAX;UACAoN,QAAQ,CAACtB,aAAD,CAAR,IAA2B,QACtBgB,IAAI,CAACjN,IAAL,GAAYoU,eAAZ,GAA8B,mBADR,IAErB,MAFN;UAGArN,EAAE,CAACmB,iBAAH,CAAqB/H,GAArB,GAA2BoN,QAAQ,CAACG,IAAT,CAAc,EAAd,CAA3B;QACD,CAlCD,MAkCO;UACL,OAAOsB,MAAM,CAAC/I,SAAS,CAAC,gBAAD,EACnB,2BADmB,CAAV,CAAb;QAED;MACF;;MACDgK,OAAO;IACR,CAtEM,CAAP;EAuED,CAhFD;;EAkFA3I,iBAAiB,CAAC+B,SAAlB,CAA4BiL,QAA5B,GAAuC,YAAW;IAChD,IAAIC,QAAQ,GAAG,EAAf;IACA,KAAKzL,YAAL,CAAkB9E,OAAlB,CAA0B,UAASlE,WAAT,EAAsB;MAC9C,CAAC,WAAD,EAAc,aAAd,EAA6B,aAA7B,EAA4C,cAA5C,EACI,eADJ,EACqBkE,OADrB,CAC6B,UAAS2D,MAAT,EAAiB;QACxC,IAAI7H,WAAW,CAAC6H,MAAD,CAAf,EAAyB;UACvB4M,QAAQ,CAAClQ,IAAT,CAAcvE,WAAW,CAAC6H,MAAD,CAAX,CAAoB2M,QAApB,EAAd;QACD;MACF,CALL;IAMD,CAPD;;IAQA,IAAIE,YAAY,GAAG,UAASC,IAAT,EAAe;MAChC,OAAO;QACLC,UAAU,EAAE,aADP;QAELC,WAAW,EAAE,cAFR;QAGLC,aAAa,EAAE,gBAHV;QAILC,cAAc,EAAE,iBAJX;QAKLC,eAAe,EAAE;MALZ,EAMLL,IAAI,CAACzU,IANA,KAMSyU,IAAI,CAACzU,IANrB;IAOD,CARD;;IASA,OAAO,IAAI+O,OAAJ,CAAY,UAASkB,OAAT,EAAkB;MACnC;MACA,IAAI8E,OAAO,GAAG,IAAIC,GAAJ,EAAd;MACAjG,OAAO,CAACkG,GAAR,CAAYV,QAAZ,EAAsBW,IAAtB,CAA2B,UAASC,GAAT,EAAc;QACvCA,GAAG,CAACnR,OAAJ,CAAY,UAASoR,MAAT,EAAiB;UAC3BjJ,MAAM,CAACO,IAAP,CAAY0I,MAAZ,EAAoBpR,OAApB,CAA4B,UAAS/C,EAAT,EAAa;YACvCmU,MAAM,CAACnU,EAAD,CAAN,CAAWjB,IAAX,GAAkBwU,YAAY,CAACY,MAAM,CAACnU,EAAD,CAAP,CAA9B;YACA8T,OAAO,CAACM,GAAR,CAAYpU,EAAZ,EAAgBmU,MAAM,CAACnU,EAAD,CAAtB;UACD,CAHD;QAID,CALD;QAMAgP,OAAO,CAAC8E,OAAD,CAAP;MACD,CARD;IASD,CAZM,CAAP;EAaD,CAhCD,CA31C6C,CA63C7C;;;EACA,IAAIO,OAAO,GAAG,CAAC,aAAD,EAAgB,cAAhB,CAAd;EACAA,OAAO,CAACtR,OAAR,CAAgB,UAAS2D,MAAT,EAAiB;IAC/B,IAAI4N,YAAY,GAAGjO,iBAAiB,CAAC+B,SAAlB,CAA4B1B,MAA5B,CAAnB;;IACAL,iBAAiB,CAAC+B,SAAlB,CAA4B1B,MAA5B,IAAsC,YAAW;MAC/C,IAAI6N,IAAI,GAAG1C,SAAX;;MACA,IAAI,OAAO0C,IAAI,CAAC,CAAD,CAAX,KAAmB,UAAnB,IACA,OAAOA,IAAI,CAAC,CAAD,CAAX,KAAmB,UADvB,EACmC;QAAE;QACnC,OAAOD,YAAY,CAACE,KAAb,CAAmB,IAAnB,EAAyB,CAAC3C,SAAS,CAAC,CAAD,CAAV,CAAzB,EACNoC,IADM,CACD,UAAShP,WAAT,EAAsB;UAC1B,IAAI,OAAOsP,IAAI,CAAC,CAAD,CAAX,KAAmB,UAAvB,EAAmC;YACjCA,IAAI,CAAC,CAAD,CAAJ,CAAQC,KAAR,CAAc,IAAd,EAAoB,CAACvP,WAAD,CAApB;UACD;QACF,CALM,EAKJ,UAASwP,KAAT,EAAgB;UACjB,IAAI,OAAOF,IAAI,CAAC,CAAD,CAAX,KAAmB,UAAvB,EAAmC;YACjCA,IAAI,CAAC,CAAD,CAAJ,CAAQC,KAAR,CAAc,IAAd,EAAoB,CAACC,KAAD,CAApB;UACD;QACF,CATM,CAAP;MAUD;;MACD,OAAOH,YAAY,CAACE,KAAb,CAAmB,IAAnB,EAAyB3C,SAAzB,CAAP;IACD,CAhBD;EAiBD,CAnBD;EAqBAwC,OAAO,GAAG,CAAC,qBAAD,EAAwB,sBAAxB,EAAgD,iBAAhD,CAAV;EACAA,OAAO,CAACtR,OAAR,CAAgB,UAAS2D,MAAT,EAAiB;IAC/B,IAAI4N,YAAY,GAAGjO,iBAAiB,CAAC+B,SAAlB,CAA4B1B,MAA5B,CAAnB;;IACAL,iBAAiB,CAAC+B,SAAlB,CAA4B1B,MAA5B,IAAsC,YAAW;MAC/C,IAAI6N,IAAI,GAAG1C,SAAX;;MACA,IAAI,OAAO0C,IAAI,CAAC,CAAD,CAAX,KAAmB,UAAnB,IACA,OAAOA,IAAI,CAAC,CAAD,CAAX,KAAmB,UADvB,EACmC;QAAE;QACnC,OAAOD,YAAY,CAACE,KAAb,CAAmB,IAAnB,EAAyB3C,SAAzB,EACNoC,IADM,CACD,YAAW;UACf,IAAI,OAAOM,IAAI,CAAC,CAAD,CAAX,KAAmB,UAAvB,EAAmC;YACjCA,IAAI,CAAC,CAAD,CAAJ,CAAQC,KAAR,CAAc,IAAd;UACD;QACF,CALM,EAKJ,UAASC,KAAT,EAAgB;UACjB,IAAI,OAAOF,IAAI,CAAC,CAAD,CAAX,KAAmB,UAAvB,EAAmC;YACjCA,IAAI,CAAC,CAAD,CAAJ,CAAQC,KAAR,CAAc,IAAd,EAAoB,CAACC,KAAD,CAApB;UACD;QACF,CATM,CAAP;MAUD;;MACD,OAAOH,YAAY,CAACE,KAAb,CAAmB,IAAnB,EAAyB3C,SAAzB,CAAP;IACD,CAhBD;EAiBD,CAnBD,EAr5C6C,CA06C7C;EACA;;EACA,CAAC,UAAD,EAAa9O,OAAb,CAAqB,UAAS2D,MAAT,EAAiB;IACpC,IAAI4N,YAAY,GAAGjO,iBAAiB,CAAC+B,SAAlB,CAA4B1B,MAA5B,CAAnB;;IACAL,iBAAiB,CAAC+B,SAAlB,CAA4B1B,MAA5B,IAAsC,YAAW;MAC/C,IAAI6N,IAAI,GAAG1C,SAAX;;MACA,IAAI,OAAO0C,IAAI,CAAC,CAAD,CAAX,KAAmB,UAAvB,EAAmC;QACjC,OAAOD,YAAY,CAACE,KAAb,CAAmB,IAAnB,EAAyB3C,SAAzB,EACNoC,IADM,CACD,YAAW;UACf,IAAI,OAAOM,IAAI,CAAC,CAAD,CAAX,KAAmB,UAAvB,EAAmC;YACjCA,IAAI,CAAC,CAAD,CAAJ,CAAQC,KAAR,CAAc,IAAd;UACD;QACF,CALM,CAAP;MAMD;;MACD,OAAOF,YAAY,CAACE,KAAb,CAAmB,IAAnB,EAAyB3C,SAAzB,CAAP;IACD,CAXD;EAYD,CAdD;EAgBA,OAAOxL,iBAAP;AACD,CA77CD"},"metadata":{},"sourceType":"script"}